<!DOCTYPE html>
<!--
================================================================================
GPI FEE COMPARISON TOOL v8.5 - THE UNIVERSE'S BEST STATEMENT ANALYZER
================================================================================
MISSION: Build the BEST merchant processing statement analyzer in the universe.
- EASY TO USE: Zero learning curve, intuitive interface
- SHAREABLE: Safe to distribute, no sensitive data retained, works offline
- MULTI-USER: Export/import for team collaboration
- ACCURATE: Penny-perfect validation, zero error tolerance

PRIVACY & SECURITY:
- NO pre-loaded merchant data
- NO external API calls required (works on private networks)
- ALL data exists only in browser memory
- Safe to share - recipients start with blank tool

OFFLINE CAPABLE: Works without internet connection
================================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PRIVACY: Prevent caching of any data -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>GPI Fee Analyzer v8.5 - Legendary Edition</title>
    <style>
        :root {
            --primary: #1a5f7a;
            --primary-light: #2d8bba;
            --secondary: #57c5b6;
            --accent: #159895;
            --warning: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
            --success-dark: #16a34a;
            --purple: #8b5cf6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
        }

        /* MOBILE RESPONSIVE */
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr !important; }
            .header h1 { font-size: 1.2rem !important; }
            .savings-amount { font-size: 3rem !important; }
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .header-meta { display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.9; flex-wrap: wrap; }
        .header-badge { background: rgba(255,255,255,0.2); padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem; }

        /* GIANT SAVINGS DISPLAY */
        .savings-hero {
            background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 40px rgba(5, 150, 105, 0.3);
            position: relative;
            overflow: hidden;
        }

        .savings-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .savings-label { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 3px; opacity: 0.9; }
        .savings-amount { font-size: 4.5rem; font-weight: 800; margin: 0.5rem 0; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .savings-sublabel { font-size: 1.1rem; opacity: 0.85; }
        .savings-annual { font-size: 1.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3); }
        .savings-annual strong { font-size: 2rem; }

        .savings-confidence {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 30px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* QUICK STATS ROW */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }

        .stat-card.controllable { border-left-color: var(--success); }
        .stat-card.passthrough { border-left-color: var(--gray-500); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }

        .stat-label { font-size: 0.8rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 0.25rem; }
        .stat-value.green { color: var(--success); }
        .stat-value.red { color: var(--danger); }

        /* TABS */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-500);
            border-radius: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover { background: var(--gray-100); color: var(--gray-700); }
        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* CARDS */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* FORMS */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--gray-700); font-size: 0.9rem; }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 95, 122, 0.1);
        }

        .form-group textarea {
            min-height: 150px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
        }

        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: var(--success-dark); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-block { width: 100%; }

        /* FILE DROP ZONE */
        .drop-zone {
            border: 3px dashed var(--gray-300);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--gray-50);
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .drop-zone-icon { font-size: 4rem; margin-bottom: 1rem; }
        .drop-zone-text { font-size: 1.1rem; color: var(--gray-700); }
        .drop-zone-hint { font-size: 0.85rem; color: var(--gray-500); margin-top: 0.5rem; }

        /* PROCESSOR DETECTION */
        .processor-detected {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .processor-logo { font-size: 2rem; }
        .processor-name { font-size: 1.2rem; font-weight: 600; color: #1e40af; }
        .processor-confidence { font-size: 0.85rem; color: #3b82f6; }

        /* GRIDS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
        th { background: var(--gray-50); font-weight: 600; font-size: 0.8rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background: var(--gray-50); }

        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* FEE ROWS */
        .fee-row.controllable { background: linear-gradient(90deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid var(--success); }
        .fee-row.passthrough { background: #f9fafb; opacity: 0.8; }
        .fee-row.review { background: #fef3c7; }
        .fee-row.hidden-fee { background: #fee2e2; border-left: 4px solid var(--danger); }

        /* CATEGORY SELECT */
        .category-select {
            padding: 0.4rem 0.6rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            min-width: 130px;
        }

        .category-select:focus { border-color: var(--primary); outline: none; }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* ALERTS */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon { font-size: 1.25rem; }
        .alert-success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }

        /* HIDDEN FEE ALERT */
        .hidden-fee-alert {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid var(--danger);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .hidden-fee-alert h4 { color: var(--danger); display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
        .hidden-fee-list { margin-top: 1rem; }

        /* Collapsible Hidden Fee Accordion */
        .hidden-fee-accordion {
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .hidden-fee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .hidden-fee-header:hover { background: #fef2f2; }
        .hidden-fee-header .fee-name { font-weight: 600; color: #991b1b; display: flex; align-items: center; gap: 0.5rem; }
        .hidden-fee-header .fee-amount { font-weight: 700; color: #dc2626; }
        .hidden-fee-header .expand-icon {
            transition: transform 0.2s;
            color: var(--gray-500);
            font-size: 0.8rem;
        }
        .hidden-fee-accordion.expanded .expand-icon { transform: rotate(180deg); }
        .hidden-fee-details {
            display: none;
            padding: 0.75rem 1rem;
            background: #fef2f2;
            border-top: 1px solid #fecaca;
            font-size: 0.85rem;
        }
        .hidden-fee-accordion.expanded .hidden-fee-details { display: block; }
        .hidden-fee-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            color: #7f1d1d;
        }
        .hidden-fee-detail-row .label { color: #991b1b; }

        /* MCC Search Dropdown */
        .mcc-search-container { position: relative; }
        .mcc-search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
        }
        .mcc-search-input:focus { border-color: var(--primary); outline: none; }
        .mcc-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .mcc-dropdown.show { display: block; }
        .mcc-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }
        .mcc-option:hover { background: var(--gray-50); }
        .mcc-option .mcc-code { font-weight: 600; color: var(--primary); }
        .mcc-option .mcc-desc { color: var(--gray-600); }

        /* PROGRESS BAR */
        .progress-container { margin: 1rem 0; }
        .progress-bar { height: 12px; background: var(--gray-200); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); transition: width 0.3s; }
        .progress-text { font-size: 0.85rem; color: var(--gray-500); margin-top: 0.5rem; text-align: center; }

        /* HIDDEN UTILITY */
        .hidden { display: none !important; }

        /* PRINT STYLES */
        @media print {
            .header, .tabs, .btn, .drop-zone { display: none !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
        }

        /* PROPOSAL STYLES */
        .proposal-preview {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            max-height: 500px;
            overflow-y: auto;
        }

        /* CALL SCRIPT */
        .script-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .script-section h5 { color: var(--primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .script-text { font-size: 1rem; line-height: 1.7; }
        .script-highlight { background: #fef3c7; padding: 0.1rem 0.3rem; border-radius: 4px; font-weight: 600; }

        /* BENCHMARK COMPARISON */
        .benchmark-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }

        .benchmark-label { width: 120px; font-size: 0.85rem; color: var(--gray-600); }
        .benchmark-track { flex: 1; height: 24px; background: var(--gray-200); border-radius: 12px; position: relative; overflow: hidden; }
        .benchmark-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem; color: white; font-size: 0.75rem; font-weight: 600; }
        .benchmark-fill.good { background: var(--success); }
        .benchmark-fill.average { background: var(--warning); }
        .benchmark-fill.poor { background: var(--danger); }
        .benchmark-marker { position: absolute; top: 0; bottom: 0; width: 3px; background: var(--gray-900); }

        /* EXPORT/IMPORT */
        .share-code {
            background: var(--gray-900);
            color: #10b981;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèÜ GPI Fee Analyzer - The Universe's Best</h1>
        <div class="header-meta">
            <span class="header-badge">v8.5</span>
            <span class="header-badge" title="No data is stored or transmitted. Everything runs in your browser only.">üîí 100% Private</span>
            <span class="header-badge">üì¥ Works Offline</span>
            <span class="header-badge">ü§ù Team Shareable</span>
            <span id="sessionTimerBadge" class="header-badge hidden" style="background: #fef3c7; color: #92400e;">‚è±Ô∏è Session: <span id="sessionTimer">15:00</span></span>
            <span id="processorBadge" class="header-badge hidden">üìç Processor: <span id="headerProcessor">-</span></span>
            <button id="clearDataBtn" class="header-badge hidden" onclick="clearAllData()" style="background: #fee2e2; color: #dc2626; border: none; cursor: pointer;" title="Clear all entered data immediately">üóëÔ∏è Clear Data</button>
        </div>
    </div>

    <!-- Privacy Notice Banner (shown once per session) -->
    <div id="privacyNotice" style="background: linear-gradient(135deg, #065f46 0%, #059669 100%); color: white; padding: 0.75rem 1rem; text-align: center; font-size: 0.85rem; display: none;">
        <strong>üîí Privacy First:</strong> This tool runs 100% in your browser. No data is stored, transmitted, or logged. Your statements never leave your computer.
        <button onclick="dismissPrivacyNotice()" style="background: white; color: #065f46; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; margin-left: 1rem; cursor: pointer; font-weight: 600;">Got it!</button>
    </div>

    <div class="container">
        <!-- GIANT SAVINGS DISPLAY -->
        <div id="savingsHero" class="savings-hero hidden">
            <div class="savings-label">üí∞ Your Potential Savings</div>
            <div class="savings-amount" id="savingsAmount">$0</div>
            <div class="savings-sublabel">per month in controllable fees</div>
            <div class="savings-annual">
                Annual Savings: <strong id="savingsAnnual">$0</strong>
            </div>
            <div class="savings-confidence">
                <span>üìä Confidence:</span>
                <strong id="savingsConfidence">--</strong>
            </div>
        </div>

        <!-- QUICK STATS -->
        <div id="quickStats" class="quick-stats hidden">
            <div class="stat-card">
                <div class="stat-label">Total Volume</div>
                <div class="stat-value" id="statVolume">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Fees</div>
                <div class="stat-value" id="statFees">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Effective Rate</div>
                <div class="stat-value" id="statEffRate">0%</div>
            </div>
            <div class="stat-card controllable">
                <div class="stat-label">Controllable</div>
                <div class="stat-value green" id="statControllable">$0</div>
            </div>
            <div class="stat-card passthrough">
                <div class="stat-label">Pass-Through</div>
                <div class="stat-value" id="statPassThrough">$0</div>
            </div>
            <div class="stat-card" id="hiddenFeeStatCard">
                <div class="stat-label">Hidden Fees Found</div>
                <div class="stat-value red" id="statHiddenFees">0</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="input">üìÑ Input</button>
            <button class="tab" data-tab="quick">‚ö° Quick</button>
            <button class="tab" data-tab="analysis">üîç Analysis</button>
            <button class="tab" data-tab="compare">‚öñÔ∏è Compare</button>
            <button class="tab" data-tab="insights">üí° Insights</button>
            <button class="tab" data-tab="script">üìû Call Script</button>
            <button class="tab" data-tab="benchmark">üìä Benchmarks</button>
            <button class="tab" data-tab="share">ü§ù Share</button>
        </div>

        <!-- TAB: INPUT -->
        <div id="tab-input" class="tab-content active">
            <div class="grid-2">
                <div class="card">
                    <h3 class="card-title">üì§ Upload Statement</h3>
                    <div class="drop-zone" id="dropZone">
                        <div class="drop-zone-icon">üìÑ</div>
                        <div class="drop-zone-text">Drop PDF or Image here</div>
                        <div class="drop-zone-hint">or click to browse ‚Ä¢ Supports PDF, PNG, JPG</div>
                        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg" style="display:none">
                    </div>
                    <div id="uploadProgress" class="progress-container hidden">
                        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
                        <div class="progress-text" id="progressText">Processing...</div>
                    </div>
                    <div id="processorDetected" class="processor-detected hidden">
                        <div class="processor-logo">üè¶</div>
                        <div>
                            <div class="processor-name" id="detectedProcessorName">-</div>
                            <div class="processor-confidence" id="detectedProcessorConfidence">-</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üíº GPI Fees</h3>
                    <p style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 1rem;">Enter your proposed GPI pricing below. Volume data will come from the uploaded statement.</p>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>Merchant Name</label>
                            <input type="text" id="merchantName" placeholder="ABC Company">
                        </div>
                        <div class="form-group">
                            <label>Statement Period</label>
                            <input type="month" id="statementPeriod" placeholder="e.g., 2025-10">
                            <small style="color: var(--gray-500); font-size: 0.75rem;">Interchange rates update April & October</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>GPI Processor / Platform</label>
                        <select id="gpiProcessorSelect" onchange="updateGpiFeesForm()">
                            <option value="">-- Select GPI Platform --</option>
                            <option value="OPENEDGE">OpenEdge</option>
                            <option value="CAYAN">Cayan</option>
                            <option value="PGS">PGS</option>
                            <option value="TSYS">TSYS</option>
                        </select>
                    </div>

                    <!-- Base GPI Fees (shown for all processors) -->
                    <div id="gpiFeesContainer" class="hidden">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin: 1.25rem 0 0.75rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">üìä Proposed GPI Pricing</h4>

                        <div class="grid-2">
                            <div class="form-group">
                                <label>Discount Rate (%)</label>
                                <input type="number" id="gpiDiscRate" placeholder="0.25" step="0.001" min="0">
                                <small style="color: var(--gray-500); font-size: 0.7rem;">e.g., 0.25 = 25 basis points</small>
                            </div>
                            <div class="form-group">
                                <label>Per Transaction Fee ($)</label>
                                <input type="number" id="gpiTranRate" placeholder="0.10" step="0.001" min="0">
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label>Auth Fee ($)</label>
                                <input type="number" id="gpiAuthRate" placeholder="0.00" step="0.001" min="0">
                            </div>
                            <div class="form-group">
                                <label>Batch Fee ($)</label>
                                <input type="number" id="gpiBatchRate" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label>Total Monthly Fees ($)</label>
                                <input type="number" id="gpiMonthlyFees" placeholder="25.00" step="0.01" min="0">
                                <small style="color: var(--gray-500); font-size: 0.7rem;">Statement fee, gateway, etc.</small>
                            </div>
                            <div class="form-group">
                                <label>PCI Fee ($)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="gpiPciFee" placeholder="99.00" step="0.01" min="0" style="flex: 1;">
                                    <select id="gpiPciFrequency" style="width: 100px;">
                                        <option value="annual">Annual</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- OpenEdge-specific fees -->
                        <div id="openedgeFeesSection" class="hidden">
                            <h4 style="font-size: 0.9rem; color: var(--purple); margin: 1.25rem 0 0.75rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">üî∑ OpenEdge-Specific Fees</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Settlement Funding Fee (%)</label>
                                    <input type="number" id="gpiSettlementFundingFee" placeholder="0.00" step="0.001" min="0">
                                    <small style="color: var(--gray-500); font-size: 0.7rem;">% of sales volume</small>
                                </div>
                                <div class="form-group">
                                    <label>Risk Funding Fee (%)</label>
                                    <input type="number" id="gpiRiskFundingFee" placeholder="0.00" step="0.001" min="0">
                                    <small style="color: var(--gray-500); font-size: 0.7rem;">% of sales volume</small>
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Settlement PI Rate ($)</label>
                                    <input type="number" id="gpiSettlementPiRate" placeholder="0.00" step="0.001" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Risk PI Rate ($)</label>
                                    <input type="number" id="gpiRiskPiRate" placeholder="0.00" step="0.001" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Cayan-specific fees -->
                        <div id="cayanFeesSection" class="hidden">
                            <h4 style="font-size: 0.9rem; color: var(--accent); margin: 1.25rem 0 0.75rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">üî∂ Cayan-Specific Fees</h4>
                            <div class="form-group">
                                <label>Monthly SaaS Fee (per terminal)</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="number" id="gpiSaasQty" placeholder="1" min="1" step="1" style="width: 70px;" onchange="calculateSaasTotal()">
                                    <span style="color: var(--gray-500);">√ó</span>
                                    <input type="number" id="gpiSaasUnitPrice" placeholder="15.00" step="0.01" min="0" style="flex: 1;" onchange="calculateSaasTotal()">
                                    <span style="color: var(--gray-500);">=</span>
                                    <span id="gpiSaasTotal" style="font-weight: 600; color: var(--primary); min-width: 70px;">$0.00</span>
                                </div>
                                <small style="color: var(--gray-500); font-size: 0.7rem;">Qty √ó Unit Price = Monthly SaaS Total (separate from Total Monthly Fees)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Statement Summary - auto-filled from upload OR enter manually -->
                    <h4 style="font-size: 0.95rem; color: var(--primary); margin: 1.25rem 0 0.75rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">üìà Statement Summary</h4>
                    <p style="color: var(--gray-500); font-size: 0.8rem; margin-bottom: 0.75rem;">Auto-filled from uploaded statement. Edit if needed:</p>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Total Volume ($)</label>
                            <input type="number" id="totalVolume" placeholder="e.g., 120700" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Total Fees ($)</label>
                            <input type="number" id="totalFees" placeholder="e.g., 2850" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Total Transactions</label>
                            <input type="number" id="totalTransactions" placeholder="e.g., 1500" step="1" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìù Paste Fee Details</h3>
                <div class="alert alert-info">
                    <span class="alert-icon">üí°</span>
                    <div>Paste the fee breakdown from your statement. Include fee names and amounts. Our AI will auto-categorize them!</div>
                </div>
                <div class="form-group">
                    <textarea id="feeText" placeholder="Example:
VISA CREDIT INTERCHANGE    $1,234.56
VISA ASSESSMENT             $89.12
PROCESSOR MARKUP 15BPS      $150.00
AUTHORIZATION FEE           $75.00
MONTHLY SERVICE FEE         $25.00
PCI COMPLIANCE              $19.95
..."></textarea>
                </div>
                <button class="btn btn-primary btn-lg btn-block" onclick="analyzeStatement()">
                    üöÄ Analyze Statement
                </button>
            </div>
        </div>

        <!-- TAB: QUICK ENTRY (Power User Mode) -->
        <div id="tab-quick" class="tab-content">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <h3 class="card-title">‚ö° Quick Analysis Mode</h3>
                <p style="color: var(--gray-500); margin-bottom: 1.5rem;">
                    For experienced users - get a savings estimate in 30 seconds with just 4 numbers.
                </p>

                <div class="form-group">
                    <label>Merchant Name</label>
                    <input type="text" id="quickMerchantName" placeholder="ABC Company">
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Monthly Volume ($) *</label>
                        <input type="number" id="quickVolume" placeholder="100000" required>
                    </div>
                    <div class="form-group">
                        <label>Monthly Transactions *</label>
                        <input type="number" id="quickTransactions" placeholder="1500" required>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Total Fees ($) *</label>
                        <input type="number" id="quickFees" placeholder="2500" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Current Effective Rate</label>
                        <input type="text" id="quickEffectiveRate" placeholder="Auto-calculated" readonly style="background: var(--gray-100);">
                    </div>
                </div>

                <div class="form-group">
                    <label>Industry (for benchmarking)</label>
                    <select id="quickIndustry">
                        <option value="retail">Retail (Card Present)</option>
                        <option value="restaurant">Restaurant</option>
                        <option value="ecommerce">E-Commerce</option>
                        <option value="b2b">B2B / Large Ticket</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="professional">Professional Services</option>
                    </select>
                </div>

                <button class="btn btn-primary btn-lg btn-block" onclick="quickAnalyze()" style="margin-top: 1rem;">
                    ‚ö° Quick Estimate
                </button>

                <div id="quickResults" class="hidden" style="margin-top: 2rem;">
                    <div style="background: linear-gradient(135deg, #065f46 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9;">Estimated Monthly Savings</div>
                        <div id="quickSavingsAmount" style="font-size: 3rem; font-weight: 800; margin: 0.5rem 0;">$0</div>
                        <div id="quickSavingsAnnual" style="font-size: 1.1rem; opacity: 0.9;">$0/year potential</div>
                    </div>

                    <div class="grid-2" style="gap: 1rem;">
                        <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: var(--gray-500); font-size: 0.8rem;">Current Rate</div>
                            <div id="quickCurrentRate" style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">0.00%</div>
                        </div>
                        <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: var(--gray-500); font-size: 0.8rem;">Industry Benchmark</div>
                            <div id="quickBenchmarkRate" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">0.00%</div>
                        </div>
                    </div>

                    <div id="quickBreakdown" style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--gray-700);">üìä Estimated Breakdown</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                            <div>Pass-Through (est.): <span id="quickPassThrough" style="font-weight: 600;">$0</span></div>
                            <div>Controllable (est.): <span id="quickControllable" style="font-weight: 600; color: var(--success);">$0</span></div>
                            <div>Avg Ticket: <span id="quickAvgTicket" style="font-weight: 600;">$0</span></div>
                            <div>Cost per Txn: <span id="quickCostPerTxn" style="font-weight: 600;">$0</span></div>
                        </div>
                    </div>

                    <div class="alert alert-info" style="margin-top: 1rem;">
                        <span class="alert-icon">üí°</span>
                        <div>This is a <strong>quick estimate</strong> based on industry benchmarks. For precise savings, use the full analysis with detailed fee breakdown.</div>
                    </div>

                    <button class="btn btn-secondary btn-block" onclick="convertToFullAnalysis()" style="margin-top: 1rem;">
                        üìÑ Convert to Full Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: ANALYSIS -->
        <div id="tab-analysis" class="tab-content">
            <div id="hiddenFeeAlert" class="hidden-fee-alert hidden">
                <h4>üö® Hidden Fees Detected! <span id="hiddenFeeCount" style="background: #dc2626; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem; margin-left: 0.5rem;">0</span></h4>
                <p style="font-size: 0.9rem; margin-bottom: 0.75rem;">Click each fee to view details:</p>
                <div class="hidden-fee-list" id="hiddenFeeList"></div>
            </div>

            <!-- NEW: Fee Bucket Summary -->
            <div class="card" id="feeBucketSummary" style="margin-bottom: 1.5rem;">
                <h3 class="card-title" style="margin-bottom: 1rem;">üí∞ Fee Category Breakdown</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #1e40af; text-transform: uppercase; font-weight: 600;">Disc Rate</div>
                        <div id="bucketDiscRate" style="font-size: 1.25rem; font-weight: 700; color: #1e3a8a;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #166534; text-transform: uppercase; font-weight: 600;">Per Trans</div>
                        <div id="bucketPerTrans" style="font-size: 1.25rem; font-weight: 700; color: #14532d;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #92400e; text-transform: uppercase; font-weight: 600;">Per Auth</div>
                        <div id="bucketPerAuth" style="font-size: 1.25rem; font-weight: 700; color: #78350f;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #9d174d; text-transform: uppercase; font-weight: 600;">Batch Fee</div>
                        <div id="bucketBatchFee" style="font-size: 1.25rem; font-weight: 700; color: #831843;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #6b21a8; text-transform: uppercase; font-weight: 600;">Monthly Fee</div>
                        <div id="bucketMonthlyFee" style="font-size: 1.25rem; font-weight: 700; color: #581c87;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #991b1b; text-transform: uppercase; font-weight: 600;">Other Fees</div>
                        <div id="bucketOtherFee" style="font-size: 1.25rem; font-weight: 700; color: #7f1d1d;">$0.00</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 1rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #374151; text-transform: uppercase; font-weight: 600;">Pass-Through</div>
                        <div id="bucketPassThrough" style="font-size: 1.25rem; font-weight: 700; color: #111827;">$0.00</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #d1d5db; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div><strong>Total Controllable:</strong> <span id="bucketTotalControllable" style="color: #16a34a; font-weight: 700;">$0.00</span> <span style="font-size: 0.8rem; color: #6b7280;">(Negotiable - your savings opportunities)</span></div>
                    <div><strong>Total Pass-Through:</strong> <span id="bucketTotalPassThrough" style="color: #6b7280; font-weight: 700;">$0.00</span> <span style="font-size: 0.8rem; color: #6b7280;">(Fixed - same for all processors)</span></div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h3 class="card-title" style="margin: 0;">üìä Fee Breakdown</h3>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="exportPDF()">üìÑ Export PDF</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">üìä Export CSV</button>
                    </div>
                </div>
                <div style="margin: 1rem 0;" class="alert alert-success">
                    <span class="alert-icon">‚ú®</span>
                    <div><strong>Green rows = CONTROLLABLE</strong> - These are your savings opportunities!</div>
                </div>
                <table id="feeTable">
                    <thead>
                        <tr>
                            <th>Fee Name</th>
                            <th>Type</th>
                            <th class="text-right">Amount</th>
                            <th class="text-center">Category</th>
                            <th class="text-center">Benchmark</th>
                        </tr>
                    </thead>
                    <tbody id="feeTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB: COMPARE - Clean Side-by-Side Comparison -->
        <div id="tab-compare" class="tab-content">
            <div class="card">
                <h3 class="card-title">‚öñÔ∏è Fee Comparison</h3>

                <div id="compareNotReady" class="alert alert-warning">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div>Analyze a statement first to see the comparison. Go to the <strong>Input</strong> or <strong>Quick</strong> tab to start.</div>
                </div>

                <div id="compareContent" class="hidden">
                    <!-- GPI Pricing Input - Compact -->
                    <div style="background: linear-gradient(135deg, #065f46 0%, #059669 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; color: white;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <span style="font-weight: 600;">üè∑Ô∏è GPI Pricing:</span>
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                                    Markup: <input type="number" id="gpiMarkupBps" value="10" step="1" style="width: 60px; padding: 0.25rem; border-radius: 4px; border: none; text-align: center;" onchange="updateComparison()"> BPS
                                </label>
                                <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                                    Per-Txn: $<input type="number" id="gpiPerTxn" value="0.10" step="0.01" style="width: 60px; padding: 0.25rem; border-radius: 4px; border: none; text-align: center;" onchange="updateComparison()">
                                </label>
                                <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                                    Monthly: $<input type="number" id="gpiMonthlyFee" value="0" step="1" style="width: 60px; padding: 0.25rem; border-radius: 4px; border: none; text-align: center;" onchange="updateComparison()">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Summary - Clean 3-Card Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: #fef2f2; border: 2px solid #fecaca; padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #991b1b;">Current Processor</div>
                            <div id="compareCurrentTotal" style="font-size: 1.75rem; font-weight: 700; color: #dc2626;">$0</div>
                            <div id="compareCurrentRate" style="font-size: 0.8rem; color: #991b1b;">0.00% effective</div>
                        </div>
                        <div style="background: #f0fdf4; border: 2px solid #bbf7d0; padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #166534;">GPI Proposed</div>
                            <div id="compareGpiTotal" style="font-size: 1.75rem; font-weight: 700; color: #16a34a;">$0</div>
                            <div id="compareGpiRate" style="font-size: 0.8rem; color: #166534;">0.00% effective</div>
                        </div>
                        <div style="background: #faf5ff; border: 2px solid #e9d5ff; padding: 1.25rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #6b21a8;">Your Savings</div>
                            <div id="compareSavingsTotal" style="font-size: 1.75rem; font-weight: 700; color: #7c3aed;">$0</div>
                            <div id="compareSavingsAnnual" style="font-size: 0.8rem; color: #6b21a8;">$0/year</div>
                        </div>
                    </div>

                    <!-- CLEAN 5-SECTION FEE COMPARISON TABLE -->
                    <div id="compareTableContainer" style="border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
                        <!-- Table Header -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; background: var(--gray-100); padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; border-bottom: 2px solid var(--gray-300);">
                            <div>Fee Category</div>
                            <div style="text-align: right; color: #dc2626;">Current</div>
                            <div style="text-align: right; color: #16a34a;">GPI</div>
                            <div style="text-align: right;">Savings</div>
                        </div>

                        <!-- Section 1: Discount Fees -->
                        <div class="compare-section" style="border-bottom: 1px solid var(--gray-200);">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 0.75rem 1rem; background: #fef9c3;">
                                <div style="font-weight: 600;">üí∞ Discount Fees (% Based)</div>
                                <div id="discFeeCurrent" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="discFeeGpi" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="discFeeSavings" style="text-align: right; font-weight: 600; color: #16a34a;">$0.00</div>
                            </div>
                        </div>

                        <!-- Section 2: Per Item Fees -->
                        <div class="compare-section" style="border-bottom: 1px solid var(--gray-200);">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 0.75rem 1rem; background: #dbeafe;">
                                <div style="font-weight: 600;">üî¢ Per Item Fees</div>
                                <div id="perItemCurrent" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="perItemGpi" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="perItemSavings" style="text-align: right; font-weight: 600; color: #16a34a;">$0.00</div>
                            </div>
                        </div>

                        <!-- Section 3: Monthly Fees -->
                        <div class="compare-section" style="border-bottom: 1px solid var(--gray-200);">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 0.75rem 1rem; background: #fce7f3;">
                                <div style="font-weight: 600;">üìÖ Monthly Fees</div>
                                <div id="monthlyCurrent" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="monthlyGpi" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="monthlySavings" style="text-align: right; font-weight: 600; color: #16a34a;">$0.00</div>
                            </div>
                        </div>

                        <!-- Section 4: Other Fees (with expandable detail) -->
                        <div class="compare-section" style="border-bottom: 1px solid var(--gray-200);">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 0.75rem 1rem; background: #fed7aa; cursor: pointer;" onclick="toggleOtherFeesDetail()">
                                <div style="font-weight: 600;">‚ö†Ô∏è Other Fees <span style="font-size: 0.75rem; color: #9a3412;">(click to expand)</span></div>
                                <div id="otherCurrent" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="otherGpi" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="otherSavings" style="text-align: right; font-weight: 600; color: #16a34a;">$0.00</div>
                            </div>
                            <div id="otherFeesDetail" style="display: none; padding: 0.5rem 1rem; background: #fff7ed; font-size: 0.85rem;">
                                <div style="color: #9a3412; margin-bottom: 0.5rem; font-size: 0.75rem;">Hidden fees, chargebacks, retrievals, one-time purchases (click ‚ùå to exclude)</div>
                                <div id="otherFeesItemList">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Pass Thru (with expandable detail - internal only) -->
                        <div class="compare-section" style="border-bottom: 1px solid var(--gray-200);">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 0.75rem 1rem; background: #e0e7ff; cursor: pointer;" onclick="togglePassThruDetail()">
                                <div style="font-weight: 600;">üîí Pass Thru (Non-Controllable) <span style="font-size: 0.75rem; color: #4338ca;">(click for detail)</span></div>
                                <div id="passThruCurrent" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div id="passThruGpi" style="text-align: right; font-weight: 600;">$0.00</div>
                                <div style="text-align: right; font-weight: 600; color: #6b7280;">‚Äî</div>
                            </div>
                            <div id="passThruDetail" style="display: none; padding: 0.5rem 1rem; background: #eef2ff; font-size: 0.85rem;">
                                <div style="color: #4338ca; margin-bottom: 0.5rem; font-size: 0.75rem;">Interchange, Dues & Assessments (detail for internal use only - not shown to merchant)</div>
                                <div id="passThruItemList">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- TOTAL Row -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 1rem; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; font-weight: 700;">
                            <div style="font-size: 1.1rem;">TOTAL</div>
                            <div id="compareTotalCurrent" style="text-align: right; font-size: 1.1rem;">$0.00</div>
                            <div id="compareTotalGpi" style="text-align: right; font-size: 1.1rem; color: #4ade80;">$0.00</div>
                            <div id="compareTotalSavings" style="text-align: right; font-size: 1.1rem; color: #a78bfa;">$0.00</div>
                        </div>
                    </div>

                    <!-- Visual Bar Comparison - Simplified -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <span style="width: 80px; font-size: 0.85rem; font-weight: 500;">Current</span>
                            <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 28px; overflow: hidden;">
                                <div id="compareBarCurrent" style="background: linear-gradient(90deg, #dc2626, #ef4444); height: 100%; width: 100%; transition: width 0.5s;"></div>
                            </div>
                            <span id="compareBarCurrentLabel" style="width: 80px; text-align: right; font-weight: 700; color: #dc2626;">$0</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="width: 80px; font-size: 0.85rem; font-weight: 500;">GPI</span>
                            <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 28px; overflow: hidden;">
                                <div id="compareBarGpi" style="background: linear-gradient(90deg, #16a34a, #22c55e); height: 100%; width: 80%; transition: width 0.5s;"></div>
                            </div>
                            <span id="compareBarGpiLabel" style="width: 80px; text-align: right; font-weight: 700; color: #16a34a;">$0</span>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <button class="btn btn-primary btn-block" onclick="generateComparisonPDF()" style="margin-top: 1.5rem;">
                        üìÑ Download Comparison (PDF)
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: INSIGHTS - NEW! Advanced Analysis -->
        <div id="tab-insights" class="tab-content">
            <!-- NEW: Fee Anomaly Detection -->
            <div class="card">
                <h3 class="card-title">üö® Fee Anomaly Detection</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Automatic detection of fees that exceed industry benchmarks</p>
                <div id="anomalyContent">
                    <div class="alert alert-info">
                        <span class="alert-icon">üîç</span>
                        <div>Analyze a statement to automatically detect unusual or excessive fees.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üí° Actionable Insights</h3>
                <p style="color: var(--gray-500); margin-bottom: 1.5rem;">AI-powered analysis with specific recommendations to reduce costs</p>
                <div id="insightsContent">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement first to see actionable insights.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìä Effective Rate by Card Type</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Breakdown of costs by card brand</p>
                <div id="cardTypeBreakdown">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement first to see card-type breakdown.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">‚ö†Ô∏è Downgrade Detection</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Transactions that failed qualification and cost extra</p>
                <div id="downgradeContent">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement first to see downgrade analysis.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üè¶ Debit Routing Analysis</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Durbin amendment compliance and routing optimization</p>
                <div id="debitRoutingContent">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement first to see debit routing analysis.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: CALL SCRIPT -->
        <div id="tab-script" class="tab-content">
            <div class="card">
                <h3 class="card-title">üìû Customized Call Script</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Based on your analysis, here's a tailored script for your conversation:</p>
                <div id="callScriptContent">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement first to generate a customized call script.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: BENCHMARKS -->
        <div id="tab-benchmark" class="tab-content">
            <div class="card">
                <h3 class="card-title">üìä Industry Benchmarks</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Select the merchant's industry to see relevant benchmarks:</p>

                <!-- MCC Search/Dropdown -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Merchant Category Code (MCC)</label>
                    <div class="mcc-search-container">
                        <input type="text" id="mccSearchInput" class="mcc-search-input"
                            placeholder="Search by industry name or enter MCC code (e.g., 5812 or Restaurant)"
                            oninput="filterMccOptions(this.value)"
                            onfocus="showMccDropdown()"
                            autocomplete="off">
                        <div id="mccDropdown" class="mcc-dropdown"></div>
                    </div>
                    <div id="selectedMcc" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--primary); display: none;">
                        <strong>Selected:</strong> <span id="selectedMccText"></span>
                    </div>
                </div>

                <div id="benchmarkContent">
                    <div class="alert alert-warning">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>Analyze a statement and select an MCC to see benchmark comparisons.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SHARE -->
        <div id="tab-share" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <h3 class="card-title">üì§ Export Analysis</h3>
                    <p style="color: var(--gray-500); margin-bottom: 1rem;">Share this analysis with your team. No sensitive data is included in the export code.</p>
                    <button class="btn btn-primary btn-block" onclick="exportAnalysis()">Generate Share Code</button>
                    <div id="exportCode" class="share-code hidden" style="margin-top: 1rem;"></div>
                    <button id="copyExportBtn" class="btn btn-secondary btn-sm hidden" style="margin-top: 0.5rem;" onclick="copyExportCode()">üìã Copy Code</button>
                </div>

                <div class="card">
                    <h3 class="card-title">üì• Import Analysis</h3>
                    <p style="color: var(--gray-500); margin-bottom: 1rem;">Paste a share code from a team member to load their analysis.</p>
                    <div class="form-group">
                        <textarea id="importCode" placeholder="Paste share code here..." style="min-height: 100px;"></textarea>
                    </div>
                    <button class="btn btn-success btn-block" onclick="importAnalysis()">Import Analysis</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üóÇÔ∏è Local History</h3>
                <p style="color: var(--gray-500); margin-bottom: 1rem;">Your recent analyses (stored locally on this device):</p>
                <div id="historyList">
                    <div class="alert alert-info">
                        <span class="alert-icon">üí°</span>
                        <div>Analyses you complete will appear here for quick access.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // GPI FEE ANALYZER v6.0 - THE UNIVERSE'S BEST
        // ============================================================

        // Global State
        let currentState = {
            merchantName: '',
            processor: null,
            processorConfidence: 0,
            totalVolume: 0,
            totalFees: 0,
            totalTransactions: 0,
            effectiveRate: 0,
            fees: [],
            controllableTotal: 0,
            passThroughTotal: 0,
            hiddenFees: [],
            pricingModel: null,
            pricingConfidence: 0,
            analysisDate: null,
            rawText: '',
            statementPeriod: null, // Statement date for interchange rate context
            interchangeRateCycle: null, // Which rate cycle applies (Apr/Oct)
            // Comparison tab state
            compareReady: false,
            compareVolume: 0,
            compareTransactions: 0,
            compareCurrentFees: 0,
            comparePassThrough: 0,
            compareControllable: 0,
            // MCC/Benchmark state
            mccCode: null,
            mccCategory: null,
            mccName: null,
            // Card-type rate decomposition
            cardTypeBreakdown: {
                visa: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                mastercard: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                discover: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                amex: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                debit: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                other: { volume: 0, fees: 0, rate: 0, transactions: 0 }
            },
            // NEW: Downgrade detection
            downgrades: [],
            downgradeTotal: 0,
            // NEW: Actionable insights
            insights: [],
            // NEW: Debit routing analysis
            debitAnalysis: {
                regulated: 0,
                nonRegulated: 0,
                pinDebit: 0,
                signatureDebit: 0,
                potentialSavings: 0
            },
            // NEW: Fee bucket totals for accurate comparison
            feeBuckets: {
                discRate: 0,      // Percentage-based discount/markup
                perTrans: 0,      // Per-transaction fees
                perAuth: 0,       // Per-authorization fees
                batchFee: 0,      // Batch/settlement fees
                monthlyFee: 0,    // Fixed monthly fees
                otherFee: 0,      // Other controllable fees
                passThrough: 0    // Interchange + assessments (not controllable)
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeTool);

        // ============================================================
        // SESSION & PRIVACY MANAGEMENT
        // ============================================================
        let sessionTimer = null;
        let sessionSecondsRemaining = 900; // 15 minutes
        let sessionActive = false;
        const SESSION_DURATION = 900; // 15 minutes in seconds
        const WARNING_THRESHOLD = 120; // Show warning at 2 minutes remaining

        function initializeTool() {
            // Clear all state for privacy
            clearState();

            // Setup event listeners
            setupTabs();
            setupDropZone();
            loadHistory();

            // Show privacy notice on first load
            showPrivacyNotice();

            // Setup activity listeners for session timer
            setupActivityListeners();

            console.log('üèÜ GPI Fee Analyzer v8.5 LEGENDARY EDITION initialized!');
            console.log('üîí Privacy Mode: No data storage, 15-min auto-clear enabled');
        }

        function showPrivacyNotice() {
            const notice = document.getElementById('privacyNotice');
            if (notice && !sessionStorage.getItem('privacyDismissed')) {
                notice.style.display = 'block';
            }
        }

        function dismissPrivacyNotice() {
            const notice = document.getElementById('privacyNotice');
            if (notice) notice.style.display = 'none';
            sessionStorage.setItem('privacyDismissed', 'true');
        }

        // ============================================================
        // GPI FEES SECTION - Processor-specific fee forms
        // ============================================================

        function updateGpiFeesForm() {
            const processor = document.getElementById('gpiProcessorSelect').value;
            const container = document.getElementById('gpiFeesContainer');
            const openedgeSection = document.getElementById('openedgeFeesSection');
            const cayanSection = document.getElementById('cayanFeesSection');

            if (!processor) {
                container.classList.add('hidden');
                return;
            }

            // Show the base fees container
            container.classList.remove('hidden');

            // Hide all processor-specific sections first
            openedgeSection.classList.add('hidden');
            cayanSection.classList.add('hidden');

            // Show processor-specific sections
            if (processor === 'OPENEDGE') {
                openedgeSection.classList.remove('hidden');
            } else if (processor === 'CAYAN') {
                cayanSection.classList.remove('hidden');
            }
            // PGS and TSYS only show base fees (no special sections)

            console.log('GPI Processor selected:', processor);
        }

        function calculateSaasTotal() {
            const qty = parseFloat(document.getElementById('gpiSaasQty').value) || 0;
            const unitPrice = parseFloat(document.getElementById('gpiSaasUnitPrice').value) || 0;
            const total = qty * unitPrice;
            document.getElementById('gpiSaasTotal').textContent = '$' + total.toFixed(2);
        }

        function getGpiPricingData() {
            const processor = document.getElementById('gpiProcessorSelect').value;
            if (!processor) return null;

            const data = {
                processor: processor,
                discRate: parseFloat(document.getElementById('gpiDiscRate').value) || 0,
                tranRate: parseFloat(document.getElementById('gpiTranRate').value) || 0,
                authRate: parseFloat(document.getElementById('gpiAuthRate').value) || 0,
                batchRate: parseFloat(document.getElementById('gpiBatchRate').value) || 0,
                monthlyFees: parseFloat(document.getElementById('gpiMonthlyFees').value) || 0,
                pciFee: parseFloat(document.getElementById('gpiPciFee').value) || 0,
                pciFrequency: document.getElementById('gpiPciFrequency').value
            };

            // Add OpenEdge-specific fields
            if (processor === 'OPENEDGE') {
                data.settlementFundingFee = parseFloat(document.getElementById('gpiSettlementFundingFee').value) || 0;
                data.riskFundingFee = parseFloat(document.getElementById('gpiRiskFundingFee').value) || 0;
                data.settlementPiRate = parseFloat(document.getElementById('gpiSettlementPiRate').value) || 0;
                data.riskPiRate = parseFloat(document.getElementById('gpiRiskPiRate').value) || 0;
            }

            // Add Cayan-specific fields
            if (processor === 'CAYAN') {
                data.saasQty = parseFloat(document.getElementById('gpiSaasQty').value) || 0;
                data.saasUnitPrice = parseFloat(document.getElementById('gpiSaasUnitPrice').value) || 0;
                data.saasTotal = data.saasQty * data.saasUnitPrice;
            }

            return data;
        }

        function calculateGpiTotalFees(gpiPricing, volume, transactions) {
            if (!gpiPricing || !volume) return 0;

            let total = 0;

            // Discount rate (% of volume)
            total += (gpiPricing.discRate / 100) * volume;

            // Per-transaction fee
            total += gpiPricing.tranRate * transactions;

            // Auth fee (per transaction)
            total += gpiPricing.authRate * transactions;

            // Batch fee (assume 30 batches/month for daily settlement)
            total += gpiPricing.batchRate * 30;

            // Monthly fees
            total += gpiPricing.monthlyFees;

            // PCI fee (convert annual to monthly if needed)
            if (gpiPricing.pciFrequency === 'annual') {
                total += gpiPricing.pciFee / 12;
            } else {
                total += gpiPricing.pciFee;
            }

            // OpenEdge-specific fees
            if (gpiPricing.processor === 'OPENEDGE') {
                total += (gpiPricing.settlementFundingFee / 100) * volume;
                total += (gpiPricing.riskFundingFee / 100) * volume;
                total += gpiPricing.settlementPiRate * transactions;
                total += gpiPricing.riskPiRate * transactions;
            }

            // Cayan SaaS fee
            if (gpiPricing.processor === 'CAYAN') {
                total += gpiPricing.saasTotal;
            }

            return total;
        }

        function setupActivityListeners() {
            // Track user activity to reset timer
            ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetSessionTimer, { passive: true });
            });
        }

        function startSessionTimer() {
            if (sessionActive) return; // Already running
            sessionActive = true;
            sessionSecondsRemaining = SESSION_DURATION;

            // Show timer badge and clear button
            const timerBadge = document.getElementById('sessionTimerBadge');
            const clearBtn = document.getElementById('clearDataBtn');
            if (timerBadge) timerBadge.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            // Start countdown
            sessionTimer = setInterval(updateSessionTimer, 1000);
            updateTimerDisplay();
            console.log('‚è±Ô∏è Session timer started - 15 minutes until auto-clear');
        }

        function resetSessionTimer() {
            if (!sessionActive) return;
            sessionSecondsRemaining = SESSION_DURATION;
            updateTimerDisplay();
        }

        function updateSessionTimer() {
            sessionSecondsRemaining--;

            if (sessionSecondsRemaining <= 0) {
                // Time's up - clear all data
                clearAllData();
                alert('‚è±Ô∏è Session expired for your privacy.\n\nAll data has been automatically cleared after 15 minutes of inactivity.');
            } else if (sessionSecondsRemaining === WARNING_THRESHOLD) {
                // Show warning at 2 minutes
                showSessionWarning();
            }

            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('sessionTimer');
            const timerBadge = document.getElementById('sessionTimerBadge');
            if (!timerEl) return;

            const mins = Math.floor(sessionSecondsRemaining / 60);
            const secs = sessionSecondsRemaining % 60;
            timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            // Change color when low
            if (timerBadge) {
                if (sessionSecondsRemaining <= WARNING_THRESHOLD) {
                    timerBadge.style.background = '#fee2e2';
                    timerBadge.style.color = '#dc2626';
                } else {
                    timerBadge.style.background = '#fef3c7';
                    timerBadge.style.color = '#92400e';
                }
            }
        }

        function showSessionWarning() {
            // Create warning toast
            const toast = document.createElement('div');
            toast.id = 'sessionWarningToast';
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #dc2626; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; animation: pulse 1s infinite;';
            toast.innerHTML = `
                <div style="font-weight: 600;">‚ö†Ô∏è Session Expiring Soon!</div>
                <div style="font-size: 0.85rem; margin-top: 0.25rem;">Data will clear in 2 minutes. Move mouse to extend.</div>
            `;
            document.body.appendChild(toast);

            // Remove after 10 seconds
            setTimeout(() => toast.remove(), 10000);
        }

        function clearAllData() {
            // Stop timer
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            sessionActive = false;

            // Clear state
            clearState();

            // Clear all input fields
            document.querySelectorAll('input, textarea').forEach(el => {
                if (el.type !== 'button' && el.type !== 'submit') {
                    el.value = '';
                }
            });

            // Hide data-dependent UI elements
            const elementsToHide = ['savingsHero', 'quickStats', 'sessionTimerBadge', 'clearDataBtn', 'processorBadge'];
            elementsToHide.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Reset compare tab
            const compareNotReady = document.getElementById('compareNotReady');
            const compareContent = document.getElementById('compareContent');
            if (compareNotReady) compareNotReady.classList.remove('hidden');
            if (compareContent) compareContent.classList.add('hidden');

            // Clear any results display
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) resultsContainer.innerHTML = '';

            console.log('üóëÔ∏è All data cleared for privacy');
        }

        function clearState() {
            currentState = {
                merchantName: '',
                processor: null,
                processorConfidence: 0,
                totalVolume: 0,
                totalFees: 0,
                totalTransactions: 0,
                effectiveRate: 0,
                fees: [],
                controllableTotal: 0,
                passThroughTotal: 0,
                hiddenFees: [],
                pricingModel: null,
                pricingConfidence: 0,
                rawText: '',
                statementPeriod: null,
                interchangeRateCycle: null,
                // Comparison tab state
                compareReady: false,
                compareVolume: 0,
                compareTransactions: 0,
                compareCurrentFees: 0,
                comparePassThrough: 0,
                compareControllable: 0,
                // MCC/Benchmark state
                mccCode: null,
                mccCategory: null,
                mccName: null,
                cardTypeBreakdown: {
                    visa: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                    mastercard: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                    discover: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                    amex: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                    debit: { volume: 0, fees: 0, rate: 0, transactions: 0 },
                    other: { volume: 0, fees: 0, rate: 0, transactions: 0 }
                },
                downgrades: [],
                downgradeTotal: 0,
                insights: [],
                debitAnalysis: {
                    regulated: 0,
                    nonRegulated: 0,
                    pinDebit: 0,
                    signatureDebit: 0,
                    potentialSavings: 0
                },
                // Fee bucket totals
                feeBuckets: {
                    discRate: 0,
                    perTrans: 0,
                    perAuth: 0,
                    batchFee: 0,
                    monthlyFee: 0,
                    otherFee: 0,
                    passThrough: 0
                },
                analysisDate: null
            };
        }

        // ============================================================
        // TAB NAVIGATION
        // ============================================================

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        // ============================================================
        // FILE DROP ZONE
        // ============================================================

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // Null check
            if (!dropZone || !fileInput) {
                console.error('Drop zone elements not found');
                return;
            }

            // Click to browse
            dropZone.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });

            // Drag over
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('dragover');
            });

            // Drag enter
            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('dragover');
            });

            // Drag leave
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');
            });

            // Drop
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    console.log('File dropped:', files[0].name, 'Type:', files[0].type);
                    processFile(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, 'Type:', file.type);
                    processFile(file);
                }
            });

            console.log('Drop zone initialized');
        }

        // Configuration constants for file processing
        const FILE_SIZE_LIMIT_MB = 50;
        const FILE_SIZE_LIMIT_BYTES = FILE_SIZE_LIMIT_MB * 1024 * 1024;
        const OCR_PAGE_LIMIT = 20;
        const OCR_TIMEOUT_MS = 120000; // 2 minutes per page
        const PDF_LOAD_TIMEOUT_MS = 30000; // 30 seconds for PDF loading

        // Utility function to wrap operations with timeout
        function withTimeout(promise, ms, operation = 'Operation') {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(`${operation} timed out after ${ms / 1000} seconds. Try a smaller file or fewer pages.`)), ms)
                )
            ]);
        }

        async function processFile(file) {
            console.log('Processing file:', file.name, 'Type:', file.type, 'Size:', file.size);
            showProgress('Reading file...', 10);

            // Check file size limit
            if (file.size > FILE_SIZE_LIMIT_BYTES) {
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                alert(`File too large: ${fileSizeMB}MB exceeds the ${FILE_SIZE_LIMIT_MB}MB limit.\n\nTip: Try splitting the PDF or uploading individual page screenshots.`);
                hideProgress();
                return;
            }

            // Start session timer when data is first loaded
            startSessionTimer();

            try {
                let text = '';
                const fileName = file.name.toLowerCase();
                const fileType = (file.type || '').toLowerCase();

                // Detect PDF by MIME type OR file extension
                const isPDF = fileType === 'application/pdf' ||
                              fileType === 'application/x-pdf' ||
                              fileName.endsWith('.pdf');

                // Detect image by MIME type OR file extension
                const isImage = fileType.startsWith('image/') ||
                                fileName.endsWith('.png') ||
                                fileName.endsWith('.jpg') ||
                                fileName.endsWith('.jpeg') ||
                                fileName.endsWith('.gif') ||
                                fileName.endsWith('.bmp');

                console.log('File detection - isPDF:', isPDF, 'isImage:', isImage);

                if (isPDF) {
                    showProgress('Extracting PDF text...', 30);
                    text = await extractPDFText(file);
                } else if (isImage) {
                    showProgress('Running OCR on image...', 30);
                    text = await extractImageText(file);
                } else {
                    // Try as text file
                    showProgress('Reading text file...', 30);
                    text = await file.text();
                }

                if (!text || text.trim().length === 0) {
                    throw new Error('No text could be extracted from the file. The PDF may be image-based - try using an image/screenshot instead.');
                }

                showProgress('Analyzing content...', 70);
                document.getElementById('feeText').value = text;

                // Auto-detect processor
                detectProcessor(text);

                showProgress('Complete!', 100);
                setTimeout(hideProgress, 1000);

                console.log('File processed successfully, extracted', text.length, 'characters');

            } catch (error) {
                console.error('File processing error:', error);
                hideProgress();
                alert('Error processing file: ' + error.message + '\n\nTip: If this is a scanned PDF, try taking a screenshot and uploading that instead.');
            }
        }

        async function extractPDFText(file) {
            // Check if PDF.js is available
            if (typeof pdfjsLib === 'undefined') {
                // Fallback: try to load PDF.js dynamically
                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                } catch (e) {
                    throw new Error('PDF.js not available. Please paste text manually.');
                }
            }

            const arrayBuffer = await file.arrayBuffer();

            // Try to load PDF with password protection handling
            let pdf;
            try {
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                pdf = await withTimeout(loadingTask.promise, PDF_LOAD_TIMEOUT_MS, 'PDF loading');
            } catch (error) {
                // Handle password-protected PDFs
                if (error.name === 'PasswordException' ||
                    (error.message && error.message.toLowerCase().includes('password'))) {
                    throw new Error('This PDF is password-protected. Please remove the password protection or paste the text manually.');
                }
                // Handle corrupted or invalid PDFs
                if (error.name === 'InvalidPDFException' ||
                    (error.message && error.message.toLowerCase().includes('invalid'))) {
                    throw new Error('This PDF appears to be corrupted or invalid. Please try a different file or paste the text manually.');
                }
                throw error;
            }

            let fullText = '';
            let totalCharCount = 0;
            let pagesWithText = 0;

            showProgress('Extracting text from ' + pdf.numPages + ' pages...', 20);

            // First try: extract embedded text
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';

                // Track text extraction quality
                const trimmedPageText = pageText.trim();
                totalCharCount += trimmedPageText.length;
                if (trimmedPageText.length > 20) {
                    pagesWithText++;
                }

                showProgress('Reading page ' + i + '/' + pdf.numPages, 20 + (i / pdf.numPages) * 30);
            }

            // Improved scanned PDF detection:
            // - Less than 100 chars total, OR
            // - Less than 20% of pages have meaningful text (>20 chars), OR
            // - Average chars per page is very low (<30 chars)
            const avgCharsPerPage = totalCharCount / pdf.numPages;
            const pagesWithTextRatio = pagesWithText / pdf.numPages;
            const isLikelyScanned = totalCharCount < 100 ||
                                    pagesWithTextRatio < 0.2 ||
                                    avgCharsPerPage < 30;

            if (isLikelyScanned) {
                console.log('PDF appears to be scanned/image-based. Stats:', {
                    totalChars: totalCharCount,
                    avgCharsPerPage: avgCharsPerPage.toFixed(1),
                    pagesWithText: pagesWithText,
                    pagesWithTextRatio: (pagesWithTextRatio * 100).toFixed(1) + '%'
                });
                showProgress('Scanned PDF detected - Running OCR...', 40);

                // Check page count limit for OCR
                if (pdf.numPages > OCR_PAGE_LIMIT) {
                    const proceed = confirm(
                        `This scanned PDF has ${pdf.numPages} pages. OCR processing is limited to ${OCR_PAGE_LIMIT} pages to ensure reasonable processing time.\n\n` +
                        `Click OK to process the first ${OCR_PAGE_LIMIT} pages, or Cancel to abort and try a smaller file.`
                    );
                    if (!proceed) {
                        throw new Error('OCR cancelled by user. Try uploading a smaller PDF or individual page screenshots.');
                    }
                }

                // Load Tesseract if needed
                if (typeof Tesseract === 'undefined') {
                    try {
                        await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js');
                    } catch (e) {
                        throw new Error('OCR not available for scanned PDF. Please paste text manually.');
                    }
                }

                fullText = '';
                const pagesToProcess = Math.min(pdf.numPages, OCR_PAGE_LIMIT);

                // Render each page as image and OCR it
                for (let i = 1; i <= pagesToProcess; i++) {
                    showProgress('OCR processing page ' + i + '/' + pagesToProcess + '...', 40 + (i / pagesToProcess) * 50);

                    const page = await pdf.getPage(i);
                    const scale = 2.0; // Higher scale = better OCR accuracy
                    const viewport = page.getViewport({ scale: scale });

                    // Create canvas for rendering
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Render PDF page to canvas
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // Apply image preprocessing for better OCR accuracy
                    preprocessCanvasForOCR(context, canvas.width, canvas.height);

                    // Convert canvas to blob for Tesseract
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                    // Run OCR on the rendered page with timeout protection
                    try {
                        const ocrPromise = Tesseract.recognize(blob, 'eng', {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const pageProgress = 40 + ((i - 1) / pagesToProcess) * 50;
                                    const ocrProgress = (m.progress / pagesToProcess) * 50;
                                    showProgress('OCR page ' + i + ': ' + Math.round(m.progress * 100) + '%', pageProgress + ocrProgress);
                                }
                            }
                        });

                        const result = await withTimeout(ocrPromise, OCR_TIMEOUT_MS, `OCR on page ${i}`);
                        fullText += result.data.text + '\n\n';
                        console.log('OCR page ' + i + ' complete:', result.data.text.length, 'characters');
                    } catch (ocrError) {
                        console.error('OCR error on page ' + i + ':', ocrError);
                        if (ocrError.message.includes('timed out')) {
                            fullText += `[Page ${i}: OCR timed out]\n\n`;
                        } else {
                            fullText += `[Page ${i}: OCR failed]\n\n`;
                        }
                    }
                }

                if (pdf.numPages > OCR_PAGE_LIMIT) {
                    fullText += `\n[Note: Only the first ${OCR_PAGE_LIMIT} of ${pdf.numPages} pages were processed due to OCR limits]\n`;
                }

                console.log('OCR complete. Total characters:', fullText.length);
            }

            return fullText;
        }

        // Image preprocessing to improve OCR accuracy on poor quality images
        function preprocessCanvasForOCR(context, width, height) {
            try {
                const imageData = context.getImageData(0, 0, width, height);
                const data = imageData.data;

                // Convert to grayscale and apply contrast enhancement
                for (let i = 0; i < data.length; i += 4) {
                    // Convert to grayscale using luminosity method
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];

                    // Apply contrast enhancement (stretch histogram)
                    // This helps with faded or low-contrast documents
                    let enhanced = ((gray - 128) * 1.2) + 128;
                    enhanced = Math.max(0, Math.min(255, enhanced));

                    // Apply adaptive thresholding for very low contrast
                    // Values close to middle gray get pushed toward white or black
                    if (enhanced > 100 && enhanced < 200) {
                        enhanced = enhanced > 150 ? Math.min(255, enhanced + 30) : Math.max(0, enhanced - 30);
                    }

                    data[i] = enhanced;     // R
                    data[i + 1] = enhanced; // G
                    data[i + 2] = enhanced; // B
                    // Alpha channel (data[i + 3]) unchanged
                }

                context.putImageData(imageData, 0, 0);
            } catch (e) {
                // If preprocessing fails (e.g., CORS issues), continue without it
                console.warn('Image preprocessing skipped:', e.message);
            }
        }

        async function extractImageText(file) {
            // Check if Tesseract is available
            if (typeof Tesseract === 'undefined') {
                try {
                    await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js');
                } catch (e) {
                    throw new Error('OCR not available. Please paste text manually.');
                }
            }

            // Create a canvas for image preprocessing
            const img = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0);

            // Apply preprocessing for better OCR accuracy
            preprocessCanvasForOCR(context, canvas.width, canvas.height);

            // Convert preprocessed canvas to blob
            const processedBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

            // Run OCR with timeout protection
            try {
                const ocrPromise = Tesseract.recognize(processedBlob, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            showProgress('OCR: ' + Math.round(m.progress * 100) + '%', 30 + m.progress * 40);
                        }
                    }
                });

                const result = await withTimeout(ocrPromise, OCR_TIMEOUT_MS, 'Image OCR');
                return result.data.text;
            } catch (error) {
                if (error.message.includes('timed out')) {
                    throw new Error('OCR processing timed out. Try a smaller or clearer image.');
                }
                throw error;
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function showProgress(text, percent) {
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideProgress() {
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        // ============================================================
        // PROCESSOR AUTO-DETECTION
        // ============================================================

        const PROCESSOR_PATTERNS = {
            // Major processors - patterns use regex with word boundaries to avoid false positives
            'TSYS': { patterns: ['\\bTSYS\\b', '\\bCAYAN\\b', '\\bTRANSFIRST\\b', '\\bVITAL\\b'], confidence: 0.9, useRegex: true },
            'FISERV': { patterns: ['\\bFISERV\\b', 'FIRST DATA', 'FIRSTDATA', '\\bCARDNET\\b', '\\bBAMS\\b', 'BANK OF AMERICA MERCHANT', '\\bCARDCONNECT\\b', 'CARDPOINTE', 'A FIRST DATA COMPANY'], confidence: 0.9, useRegex: true },
            'WORLDPAY': { patterns: ['\\bWORLDPAY\\b', '\\bVANTIV\\b', '\\bSPREEDLY\\b', 'FIS WORLDPAY'], confidence: 0.9, useRegex: true },
            'ELAVON': { patterns: ['\\bELAVON\\b', 'US BANK MERCHANT', '\\bNOVA\\b'], confidence: 0.9, useRegex: true },
            'GLOBAL': { patterns: ['GLOBAL PAYMENTS', '\\bHEARTLAND\\b', '\\bOPENEDGE\\b', 'ACTIVE NETWORK'], confidence: 0.9, useRegex: true },
            'CHASE': { patterns: ['CHASE PAYMENTECH', '\\bPAYMENTECH\\b', 'JPMORGAN MERCHANT'], confidence: 0.9, useRegex: true },
            'SQUARE': { patterns: ['\\bSQUARE\\b', 'BLOCK INC', '\\bSQ\\s'], confidence: 0.95, useRegex: true },
            'STRIPE': { patterns: ['\\bSTRIPE\\b'], confidence: 0.95, useRegex: true },
            'PAYPAL': { patterns: ['\\bPAYPAL\\b', '\\bBRAINTREE\\b'], confidence: 0.9, useRegex: true },
            'CLOVER': { patterns: ['\\bCLOVER\\b'], confidence: 0.85, useRegex: true },
            'TOAST': { patterns: ['\\bTOAST\\b'], confidence: 0.95, useRegex: true },
            'EVO': { patterns: ['EVO PAYMENTS', 'EVO MERCHANT', '\\bPAYTRACE\\b'], confidence: 0.9, useRegex: true },
            'PAYSAFE': { patterns: ['\\bPAYSAFE\\b', '\\bNETELLER\\b', '\\bSKRILL\\b'], confidence: 0.9, useRegex: true },
            'DHARMA': { patterns: ['\\bDHARMA\\b'], confidence: 0.95, useRegex: true },
            'HELCIM': { patterns: ['\\bHELCIM\\b'], confidence: 0.95, useRegex: true },
            'STAX': { patterns: ['\\bSTAX\\b', '\\bFATTMERCHANT\\b'], confidence: 0.95, useRegex: true },
            'PAYMENT_DEPOT': { patterns: ['PAYMENT DEPOT'], confidence: 0.95, useRegex: true },
            'GPI': { patterns: ['\\bGPI\\b', 'GLOBAL PAYMENTS INTEGRATED'], confidence: 0.9, useRegex: true },

            // NEW: Additional major processors
            'WELLS_FARGO': {
                patterns: ['WELLS FARGO MERCHANT', '\\bWFMS\\b', '\\bWFMERC\\b', 'WELLS FARGO BANK.*MERCHANT'],
                indicators: ['\\bSEP\\d{3}\\b', 'WFMS STATEMENT', 'WELLS FARGO MERCHANT SERVICES'],
                confidence: 0.9,
                useRegex: true
            },
            'SHIFT4': {
                patterns: ['\\bSHIFT4\\b', 'SHIFT4 PAYMENTS', '\\bHARBORTOUCH\\b', 'LIGHTHOUSE NETWORK', '\\bFUTUREPOS\\b', 'SHIFT 4'],
                indicators: ['SHIFT4', 'HARBORTOUCH PAYMENTS'],
                confidence: 0.9,
                useRegex: true
            },
            'ADYEN': {
                patterns: ['\\bADYEN\\b', 'ADYEN N\\.?V\\.?', 'ADYEN PAYMENTS', 'ADYEN BV'],
                confidence: 0.95,
                useRegex: true
            },
            'NORTH': {
                patterns: ['NORTH PAYMENT', 'NORTH MERCHANT', 'NORTH PROCESSING', 'NCR PAYMENT', 'NCR MERCHANT', '\\bJETPAY\\b', 'NCR VOYIX', 'NCR SILVER'],
                indicators: ['NCR PAYMENT SOLUTIONS', 'NORTH AMERICAN BANCARD'],
                confidence: 0.85,
                useRegex: true
            },
            'CLEARENT': {
                patterns: ['\\bCLEARENT\\b', 'CLEARENT LLC', 'XPLOR TECHNOLOGIES', 'CLEARENT BY XPLOR'],
                confidence: 0.95,
                useRegex: true
            },
            'BLUEPAY': {
                patterns: ['\\bBLUEPAY\\b', 'BLUEPAY PROCESSING', 'CLOVER CONNECT', 'BLUE PAY'],
                confidence: 0.9,
                useRegex: true
            },
            'TRANSACT': {
                patterns: ['TRANSACT PAYMENT', 'TRANSACT MERCHANT', 'TRANSACT CAMPUS', 'TRANSACT HOLDINGS', 'TRANSACT PROCESSING'],
                confidence: 0.85,
                useRegex: true
            },
            'GRAVITY': {
                patterns: ['GRAVITY PAYMENTS', 'GRAVITY MERCHANT', '\\bGRAVITYPAY\\b'],
                confidence: 0.95,
                useRegex: true
            },
            'NMI': {
                patterns: ['\\bNMI\\b(?=.*GATEWAY|.*PAYMENT|.*MERCHANT|\\s)', 'NETWORK MERCHANTS', 'NETWORK MERCHANTS INC', '\\bUSAEPAY\\b', 'NMI GATEWAY'],
                indicators: ['NETWORK MERCHANTS LLC', 'NMI TRANSACTION'],
                confidence: 0.9,
                useRegex: true
            },
            'MONERIS': {
                patterns: ['\\bMONERIS\\b', 'MONERIS SOLUTIONS', 'MONERIS CANADA', 'MONERIS US'],
                confidence: 0.95,
                useRegex: true
            }
        };

        function detectProcessor(text) {
            const upperText = text.toUpperCase();
            let bestMatch = null;
            let bestScore = 0;

            // Helper function to test pattern (regex or simple string)
            function testPattern(pattern, text, useRegex) {
                if (useRegex) {
                    try {
                        const regex = new RegExp(pattern, 'i');
                        return regex.test(text);
                    } catch (e) {
                        // Fallback to includes if regex is invalid
                        return text.includes(pattern);
                    }
                }
                return text.includes(pattern);
            }

            // Helper function to calculate effective pattern length for scoring
            // (removes regex metacharacters from length calculation)
            function getPatternLength(pattern) {
                return pattern.replace(/\\[bsdwBSDW]|\[\^?\]?[^\]]*\]|\(.*?\)|\?|\*|\+|\{.*?\}/g, '').length;
            }

            for (const [processor, config] of Object.entries(PROCESSOR_PATTERNS)) {
                let matchFound = false;
                let longestMatchLength = 0;

                // Check main patterns
                for (const pattern of config.patterns) {
                    if (testPattern(pattern, upperText, config.useRegex)) {
                        matchFound = true;
                        const patternLen = getPatternLength(pattern);
                        if (patternLen > longestMatchLength) {
                            longestMatchLength = patternLen;
                        }
                    }
                }

                // Check processor-specific indicators for bonus confidence
                let indicatorBonus = 0;
                if (config.indicators && matchFound) {
                    for (const indicator of config.indicators) {
                        if (testPattern(indicator, upperText, true)) {
                            indicatorBonus += 0.05; // Small bonus for each matched indicator
                        }
                    }
                }

                if (matchFound) {
                    // Score based on confidence, pattern length, and indicator matches
                    const score = (config.confidence + indicatorBonus) * (longestMatchLength / 10);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = processor;
                    }
                }
            }

            if (bestMatch && bestScore > 0.5) {
                currentState.processor = bestMatch;
                currentState.processorConfidence = Math.min(bestScore, 0.99);

                document.getElementById('processorDetected').classList.remove('hidden');
                document.getElementById('detectedProcessorName').textContent = bestMatch;
                document.getElementById('detectedProcessorConfidence').textContent =
                    Math.round(currentState.processorConfidence * 100) + '% confidence';

                document.getElementById('processorBadge').classList.remove('hidden');
                document.getElementById('headerProcessor').textContent = bestMatch;
                // Note: This sets the detected CURRENT processor, not the GPI platform selection
                // The gpiProcessorSelect dropdown is for selecting which GPI platform to use
            }

            return bestMatch;
        }

        // ============================================================
        // MAIN ANALYSIS
        // ============================================================

        function analyzeStatement() {
            const feeText = document.getElementById('feeText').value;
            const merchantName = document.getElementById('merchantName').value || 'Merchant';
            const totalVolume = parseFloat(document.getElementById('totalVolume').value) || 0;
            const totalFees = parseFloat(document.getElementById('totalFees').value) || 0;
            const totalTransactions = parseInt(document.getElementById('totalTransactions').value) || 0;
            const statementPeriod = document.getElementById('statementPeriod').value || null;

            if (!feeText.trim()) {
                alert('Please paste fee details to analyze.');
                return;
            }

            // Update state
            currentState.merchantName = merchantName;
            currentState.totalVolume = totalVolume;
            currentState.totalFees = totalFees;
            currentState.totalTransactions = totalTransactions;
            currentState.analysisDate = new Date().toISOString();
            currentState.rawText = feeText; // Store for Level 2/3 detection
            currentState.statementPeriod = statementPeriod;

            // Determine which interchange rate cycle applies
            // Rates update April and October each year
            if (statementPeriod) {
                const [year, month] = statementPeriod.split('-').map(Number);
                if (month >= 4 && month <= 9) {
                    currentState.interchangeRateCycle = `April ${year}`;
                } else if (month >= 10) {
                    currentState.interchangeRateCycle = `October ${year}`;
                } else {
                    currentState.interchangeRateCycle = `October ${year - 1}`;
                }
            }

            // Detect processor if not already set
            if (!currentState.processor) {
                detectProcessor(feeText);
            }

            // Auto-extract volume and fees from statement text if not provided
            if (totalVolume === 0 || totalFees === 0) {
                const extracted = autoExtractVolumeAndFees(feeText);
                if (totalVolume === 0 && extracted.volume > 0) {
                    currentState.totalVolume = extracted.volume;
                    document.getElementById('totalVolume').value = extracted.volume;
                    console.log('Auto-extracted volume:', extracted.volume);
                }
                if (totalFees === 0 && extracted.fees > 0) {
                    currentState.totalFees = extracted.fees;
                    document.getElementById('totalFees').value = extracted.fees;
                    console.log('Auto-extracted fees:', extracted.fees);
                }
                if (extracted.transactions > 0 && currentState.totalTransactions === 0) {
                    currentState.totalTransactions = extracted.transactions;
                    document.getElementById('totalTransactions').value = extracted.transactions;
                    console.log('Auto-extracted transactions:', extracted.transactions);
                }
            }

            // Parse and categorize fees
            currentState.fees = parseFees(feeText);

            // If we still don't have totalFees, sum up parsed fees as fallback
            if (currentState.totalFees === 0 && currentState.fees.length > 0) {
                const summedFees = currentState.fees.reduce((sum, f) => sum + f.amount, 0);
                if (summedFees > 0) {
                    currentState.totalFees = summedFees;
                    document.getElementById('totalFees').value = summedFees;
                    console.log('Total fees calculated from parsed fee lines:', summedFees);
                }
            }

            // Detect pricing model
            currentState.pricingModel = detectPricingModel(feeText);

            // Calculate totals
            calculateTotals();

            // Update UI
            updateSavingsDisplay();
            updateQuickStats();
            renderFeeTable();
            detectHiddenFees();
            generateCallScript();
            generateBenchmarks();
            renderInsights(); // NEW: Render actionable insights

            // Save to history
            saveToHistory();

            // Switch to analysis tab
            document.querySelector('[data-tab="analysis"]').click();
        }

        // ============================================================
        // AUTO-EXTRACTION OF VOLUME AND FEES
        // ============================================================

        function autoExtractVolumeAndFees(text) {
            const result = { volume: 0, fees: 0, transactions: 0 };
            const upperText = text.toUpperCase();

            // ============================================================
            // ENHANCED VOLUME PATTERNS (Feb 2026 Update)
            // Added: "TOTAL SALES" without $, table formats, month comparisons
            // ============================================================
            const volumePatterns = [
                // CardConnect/First Data format: "Total Amount Submitted $6,467.66"
                /TOTAL\s+AMOUNT\s+(?:SUBMITTED|PROCESSED)[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,

                // CardConnect summary table: "Total 516 $6,467.66" (transactions then amount)
                /TOTAL\s+\d+\s+\$?([\d,]+\.?\d{2})/gi,

                // Explicit total volume/sales patterns
                /(?:TOTAL\s+)?(?:SALES|VOLUME|GROSS\s+SALES|NET\s+SALES|CARD\s+SALES|BANKCARD\s+SALES|TOTAL\s+AMOUNT)[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /(?:VISA|MC|MASTERCARD|AMEX|DISCOVER|DEBIT)[\s\w]*(?:VOLUME|SALES)[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /TOTAL\s+DEPOSIT(?:S)?[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /BATCH\s+TOTAL[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /PROCESSED\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /MONTHLY\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                // Year-over-year patterns (e.g., "Apr-22 $120,700")
                /(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[\s-]?\d{2,4}\s+\$?([\d,]+\.?\d*)/gi,

                // NEW: "TOTAL SALES" without dollar sign (common in statement summaries)
                /TOTAL\s+SALES[\s\.:=]+(\d[\d,]*\.?\d*)/gi,

                // NEW: Colon-separated patterns like "Volume: 120,700.00"
                /(?:VOLUME|SALES|AMOUNT)[\s]*:[\s]*([\d,]+\.?\d*)/gi,

                // NEW: Table-format volumes (right-aligned numbers after label)
                /(?:TOTAL|GROSS|NET)\s+(?:VOLUME|SALES|AMOUNT)\s{2,}([\d,]+\.?\d*)/gi,

                // NEW: Tab-separated format (common in PDF exports)
                /(?:TOTAL|GROSS|NET)\s+(?:VOLUME|SALES)\t+([\d,]+\.?\d*)/gi,

                // NEW: Month-over-month comparison patterns
                /(?:CURRENT|THIS)\s+(?:MONTH|PERIOD)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /(?:PREVIOUS|LAST|PRIOR)\s+(?:MONTH|PERIOD)[\s\.:=\$]*([\d,]+\.?\d*)/gi,

                // NEW: Processor-specific volume formats
                // Wells Fargo format
                /WF[\s\-]?(?:TOTAL|GROSS)\s+(?:VOLUME|SALES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                // Elavon format
                /ELAVON[\s\-]?(?:VOLUME|SALES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                // TSYS format
                /TSYS[\s\-]?(?:TOTAL|NET)\s+(?:VOLUME|SALES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,

                // NEW: Summary section patterns
                /SUMMARY[\s\S]*?(?:TOTAL|GROSS)\s+(?:VOLUME|SALES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /STATEMENT\s+SUMMARY[\s\S]*?([\d,]+\.?\d*)\s*(?:TOTAL|VOLUME|SALES)/gi,

                // NEW: Card brand totals (combine for total volume)
                /(?:V\/MC|VISA\/MC|VISA\/MASTERCARD)\s+(?:TOTAL|VOLUME)[\s\.:=\$]*([\d,]+\.?\d*)/gi,

                // NEW: Settlement/funding patterns
                /(?:SETTLEMENT|FUNDING)\s+(?:TOTAL|AMOUNT)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /NET\s+(?:SETTLEMENT|FUNDING)[\s\.:=\$]*([\d,]+\.?\d*)/gi
            ];

            // ============================================================
            // ENHANCED FEE TOTAL PATTERNS (Feb 2026 Update)
            // Added: processor-specific formats, 2025-2026 fee types
            // ============================================================
            const feePatterns = [
                // CardConnect/First Data format: "Fees -$457.19" (negative amount)
                /FEES[\s\.:=]*-?\$?([\d,]+\.?\d*)/gi,

                // TOTAL line with negative: "TOTAL -$457.19"
                /TOTAL[\s\.:=]*-\$?([\d,]+\.?\d*)/gi,

                // Total (Service Charges, Interchange Charges, and Fees) pattern
                /TOTAL\s*\([^)]+\)[\s\.:=]*-?\$?([\d,]+\.?\d*)/gi,

                /(?:TOTAL\s+)?(?:FEES|CHARGES|PROCESSING\s+FEES|DISCOUNT|TOTAL\s+DEDUCTIONS)[\s\.:=\$]*-?\$?([\d,]+\.?\d*)/gi,
                /(?:AMOUNT\s+)?(?:DEDUCTED|CHARGED)[\s\.:=\$]*-?\$?([\d,]+\.?\d*)/gi,
                /TOTAL\s+(?:DUE|OWED|AMOUNT)[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /(?:PROCESSING|SERVICE)\s+FEE(?:S)?[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,
                /NET\s+(?:FEES|CHARGES)[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi,

                // NEW: Colon-separated patterns like "Fees: 1,234.56"
                /(?:TOTAL\s+)?FEES[\s]*:[\s]*([\d,]+\.?\d*)/gi,

                // NEW: Table-format fees (right-aligned numbers)
                /(?:TOTAL|NET)\s+(?:FEES|CHARGES|DEDUCTIONS)\s{2,}([\d,]+\.?\d*)/gi,

                // NEW: Tab-separated format
                /(?:TOTAL|NET)\s+(?:FEES|CHARGES)\t+([\d,]+\.?\d*)/gi,

                // NEW: Processor-specific fee totals
                // Wells Fargo
                /WF[\s\-]?(?:TOTAL|NET)\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                // Elavon
                /ELAVON[\s\-]?(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                // TSYS
                /TSYS[\s\-]?(?:TOTAL|NET)\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                // Fiserv/First Data
                /(?:FISERV|FD|FIRSTDATA)[\s\-]?(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,

                // NEW: 2025-2026 fee type totals
                /MERCHANT\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /ACQUIRER\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /NETWORK\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi,

                // NEW: Summary section patterns
                /(?:FEES|CHARGES)\s+SUMMARY[\s\S]*?(?:TOTAL)[\s\.:=\$]*([\d,]+\.?\d*)/gi,
                /STATEMENT\s+(?:FEES|CHARGES)[\s\.:=\$]*([\d,]+\.?\d*)/gi
            ];

            // ============================================================
            // ENHANCED TRANSACTION COUNT PATTERNS (Feb 2026 - Comprehensive)
            // Patterns from analysis of 30+ processor statement formats
            // ============================================================
            const txnPatterns = [
                // CardConnect format: "Total 516 $6,467.66" - capture 516
                /TOTALS?\s+(\d+)\s+\$[\d,]+\.\d{2}/gi,

                // Heartland/Passport format: "Totals 170 $37,130.80" - capture 170
                /TOTALS?\s+(\d[\d,]*)\s+\$[\d,]+/gi,

                // Items count in table: "Items Amount" rows with "516" as items
                /(?:ITEMS?|COUNT)\s+(\d+)\s+\$[\d,]+/gi,

                /(?:TOTALS?\s+)?(?:TRANSACTIONS?|ITEMS?|COUNT|# OF TRANS|NBR\s+TRANS)[\s\.:=]+(\d[\d,]*)/gi,
                /(\d[\d,]*)\s+(?:TRANSACTIONS?|ITEMS?|SALES)/gi,
                /TRANS(?:ACTION)?\s*(?:COUNT|#|NBR)[\s\.:=]+(\d[\d,]*)/gi,

                // Colon-separated patterns like "Transactions: 1,234"
                /TRANSACTIONS?[\s]*:[\s]*(\d[\d,]*)/gi,

                // Table-format transaction counts (right-aligned numbers)
                /(?:TOTALS?|BATCH)\s+(?:TRANSACTIONS?|ITEMS?|COUNT)\s{2,}(\d[\d,]*)/gi,

                // Tab-separated format
                /(?:TOTALS?|BATCH)\s+(?:TRANSACTIONS?|ITEMS?)\t+(\d[\d,]*)/gi,

                // Card brand transaction counts
                /(?:VISA|MC|MASTERCARD|AMEX|DISCOVER)\s+(?:TRANSACTIONS?|COUNT)[\s\.:=]+(\d[\d,]*)/gi,

                // Summary section patterns
                /TRANSACTION\s+(?:SUMMARY|COUNT)[\s\.:=]+(\d[\d,]*)/gi,
                /ITEMS?\s+PROCESSED[\s\.:=]+(\d[\d,]*)/gi,

                // NEW: Processor-specific formats from comprehensive bot research
                /Grand\s+Totals\s+(\d+)\s+\$/gi, // Nationwide
                /Deposit\s+Totals?\s+(\d+)/gi, // BB&T/TSYS
                /TOTAL\s+(\d+)\s+\$[\d,]+\.\d{2}\s+\d+/gi, // First American (sales count)
                /Transaction\s+Fee\s+(\d+)/gi, // Storable
                /TOTAL\s+TRANS[\s\.:=]+(\d[\d,]*)/gi, // GPI
                /Number\s+of\s+Sales[\s\.:=]+(\d[\d,]*)/gi, // EVO
                /\*\*\s+(\d[\d,]*)\s+[\d,]+\.?\d{2}/gi, // BB&T plan summary
                /Sale\s+Items[\s\.:=]+(\d[\d,]*)/gi, // Nationwide

                // Bot Research: Additional processor-specific formats
                /TOTAL\s+CARD\s+TRANSACTIONS[\s\.:=]+(\d[\d,]*)/gi, // Toast/Clover
                /PAYMENTS\s+PROCESSED[\s\.:=]+(\d[\d,]*)/gi, // Square/Stripe
                /ORDERS?\s+COUNT[\s\.:=]+(\d[\d,]*)/gi, // Lightspeed/ShopKeep
                /BATCHES?\s+COUNT[\s\.:=]+(\d[\d,]*)/gi, // Generic batch counter
                /AUTHORIZATION\s+COUNT[\s\.:=]+(\d[\d,]*)/gi, // Auth count
                /APPROVED\s+(?:TRANS(?:ACTION)?S?|COUNT)[\s\.:=]+(\d[\d,]*)/gi, // Approved txns
                /DECLINED\s+(?:TRANS(?:ACTION)?S?|COUNT)[\s\.:=]+(\d[\d,]*)/gi, // Declined (for reference)
                /REFUND\s+(?:COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi, // Refund count
                /VOID\s+(?:COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi, // Void count
                /CHARGEBACKS?\s+COUNT[\s\.:=]+(\d[\d,]*)/gi, // Chargeback count

                // Card brand specific transaction counts
                /VISA\s+(?:TRANS(?:ACTION)?S?|COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,
                /(?:MC|MASTERCARD)\s+(?:TRANS(?:ACTION)?S?|COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,
                /AMEX\s+(?:TRANS(?:ACTION)?S?|COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,
                /DISCOVER\s+(?:TRANS(?:ACTION)?S?|COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,
                /DEBIT\s+(?:TRANS(?:ACTION)?S?|COUNT|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,

                // Processor-specific formats
                /WF[\s\-]?(?:TRANSACTION|ITEM)\s+COUNT[\s\.:=]+(\d[\d,]*)/gi,
                /TSYS[\s\-]?(?:TRANSACTIONS?|ITEMS?)[\s\.:=]+(\d[\d,]*)/gi,
                /FISERV\s+(?:TRANS(?:ACTION)?S?|COUNT)[\s\.:=]+(\d[\d,]*)/gi,
                /ELAVON\s+(?:TRANS(?:ACTION)?S?|COUNT)[\s\.:=]+(\d[\d,]*)/gi,
                /GLOBAL\s+PAYMENTS?\s+(?:TRANS(?:ACTION)?S?|COUNT)[\s\.:=]+(\d[\d,]*)/gi
            ];

            // ============================================================
            // ENHANCED VOLUME PATTERNS (Feb 2026 - Comprehensive Bot Research Update)
            // Patterns from 20-bot army analysis of 50+ processor statement formats
            // Priority: Lower number = higher priority (more specific/reliable)
            // ============================================================
            const priorityVolumePatterns = [
                // Priority 0: Most specific/reliable volume indicators
                { pattern: /TOTAL\s+AMOUNT\s+SUBMITTED[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 0 }, // CardConnect/Fiserv
                { pattern: /Amounts\s+Submitted[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Paysafe
                { pattern: /Total\s+Processing\s+Service\s+Fees\s+of[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // GPI
                { pattern: /TOTAL\s+BANKCARD\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // TSYS
                { pattern: /GROSS\s+PROCESSING\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Square/Stripe
                { pattern: /TOTAL\s+CARD\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Toast

                // Priority 1: Explicit deposit/volume totals
                { pattern: /TOTAL\s+DEPOSITS?[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 1 },
                { pattern: /Deposit\s+Totals?\s+\d+\s+\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // BB&T/TSYS
                { pattern: /Total\s+Deposits:[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Heartland
                // WorldPay deposit pattern - must have decimal format (not reference numbers)
                { pattern: /DEPOSITS\s+[\d,]{1,6}\s+([\d,]+\.\d{2})/gi, priority: 1 }, // WorldPay (txn count + amount)
                { pattern: /NET\s+DEPOSIT\s+AMOUNT[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Elavon
                { pattern: /AMOUNT\s+DEPOSITED[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Wells Fargo
                { pattern: /FUNDING\s+AMOUNT[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Chase Paymentech
                { pattern: /TOTAL\s+FUNDED[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // PNC/BAMS
                // EVO/TSYS Chain Statement - MTD Total line (first large number is volume)
                { pattern: /^Total\s+([\d,]+\.\d{2})\s+[\d,]+\.\d{2}\s+[\d,]+\.\d{2}/gim, priority: 1 }, // EVO chain summary

                // Priority 2: Sales totals by various names
                // FIXED: Require $ before amount to prevent false positives on column headers
                { pattern: /(?:NET|GROSS)\s+SALES[\s\.:=]*\$([\d,]+\.?\d{2})/gi, priority: 2 },
                // VPS/EVO Card Summary TOTAL line format: TOTAL [count] $[amount]
                { pattern: /^TOTAL\s+[\d,]+\s+\$([\d,]+\.\d{2})/gim, priority: 2 },
                { pattern: /TOTAL\s+SALES[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 2 },
                { pattern: /TOTAL\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 2 },
                { pattern: /Grand\s+Totals\s+[\d,]+\s+\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Nationwide
                { pattern: /CC\s+Payments[\s\.:=\$]*([\d,]+\.?\d{2})/gi, priority: 2 }, // Storable/GPI
                { pattern: /CREDIT\s+CARD\s+SALES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Lightspeed
                { pattern: /CARD\s+PRESENT\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Clover
                { pattern: /CARD\s+NOT\s+PRESENT\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // E-commerce
                { pattern: /TOTAL\s+PROCESSED[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // PayPal/Stripe
                { pattern: /SALES\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Authorize.net
                { pattern: /MONTHLY\s+VOLUME[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // NMI

                // Priority 3: Card-type volume indicators
                { pattern: /BANKCARD\s+SALES[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 3 },
                { pattern: /CARD\s+SALES[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 3 },
                { pattern: /Amount\s+of\s+Sales[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 }, // EVO/Omega
                { pattern: /VISA\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },
                { pattern: /MASTERCARD\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },
                { pattern: /AMEX\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },
                { pattern: /DISCOVER\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },
                { pattern: /DEBIT\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },
                { pattern: /PIN\s+DEBIT\s+(?:SALES|VOLUME)[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 },

                // Priority 4: Table-format totals (TOTAL row with sales count + volume)
                { pattern: /TOTAL\s+[\d,]+\s+\$?([\d,]+\.?\d{2})(?:\s+\d+)?/gi, priority: 4 }, // First American & EVO/Omega
                { pattern: /Totals\s+[\d,]+\s+\$?([\d,]+\.?\d{2})/gi, priority: 4 }, // Chase Paymentech
                { pattern: /\*\*\s+[\d,]+\s+([\d,]+\.?\d{2})/gi, priority: 4 }, // BB&T plan summary
                { pattern: /TOTALS?\s*:?\s+\d+\s+([\d,]+\.?\d{2})/gi, priority: 4 }, // Generic table total
                { pattern: /ALL\s+CARDS?\s+[\d,]+\s+\$?([\d,]+\.?\d{2})/gi, priority: 4 }, // Multi-card summary

                // Priority 5: Settlement/funding totals
                { pattern: /(?:SETTLEMENT|FUNDING)\s+(?:TOTAL|AMOUNT)[\s\.:=\$]*([\d,]+\.?\d*)/gi, priority: 5 },
                { pattern: /NET\s+(?:SETTLEMENT|FUNDING)[\s\.:=\$]*([\d,]+\.?\d*)/gi, priority: 5 },
                { pattern: /Total\s+Amount\s+Processed[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 5 }, // Fiserv
                { pattern: /BATCH\s+TOTALS?[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 5 }, // Generic
                { pattern: /DAILY\s+TOTALS?[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 5 }, // Daily summary
                { pattern: /PERIOD\s+TOTALS?[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 5 } // Statement period
            ];

            let bestVolume = 0;
            let bestVolumePriority = 999;
            let volumeMatches = [];

            for (const { pattern, priority } of priorityVolumePatterns) {
                let match;
                pattern.lastIndex = 0;
                while ((match = pattern.exec(text)) !== null) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    if (value > 1000 && value < 100000000) {
                        volumeMatches.push({ value, priority, match: match[0].substring(0, 40) });
                        // Prefer higher priority (lower number) OR larger value at same priority
                        if (priority < bestVolumePriority || (priority === bestVolumePriority && value > bestVolume)) {
                            bestVolume = value;
                            bestVolumePriority = priority;
                        }
                    }
                }
            }

            // Fallback to generic patterns if no priority match found
            if (bestVolume === 0) {
                for (const pattern of volumePatterns) {
                    let match;
                    pattern.lastIndex = 0;
                    while ((match = pattern.exec(text)) !== null) {
                        const value = parseFloat(match[1].replace(/,/g, ''));
                        if (value > 1000 && value < 100000000) {
                            volumeMatches.push({ value, priority: 10, match: match[0].substring(0, 40) });
                            if (value > bestVolume) {
                                bestVolume = value;
                            }
                        }
                    }
                }
            }

            result.volume = bestVolume;
            console.log('Volume extraction - found values:', volumeMatches, 'selected:', bestVolume);

            // ============================================================
            // ENHANCED FEE PATTERNS (Feb 2026 - Comprehensive Bot Research Update)
            // Patterns from 20-bot army analysis of 50+ processor statement formats
            // Priority: Lower number = higher priority (more specific/reliable)
            // ============================================================
            const priorityFeePatterns = [
                // Priority -2: MOST SPECIFIC patterns - CardConnect summary page (HIGHEST priority)
                { pattern: /Page\s+\d+\s+Fees\s+-?\$?([\d,]+\.?\d{2})/gi, priority: -2 },
                // Stax/Payment Depot "TOTAL COST" summary box
                { pattern: /TOTAL\s+COST[\s\.:=\$]*\$?([\d,]+\.?\d{2})\s*$/gim, priority: -2 },

                // Priority -1: Highly specific patterns
                { pattern: /TOTAL\s*\([^)]*(?:FEES|CHARGES)[^)]*\)[\s\.:=]*-?\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // CardConnect
                { pattern: /YOUR\s+MERCHANT\s+ACCOUNT\s+HAS\s+BEEN\s+DEBITED:?\s*\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // Nationwide
                { pattern: /Account\s+Has\s+Been\s+Debited.*?(?:for|of)\s+\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // EVO/Omega
                { pattern: /AMOUNT\s+DEBITED[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // Clearent
                { pattern: /TOTAL\s+AMOUNT\s+DEDUCTED[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // REPAY
                { pattern: /YOUR\s+FEES\s+THIS\s+MONTH[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // Helcim
                { pattern: /TOTAL\s+MONTHLY\s+COST[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: -1 }, // Dharma

                // Priority 0: Explicit processor totals (very reliable)
                { pattern: /TOTAL\s+CREDIT\s+CARD\s+FEES:?[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 0 }, // Heartland
                { pattern: /Amount\s+Deducted:?[\s\.:=\$]*\$?\s*([\d,]+\.?\d*)/gi, priority: 0 }, // Paya/BB&T/TSYS
                { pattern: /TOTAL\s+DUE[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi, priority: 0 },
                { pattern: /Fees\s+Charged[\s\.:=\$]*-?\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Paysafe
                { pattern: /TOTAL\s+CARD\s+FEES[\s\.:=\$]*\$?\s*([\d,]+\.?\d{2})/gi, priority: 0 }, // First American
                { pattern: /TOTAL\s+CHARGE\s+TO\s+YOUR\s+ACCOUNT[\s\S]*?TOTAL[\s\.:=\$]*\$?\s*([\d,]+\.?\d{2})/gi, priority: 0 }, // First American
                { pattern: /PROCESSING\s+FEES\s+TOTAL[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Square
                { pattern: /TOTAL\s+STRIPE\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Stripe
                { pattern: /PAYPAL\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // PayPal
                { pattern: /TOAST\s+PROCESSING\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Toast
                { pattern: /CLOVER\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Clover
                { pattern: /TOTAL\s+MERCHANT\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 0 }, // Generic

                // Priority 1: Standard fee totals
                { pattern: /TOTAL\s+FEES[\s\.:=\$]+([\d,]+\.?\d{2})/gi, priority: 1 }, // WorldPay
                { pattern: /Total\s+Processing\s+Service\s+Fees[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // GPI
                { pattern: /Fees[\s\.:=\$]*\(-?([\d,]+\.?\d{2})\)/gi, priority: 1 }, // Storable (parentheses format)
                { pattern: /Total\s+\(Misc\s+Fees\s+and\s+Card\s+Fees\)[\s\.:=\$]*-?\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Paysafe
                { pattern: /TOTAL\s+PROCESSING\s+CHARGES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Elavon
                { pattern: /MERCHANT\s+DISCOUNT[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Wells Fargo
                { pattern: /TOTAL\s+SERVICE\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // Chase
                { pattern: /NET\s+PROCESSING\s+FEES[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 1 }, // BOA

                // Priority 2: General fee totals
                { pattern: /TOTAL\s+CHARGES[\s\.:=\$]*-?\$?([\d,]+\.?\d*)/gi, priority: 2 },
                { pattern: /TOTAL\s+DEDUCTIONS[\s\.:=\$]*-?\$?([\d,]+\.?\d*)/gi, priority: 2 },
                { pattern: /NET\s+FEES[\s\.:=\$]*-?\$?([\d,]+\.?\d*)/gi, priority: 2 },
                { pattern: /Discount\s+Due[\s\.:=\$]*([\d,]+\.?\d{2})/gi, priority: 2 }, // BB&T
                { pattern: /Fees\s+Due[\s\.:=\$]*([\d,]+\.?\d{2})/gi, priority: 2 }, // BB&T
                { pattern: /TOTAL\s+COST\s+OF\s+PROCESSING[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // NAB
                { pattern: /TOTAL\s+DISCOUNT[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Payroc
                { pattern: /TOTAL\s+ASSESSMENTS[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 2 }, // Priority Payment

                // Priority 3: Table-format fee totals
                { pattern: /^\s*TOTAL\s{2,}-\$?([\d,]+\.?\d{2})/gim, priority: 3 }, // CardConnect standalone
                { pattern: /Total[\s\.:=\$]*\(-?([\d,]+\.?\d{2})\)\s*$/gim, priority: 3 }, // Storable end-of-line
                { pattern: /TOTAL\s+\$[\d,]+\.?\d{2}\s+\(\$([\d,]+\.?\d{2})\)/gi, priority: 3 }, // Chase Paymentech
                { pattern: /FEES\s+SUBTOTAL[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 }, // Generic subtotal
                { pattern: /BILLING\s+TOTAL[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 3 }, // Billing summary

                // Priority 4: Fee section totals (may include subtotals)
                { pattern: /Total\s+Interchange\s+Charges[\s\S]*?([\d,]+\.?\d{2})/gi, priority: 4 },
                { pattern: /Total\s+Service\s+Charges[\s\S]*?([\d,]+\.?\d{2})/gi, priority: 4 },
                { pattern: /Interchange\/Card\s+Brand\s+Fees[\s\S]*?\(-?([\d,]+\.?\d{2})\)/gi, priority: 4 }, // Storable
                { pattern: /INTERCHANGE\s+TOTAL[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 4 },
                { pattern: /ASSESSMENT\s+TOTAL[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 4 },
                { pattern: /DUES\s+AND\s+ASSESSMENTS[\s\.:=\$]*\$?([\d,]+\.?\d{2})/gi, priority: 4 }
            ];

            let bestFees = 0;
            let bestFeesPriority = 999;
            let feeMatches = [];

            for (const { pattern, priority } of priorityFeePatterns) {
                let match;
                pattern.lastIndex = 0;
                while ((match = pattern.exec(text)) !== null) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    // Fees should be reasonable - typically 1-10% of volume, max $100k
                    if (value > 0 && value < 100000 && (bestVolume === 0 || value < bestVolume * 0.15)) {
                        feeMatches.push({ value, priority, match: match[0].substring(0, 40) });
                        // Prefer higher priority (lower number) OR larger value at same priority
                        if (priority < bestFeesPriority || (priority === bestFeesPriority && value > bestFees)) {
                            bestFees = value;
                            bestFeesPriority = priority;
                        }
                    }
                }
            }

            // Fallback to generic fee patterns if no priority match found
            if (bestFees === 0) {
                for (const pattern of feePatterns) {
                    let match;
                    pattern.lastIndex = 0;
                    while ((match = pattern.exec(text)) !== null) {
                        const value = parseFloat(match[1].replace(/,/g, ''));
                        if (value > 0 && value < 100000 && (bestVolume === 0 || value < bestVolume * 0.15)) {
                            feeMatches.push({ value, priority: 10, match: match[0].substring(0, 40) });
                            if (value > bestFees) {
                                bestFees = value;
                            }
                        }
                    }
                }
            }

            result.fees = bestFees;
            console.log('Fee extraction - found values:', feeMatches, 'selected:', bestFees);

            // If we couldn't find fees but have volume, try to sum up individual fee line items
            if (result.fees === 0 && result.volume > 0) {
                const feeLinePattern = /(?:FEE|CHARGE|DISC|ASSESSMENT|DUES)[\w\s]*[\s\.:=\$]*\$?([\d,]+\.?\d*)/gi;
                let totalFees = 0;
                let match;
                while ((match = feeLinePattern.exec(text)) !== null) {
                    const value = parseFloat(match[1].replace(/,/g, ''));
                    if (value > 0 && value < 10000) { // Individual fees typically under $10k
                        totalFees += value;
                    }
                }
                if (totalFees > 0) {
                    result.fees = totalFees;
                    console.log('Fee extraction fallback - summed individual fees:', totalFees);
                }
            }

            // Extract transaction count
            let txnMatches = [];
            for (const pattern of txnPatterns) {
                let match;
                pattern.lastIndex = 0; // Reset regex
                while ((match = pattern.exec(text)) !== null) {
                    const value = parseInt(match[1].replace(/,/g, ''));
                    if (value > 0 && value < 1000000) {
                        txnMatches.push(value);
                        if (value > result.transactions) {
                            result.transactions = value;
                        }
                    }
                }
            }
            console.log('Transaction extraction - found values:', txnMatches, 'selected:', result.transactions);

            // If we have volume but no transactions, estimate based on average ticket
            if (result.transactions === 0 && result.volume > 0) {
                // Assume average ticket of $50
                result.transactions = Math.round(result.volume / 50);
                console.log('Transaction estimation - estimated from volume:', result.transactions);
            }

            console.log('Auto-extraction final results:', result);
            return result;
        }

        // ============================================================
        // FEE PARSING ENGINE
        // ============================================================

        function parseFees(text) {
            const fees = [];
            const lines = text.split('\n');

            // ============================================================
            // ENHANCED FEE PARSING PATTERNS (Feb 2026 Update)
            // Handles: parentheses, numbers in names, processor-specific formats
            // ============================================================

            // Primary patterns - handles most fee formats including:
            // - Fees with parentheses: "Auth Fee (Per Item)"
            // - Fees with numbers in name: "Visa Level 2 Data Fee", "3D Secure Fee"
            // - Fees with special chars: "MC-NABU Fee", "V/MC Assessment"
            // - Processor codes: "SEP-1234", "WF-AUTH-001"
            const feePatterns = [
                // Standard fee pattern with enhanced character support (includes parentheses, numbers)
                /([A-Za-z][A-Za-z0-9\s\/\-\.\&\#\(\)\']+?)[\s\.\-:]+\$?([\d,]+\.?\d*)/g,

                // Fees with parenthetical descriptions: "Auth Fee (Per Item) $0.10"
                /([A-Za-z][A-Za-z0-9\s\/\-\.\&\#]*\s*\([^)]+\))[\s\.\-:]+\$?([\d,]+\.?\d*)/g,

                // Processor-specific formats (Wells Fargo SEP codes)
                /(?:SEP|WF|WFMS)[\s\-]?([A-Z0-9\-]+(?:\s+[A-Za-z\s]+)?)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // Elavon format: "ELAVON-AUTH FEE $0.05"
                /(?:ELAVON|ELV)[\s\-]?([A-Za-z0-9\s\-]+)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // Fiserv/First Data format: "FD-NETWORK FEE $0.02"
                /(?:FISERV|FD|FIRSTDATA)[\s\-]?([A-Za-z0-9\s\-]+)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // TSYS format: "TSYS ACQ FEE $0.01"
                /(?:TSYS|TS)[\s\-]?([A-Za-z0-9\s\-]+)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // Card brand specific: "MC-NABU FEE", "V-FANF", "VISA LEVEL 2"
                /(?:MC|VISA|V|MASTERCARD|AMEX|AX|DISCOVER|DISC)[\s\-]([A-Za-z0-9\s\-]+(?:FEE|ASSESSMENT|CHARGE)?)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // 2025-2026 new fee types
                /(?:ACQUIRER|ACQ)[\s\-]?([A-Za-z0-9\s\-]+FEE)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,
                /(?:NETWORK|NET)[\s\-]?(ACCESS|INTEGRITY|ENHANCEMENT)\s*(?:FEE)?[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,
                /(?:DIGITAL|TOKEN|TOKENIZATION)\s*([A-Za-z\s]*FEE)[\s\.\-:]+\$?([\d,]+\.?\d*)/gi,

                // Table format: fee name followed by tab/spaces then amount
                /^[\s]*([A-Za-z][A-Za-z0-9\s\/\-\.\&\#\(\)]+?)\t+\$?([\d,]+\.?\d*)[\s]*$/gm,

                // Right-aligned amounts (common in PDF extracts)
                /([A-Za-z][A-Za-z0-9\s\/\-\.\&\#\(\)]+?)\s{3,}\$?([\d,]+\.?\d*)[\s]*$/gm
            ];

            // Pattern for negative/credit amounts
            const negativePattern = /([A-Za-z][A-Za-z0-9\s\/\-\.\&\#\(\)]+?)[\s\.\-:]+\(?\$?([\d,]+\.?\d*)\)?[\s]*(?:CR|CREDIT|-)?/gi;

            // Multi-line fee description pattern (fee name on one line, amount on next)
            const multiLinePattern = /^[\s]*([A-Za-z][A-Za-z0-9\s\/\-\.\&\#\(\)]+?)[\s]*$[\n\r]+^[\s]*\$?([\d,]+\.?\d*)[\s]*$/gm;

            for (const line of lines) {
                if (!line.trim()) continue;

                let match;
                const testLine = line; // Keep commas for initial processing

                // Try each fee pattern
                for (const feePattern of feePatterns) {
                    feePattern.lastIndex = 0;
                    while ((match = feePattern.exec(testLine)) !== null) {
                        let name = match[1].trim();
                        const amount = parseFloat(match[2].replace(/,/g, ''));

                        // Clean up fee name
                        name = name.replace(/[\s\.\-:]+$/, '').trim(); // Remove trailing separators
                        name = name.replace(/\s+/g, ' '); // Normalize whitespace

                        if (name.length > 2 && amount > 0 && !isNaN(amount)) {
                            // Skip if this looks like a volume/total (too large for a fee)
                            if (amount > 50000) continue;

                            const category = categorizeFee(name);
                            const feeType = determineFeeType(name);
                            fees.push({
                                name: name.toUpperCase(),
                                amount: amount,
                                category: category.category,
                                feeType: feeType,  // NEW: Fee bucket type
                                confidence: category.confidence,
                                isHiddenFee: category.isHidden,
                                hiddenInfo: category.hiddenInfo
                            });
                        }
                    }
                }
            }

            // Try multi-line pattern on full text
            multiLinePattern.lastIndex = 0;
            let multiMatch;
            while ((multiMatch = multiLinePattern.exec(text)) !== null) {
                let name = multiMatch[1].trim();
                const amount = parseFloat(multiMatch[2].replace(/,/g, ''));

                name = name.replace(/[\s\.\-:]+$/, '').trim();

                if (name.length > 2 && amount > 0 && amount < 50000 && !isNaN(amount)) {
                    const category = categorizeFee(name);
                    const feeType = determineFeeType(name);
                    fees.push({
                        name: name.toUpperCase(),
                        amount: amount,
                        category: category.category,
                        feeType: feeType,  // NEW: Fee bucket type
                        confidence: category.confidence,
                        isHiddenFee: category.isHidden,
                        hiddenInfo: category.hiddenInfo
                    });
                }
            }

            // Deduplicate - keep highest confidence version if same fee appears multiple times
            const seen = new Map();
            for (const fee of fees) {
                const key = fee.name + fee.amount;
                if (!seen.has(key) || seen.get(key).confidence < fee.confidence) {
                    seen.set(key, fee);
                }
            }
            return Array.from(seen.values());
        }

        // ============================================================
        // FEE CATEGORIZATION ENGINE
        // ============================================================

        // ============================================================
        // FEE BUCKET CLASSIFICATION
        // Categorizes fees into specific pricing component buckets
        // ============================================================
        const FEE_BUCKET_PATTERNS = {
            // DISCOUNT RATE - Percentage-based fees on volume
            DISC_RATE: [
                /DISC(?:OUNT)?\s*RATE/i,
                /SALES\s*DISCOUNT/i,
                /(\d+\.?\d*)\s*%?\s*(?:DISC|RATE)\s*(?:RATE|TIMES)/i,
                /PROCESSING\s*(?:RATE|FEE).*%/i,
                /MARKUP.*%/i,
                /BASIS\s*POINT|BPS/i,
                /MERCHANT\s*DISCOUNT/i,
                /QUALIFIED\s*(?:RATE|DISC)/i,
                /MID[\s-]*QUAL(?:IFIED)?\s*(?:RATE|DISC)/i,
                /NON[\s-]*QUAL(?:IFIED)?\s*(?:RATE|DISC)/i,
            ],

            // PER TRANSACTION - Flat fee per transaction (non-auth transaction fees)
            PER_TRANS: [
                /PER\s*(?:TRANS(?:ACTION)?|TXN|ITEM)/i,
                /TRANSACTION\s*FEE(?!\s*INT)/i,  // Exclude "Transaction Integrity"
                /ITEM\s*FEE/i,
                /ACCESS\s*FEE/i,  // Network access fees (per transaction)
            ],

            // PER AUTH - Authorization fees (includes auth fees with "X TRANSACTIONS AT")
            PER_AUTH: [
                /AUTH(?:ORIZATION)?\s*FEE/i,
                /\d+\s*TRANSACTIONS?\s*AT\s*[\$\d\.]*\d+/i,  // "98 TRANSACTIONS AT 0.2544"
                /NETWORK\s*AUTH/i,
                /VOICE\s*AUTH/i,
                /AVS\s*(?:FEE|CHARGE)/i,
                /AUTHORIZATION\s*(?:CHARGE|COST)/i,
            ],

            // BATCH FEE - Settlement/batch fees
            BATCH_FEE: [
                /BATCH\s*(?:FEE|SETTLEMENT|HEADER|CHARGE)/i,
                /SETTLEMENT\s*FEE/i,
                /(\d+)\s*SETTLEMENT\s*FEES?\s*AT/i,
                /BATCH\s*CLOSE/i,
                /DAILY\s*BATCH/i,
            ],

            // MONTHLY FEES - Fixed monthly charges
            MONTHLY_FEE: [
                /MONTHLY\s*(?:FEE|SERVICE|ACCOUNT|STATEMENT|MAINTENANCE)/i,
                /STATEMENT\s*FEE/i,
                /ACCOUNT\s*(?:FEE|MAINTENANCE)/i,
                /PCI\s*(?:FEE|COMPLIANCE|NON[\s-]*COMPLIANCE)/i,
                /ANNUAL.*(?:FEE|CHARGE)/i,
                /PLATFORM\s*FEE/i,
                /GATEWAY\s*(?:FEE|ACCESS)/i,
                /EQUIPMENT\s*(?:LEASE|RENTAL|FEE)/i,
                /TERMINAL\s*(?:FEE|RENTAL)/i,
                /MINIMUM\s*(?:FEE|PROCESSING)/i,
                /LOCATION\s*FEE/i,
                /REPORTING\s*(?:FEE|ACCESS)/i,
                /(?:CLOVER|CARDPOINTE|POYNT)\s*(?:FEE|PLATFORM)/i,
            ],

            // OTHER FEES - Miscellaneous controllable fees
            OTHER_FEE: [
                /CHARGEBACK\s*(?:FEE|CHARGE)/i,
                /RETRIEVAL\s*(?:FEE|REQUEST)/i,
                /ACH\s*(?:FEE|REJECT|RETURN)/i,
                /NSF\s*FEE/i,
                /WIRE\s*(?:FEE|TRANSFER)/i,
                /EARLY\s*TERMINATION/i,
                /CANCELLATION\s*FEE/i,
                /SETUP\s*FEE/i,
                /PROGRAMMING\s*FEE/i,
                /PAPER\s*STATEMENT/i,
                /TRAINING\s*FEE/i,
                /IRS\s*(?:REPORTING|1099)/i,
                /TIN\s*(?:INVALID|MISMATCH)/i,
                /REGULATORY/i,
                /SECURITY\s*(?:FEE|ASSESSMENT)/i,
                /RISK\s*(?:FEE|ASSESSMENT|MANAGEMENT)/i,
                /TECHNOLOGY\s*FEE/i,
                /DIGITAL\s*(?:INVESTMENT|FEE)/i,
                /CONNECTIVITY\s*FEE/i,
                /NETWORK\s*(?:FEE|ACCESS)(?!\s*ASSESSMENT)/i,
                /DATA\s*(?:FEE|USAGE|BREACH)/i,
                /INTEGRITY\s*FEE/i,
                /KILOBYTE/i,
                /FILE\s*FEE/i,
            ]
        };

        // Function to determine fee bucket type
        function determineFeeType(feeName, feeDescription = '') {
            const textToCheck = (feeName + ' ' + feeDescription).toUpperCase();

            // Check in specific order: more specific patterns first
            // PER_AUTH must be checked before PER_TRANS because auth fees contain "TRANSACTIONS AT"
            const checkOrder = ['DISC_RATE', 'PER_AUTH', 'BATCH_FEE', 'MONTHLY_FEE', 'PER_TRANS', 'OTHER_FEE'];

            for (const bucketType of checkOrder) {
                const patterns = FEE_BUCKET_PATTERNS[bucketType];
                if (patterns) {
                    for (const pattern of patterns) {
                        if (pattern.test(textToCheck)) {
                            return bucketType;
                        }
                    }
                }
            }
            return 'OTHER_FEE'; // Default bucket
        }

        // ============================================================
        // COMPREHENSIVE FEE PATTERN DATABASE
        // Source: COMPREHENSIVE_RESEARCH_COMPILATION.md (50+ sources)
        // Last Updated: February 2026
        // Total Patterns: 150+
        // ============================================================

        const CONTROLLABLE_PATTERNS = [
            // === PERCENTAGE MARKUP FEES ===
            { pattern: /MARKUP|BASIS\s*POINT|BPS|DISCOUNT\s*RATE|PROCESSING\s*FEE.*%/i, confidence: 0.95 },
            { pattern: /PROCESSOR\s*(MARKUP|FEE|RATE)/i, confidence: 0.95 },
            { pattern: /MARGIN|PROFIT\s*MARGIN/i, confidence: 0.95 },
            { pattern: /SERVICE\s*CHARGE.*%/i, confidence: 0.9 },

            // === TRANSACTION-BASED FEES ===
            { pattern: /AUTH(ORIZATION)?\s*FEE/i, confidence: 0.9 },
            { pattern: /TRANSACTION\s*FEE/i, confidence: 0.85 },
            { pattern: /PER[\s\-]*(ITEM|TXN|TRANS)/i, confidence: 0.85 },
            { pattern: /BATCH\s*FEE/i, confidence: 0.9 },
            { pattern: /SETTLEMENT\s*FEE/i, confidence: 0.9 },
            { pattern: /DECLINED\s*(TRANSACTION|TXN)?\s*FEE/i, confidence: 0.95 },
            { pattern: /AVS\s*(FAILURE|FEE)|ADDRESS\s*VERIF/i, confidence: 0.85 },
            { pattern: /3D\s*SECURE\s*(VERIFICATION|FEE)/i, confidence: 0.9 },
            { pattern: /VOICE\s*AUTH/i, confidence: 0.9 },
            { pattern: /AUTHORIZATION\s*REVERSAL\s*FEE/i, confidence: 0.9 },

            // === ACCOUNT & MAINTENANCE FEES ===
            { pattern: /MONTHLY\s*(ACCOUNT|SERVICE|MAINTENANCE|FEE|STATEMENT)/i, confidence: 0.95 },
            { pattern: /STATEMENT\s*FEE/i, confidence: 0.9 },
            { pattern: /ACCOUNT\s*(FEE|MAINTENANCE)/i, confidence: 0.9 },
            { pattern: /INACTIVITY\s*FEE/i, confidence: 0.95 },
            { pattern: /MONTHLY\s*MINIMUM\s*FEE/i, confidence: 0.95 },
            { pattern: /ACCOUNT\s*ON\s*FILE\s*FEE/i, confidence: 0.95 },
            { pattern: /ANNUAL\s*FEE/i, confidence: 0.9 },

            // === PCI & COMPLIANCE FEES ===
            { pattern: /PCI\s*(COMPLIANCE|NON[\s\-]*COMPLIANCE)/i, confidence: 0.95 },
            { pattern: /PCI\s*ANNUAL\s*FEE/i, confidence: 0.95 },
            { pattern: /BREACH\s*COVERAGE\s*FEE/i, confidence: 0.95 },
            { pattern: /REGULATORY\s*FEE/i, confidence: 0.85 },
            { pattern: /COMPLIANCE\s*(FEE|ASSESSMENT)/i, confidence: 0.85 },

            // === CHARGEBACK & DISPUTE FEES ===
            { pattern: /CHARGEBACK\s*FEE/i, confidence: 0.9 },
            { pattern: /RETRIEVAL\s*FEE/i, confidence: 0.9 },
            { pattern: /CHARGEBACK\s*REPRESENTMENT\s*FEE/i, confidence: 0.95 },
            { pattern: /DISPUTE\s*FEE/i, confidence: 0.9 },

            // === EQUIPMENT & SERVICE FEES ===
            { pattern: /TERMINAL\s*FEE/i, confidence: 0.95 },
            { pattern: /EQUIPMENT\s*(LEASE|FEE|RENTAL)/i, confidence: 0.95 },
            { pattern: /POS\s*INTEGRATION\s*FEE/i, confidence: 0.95 },
            { pattern: /SETUP\s*FEE/i, confidence: 0.95 },
            { pattern: /INTEGRATION\s*FEE/i, confidence: 0.9 },
            { pattern: /GATEWAY\s*FEE/i, confidence: 0.85 },
            { pattern: /VIRTUAL\s*TERMINAL\s*FEE/i, confidence: 0.95 },
            { pattern: /WIRELESS\s*FEE/i, confidence: 0.85 },
            { pattern: /EQUIPMENT/i, confidence: 0.85 },

            // === CONTRACT & TERMINATION FEES ===
            { pattern: /EARLY\s*TERM(INATION)?/i, confidence: 0.95 },
            { pattern: /LIQUIDATED\s*DAMAGES/i, confidence: 0.95 },
            { pattern: /ACCOUNT\s*CLOSURE\s*FEE/i, confidence: 0.95 },
            { pattern: /DECONVERSION\s*FEE/i, confidence: 0.95 },
            { pattern: /CANCELLATION\s*FEE/i, confidence: 0.95 },

            // === GPI-SPECIFIC CONTROLLABLE ===
            { pattern: /ACCESS\s*FEE/i, confidence: 0.8 },
            { pattern: /SERVICE\s*FEE/i, confidence: 0.75 },
            { pattern: /SUPPORT\s*FEE/i, confidence: 0.85 },
            { pattern: /REPORTING\s*FEE/i, confidence: 0.85 },

            // === NEW: From Statement Analysis (Feb 2026) ===
            // ECR Fees (Wells Fargo style - major markup source)
            { pattern: /ECR\s*AUTH/i, confidence: 0.90 },
            { pattern: /ECR\s*ADDR(ESS)?\s*VERIF/i, confidence: 0.90 },

            // Processor Transaction Fees
            { pattern: /INTERNET\s*NETCONNECT/i, confidence: 0.90 },
            { pattern: /PIF\s*(FINAL|DETAIL)/i, confidence: 0.85 },
            { pattern: /TSYS\s*ACQUIRING/i, confidence: 0.95 },
            { pattern: /TMS\s*AMEX\s*SUPPORT/i, confidence: 0.95 },

            // Service/Admin Fees
            { pattern: /SERVICE\s*MAINTENANCE/i, confidence: 0.95 },
            { pattern: /ADMIN\s*SERVICE/i, confidence: 0.95 },
            { pattern: /MONTHLY\s*SVCS?\s*FEE/i, confidence: 0.95 },
            { pattern: /PAPER\s*STATEMENT/i, confidence: 0.95 },
            { pattern: /INTERNET\s*SERVICE\s*FEE/i, confidence: 0.95 },

            // Insurance/Optional Products
            { pattern: /CARD\s*COMPROMISE/i, confidence: 0.95 },
            { pattern: /MERCH(ANT)?\s*INSIGHTS/i, confidence: 0.95 },

            // Tiered Pricing Markups
            { pattern: /DISC\s*(I|1)\s/i, confidence: 0.85 },
            { pattern: /NQUAL\s*DISC/i, confidence: 0.90 },
            { pattern: /SALES\s*DISCOUNT/i, confidence: 0.85 },
            { pattern: /MID[\s\-]*QUAL\s*SALES/i, confidence: 0.90 },
            { pattern: /NON[\s\-]*QUAL\s*SALES/i, confidence: 0.90 },

            // Per-Transaction Markups
            { pattern: /MISUSE.*AUTH/i, confidence: 0.85 },
            { pattern: /ONLINE\s*DEBIT\s*DENIAL/i, confidence: 0.90 },
            { pattern: /BATCH\s*HEADER/i, confidence: 0.90 },
            { pattern: /MC\s*MERCH\s*MONTHLY/i, confidence: 0.90 },

            // === NEW: 2026 Research Update Patterns ===
            // Mastercard MOTO Changes (Jan 2026)
            { pattern: /MOTO\s*(AUTH|AUTHORIZATION)\s*FEE/i, confidence: 0.85 },
            { pattern: /UNDEFINED\s*AUTH(ORIZATION)?/i, confidence: 0.90 },
            { pattern: /DECLINED\s*(AUTH|AUTHORIZATION)\s*(CAP|FEE)/i, confidence: 0.85 },

            // Fiserv/First Data Stealth Increases
            { pattern: /NETWORK\s*ENHANCEMENT/i, confidence: 0.90 },
            { pattern: /CONNECTIVITY\s*UPGRADE/i, confidence: 0.90 },
            { pattern: /PLATFORM\s*MODERNIZATION/i, confidence: 0.90 },

            // Capital One/Discover Migration Fees
            { pattern: /NETWORK\s*MIGRATION/i, confidence: 0.85 },
            { pattern: /CARD\s*MIGRATION\s*FEE/i, confidence: 0.90 },

            // Data Quality/Compliance Markups
            { pattern: /DATA\s*QUALITY\s*FEE/i, confidence: 0.90 },
            { pattern: /INVOICE\s*QUALITY\s*FEE/i, confidence: 0.90 },
            { pattern: /CEDP\s*NON[\s\-]*COMPLIANCE/i, confidence: 0.95 },

            // Annual/Stealth Increases
            { pattern: /ANNUAL\s*RATE\s*ADJUSTMENT/i, confidence: 0.95 },
            { pattern: /PRICING\s*UPDATE\s*FEE/i, confidence: 0.95 },
            { pattern: /EFFECTIVE\s*RATE\s*CHANGE/i, confidence: 0.90 }
        ];

        const PASSTHROUGH_PATTERNS = [
            // === VISA INTERCHANGE CATEGORIES ===
            { pattern: /INTERCHANGE|IC\s|I\/C\s/i, confidence: 0.95 },
            { pattern: /VISA\s*(CREDIT|DEBIT|CPS|EIRF)/i, confidence: 0.9 },
            { pattern: /CPS[\s\/]*(RETAIL|RESTAURANT|SUPERMARKET|E[\s\-]*COMMERCE)/i, confidence: 0.95 },
            { pattern: /CPS[\s\/]*(UTILITY|GOVERNMENT|BILL\s*PAY)/i, confidence: 0.95 },
            { pattern: /EIRF\s*(DEBIT|PREPAID|D|DR|PP)/i, confidence: 0.95 },
            { pattern: /VISA\s*SIGNATURE/i, confidence: 0.95 },
            { pattern: /VISA\s*INFINITE/i, confidence: 0.95 },
            { pattern: /VS\s*(CREDIT|DEBIT|SIGNATURE)/i, confidence: 0.9 },

            // === MASTERCARD INTERCHANGE CATEGORIES ===
            { pattern: /MC\s|MASTERCARD\s*(CREDIT|DEBIT|MERIT|WORLD)/i, confidence: 0.9 },
            { pattern: /MERIT\s*(I|II|III|BASE|TIER)/i, confidence: 0.95 },
            { pattern: /WORLD\s*(ELITE|HIGH\s*VALUE)/i, confidence: 0.95 },
            { pattern: /ENHANCED\s*VALUE/i, confidence: 0.9 },
            { pattern: /CORE\s*(CREDIT|DEBIT)/i, confidence: 0.85 },
            { pattern: /MC\s*UCAF|MERCHANT\s*UCAF|FULL\s*UCAF/i, confidence: 0.95 },

            // === OTHER CARD BRANDS ===
            { pattern: /DISCOVER\s*(CREDIT|DEBIT|NETWORK)/i, confidence: 0.9 },
            { pattern: /AMEX\s*(CREDIT|OPT|OPTBLUE)/i, confidence: 0.9 },
            { pattern: /AMERICAN\s*EXPRESS/i, confidence: 0.9 },

            // === VISA ASSESSMENT FEES (LEGITIMATE PASS-THROUGH) ===
            { pattern: /^ASSESSMENT|BRAND\s*FEE/i, confidence: 0.9 },
            { pattern: /VISA\s*(ASSESS|ASSESSMENT)/i, confidence: 0.95 },
            { pattern: /CREDIT\s*CARD\s*ASSESSMENT/i, confidence: 0.95 },
            { pattern: /DEBIT\s*CARD\s*ASSESSMENT/i, confidence: 0.95 },
            { pattern: /INTERNATIONAL\s*ASSESSMENT/i, confidence: 0.95 },

            // === FANF (Fixed Acquirer Network Fee) - VISA ===
            { pattern: /FANF|FIXED\s*ACQUIRER\s*NETWORK/i, confidence: 0.95 },
            { pattern: /VISA\s*FANF/i, confidence: 0.95 },
            { pattern: /CNP\s*FANF|CARD[\s\-]*NOT[\s\-]*PRESENT\s*FANF/i, confidence: 0.95 },
            { pattern: /CP\s*FANF|CARD[\s\-]*PRESENT\s*FANF/i, confidence: 0.95 },

            // === CEDP (Commercial Enhanced Data Program) - VISA ===
            { pattern: /CEDP|COMMERCIAL\s*ENHANCED\s*DATA/i, confidence: 0.95 },
            { pattern: /LEVEL\s*(2|3|II|III)\s*(DATA|PROCESSING)/i, confidence: 0.9 },
            { pattern: /ENHANCED\s*DATA\s*PROGRAM/i, confidence: 0.95 },

            // === VAMP (Visa Acquirer Monitoring Program) - 2025 ===
            { pattern: /VAMP|ACQUIRER\s*MONITORING/i, confidence: 0.95 },
            { pattern: /FRAUD(ULENT)?\s*(TXN|TRANSACTION)\s*FEE/i, confidence: 0.9 },

            // === MASTERCARD ASSESSMENTS ===
            { pattern: /MC\s*ASSESS|MASTERCARD\s*ASSESS(MENT)?/i, confidence: 0.95 },
            { pattern: /NABU|NETWORK\s*ACCESS\s*BRAND\s*USAGE/i, confidence: 0.95 },
            { pattern: /APF|ACQUIRER\s*PROGRAM\s*FEE/i, confidence: 0.9 },
            { pattern: /DIGITAL\s*ENABLEMENT\s*FEE/i, confidence: 0.95 },
            { pattern: /MERCHANT\s*ADVICE\s*CODE\s*FEE/i, confidence: 0.95 },
            { pattern: /TRANSACTION\s*PROCESSING\s*EXCELLENCE/i, confidence: 0.95 },

            // === NETWORK ACCESS FEES ===
            { pattern: /ACQUIRER\s*FEE/i, confidence: 0.85 },
            { pattern: /NETWORK\s*ACCESS\s*FEE/i, confidence: 0.85 },
            { pattern: /CARD\s*BRAND\s*(FEE|DUES)/i, confidence: 0.9 },
            { pattern: /DUES\s*&?\s*ASSESS(MENT)?/i, confidence: 0.9 },

            // === DEBIT NETWORKS ===
            { pattern: /PIN\s*DEBIT|PINLESS\s*DEBIT/i, confidence: 0.85 },
            { pattern: /STAR\s*NETWORK/i, confidence: 0.95 },
            { pattern: /PULSE\s*NETWORK/i, confidence: 0.95 },
            { pattern: /NYCE\s*NETWORK/i, confidence: 0.95 },
            { pattern: /ACCEL\s*NETWORK/i, confidence: 0.95 },
            { pattern: /DEBIT\s*NETWORK\s*(FEE|ACCESS)/i, confidence: 0.85 },
            { pattern: /REGULATED\s*DEBIT/i, confidence: 0.95 },
            { pattern: /DURBIN\s*(REGULATED|EXEMPT)/i, confidence: 0.95 },

            // === CROSS-BORDER FEES ===
            { pattern: /CROSS[\s\-]*BORDER\s*FEE/i, confidence: 0.95 },
            { pattern: /INTERNATIONAL\s*(SERVICE|FEE)/i, confidence: 0.9 },
            { pattern: /FOREIGN\s*(TRANSACTION|TXN)\s*FEE/i, confidence: 0.9 },
            { pattern: /CURRENCY\s*CONVERSION/i, confidence: 0.9 },

            // === NEW: From Statement Analysis (Feb 2026) ===
            // Mastercard Network Fees
            { pattern: /MC\s*NABU\s*(FEE)?/i, confidence: 0.95 },
            { pattern: /MC\s*KB\s*TRAN/i, confidence: 0.95 },
            { pattern: /MC\s*CROSS\s*BORDER/i, confidence: 0.95 },
            { pattern: /MC\s*ASI\s*INTRAREGIONAL/i, confidence: 0.95 },
            { pattern: /MC\s*ACQUIRING\s*LICENSE/i, confidence: 0.95 },
            { pattern: /MC\s*LICENSE\s*VOLUME/i, confidence: 0.95 },

            // Visa Network Fees
            { pattern: /VISA\s*BASE\s*II/i, confidence: 0.95 },
            { pattern: /VISA\s*FIX\s*ACQ\s*NTWK/i, confidence: 0.95 },

            // Acquirer Processing Fees
            { pattern: /ACQUIRER\s*PROC.*FEE/i, confidence: 0.85 },
            { pattern: /ACQUIRER\s*PROC.*DB/i, confidence: 0.90 },
            { pattern: /ACQUIRER\s*PROC.*PREPAID/i, confidence: 0.90 },
            { pattern: /INTERNATIONAL\s*ACQUIRER\s*FEE/i, confidence: 0.95 },

            // Additional Interchange Categories (from real statements)
            { pattern: /VS\s*CPS\s*(RETAIL|RESTAURANT|SUPERMARKET)/i, confidence: 0.95 },
            { pattern: /VS\s*CPS\s*REWARDS\s*[12]/i, confidence: 0.95 },
            { pattern: /VS\s*SIGNATURE\s*PREF/i, confidence: 0.95 },
            { pattern: /VS\s*EIRF/i, confidence: 0.95 },
            { pattern: /MC\s*MERIT\s*(I|II|III)/i, confidence: 0.95 },
            { pattern: /MC\s*WORLD\s*ELITE/i, confidence: 0.95 },
            { pattern: /MC\s*REGF?\s*MERIT/i, confidence: 0.95 },
            { pattern: /DS\s*PSL\s*RETAIL/i, confidence: 0.95 },
            { pattern: /AM\s*RETAIL\s*TIER/i, confidence: 0.90 },

            // Elavon-specific interchange categories
            { pattern: /HV\s*MERIT/i, confidence: 0.95 },
            { pattern: /MCW\s*MERIT/i, confidence: 0.95 },
            { pattern: /MWE\s*MERIT/i, confidence: 0.95 },

            // === NEW: 2026 Research Update Patterns ===
            // Visa CEDP (Commercial Enhanced Data Program)
            { pattern: /CEDP\s*(ASSESS|FEE)/i, confidence: 0.95 },
            { pattern: /COMMERCIAL\s*ENHANCED\s*DATA/i, confidence: 0.95 },
            { pattern: /INVOICE\s*DATA\s*ASSESSMENT/i, confidence: 0.90 },

            // Mastercard 2026 Changes
            { pattern: /MC\s*MOTO\s*(ALL|AUTH)/i, confidence: 0.90 },
            { pattern: /MC\s*UNDEFINED\s*AUTH/i, confidence: 0.90 },

            // Capital One/Discover Network Migration (2026)
            { pattern: /DISCOVER\s*NETWORK\s*ASSESS/i, confidence: 0.95 },
            { pattern: /CAP\s*ONE\s*DEBIT/i, confidence: 0.90 },

            // Debit/Durbin Related
            { pattern: /DURBIN\s*(CAP|REGULATED|EXEMPT)/i, confidence: 0.95 },
            { pattern: /DEBIT\s*ROUTING\s*FEE/i, confidence: 0.85 },

            // === BOT RESEARCH: Comprehensive Card Brand Fee Patterns (Feb 2026) ===
            // VISA Assessment Fees
            { pattern: /VISA\s*APF|V\s*APF/i, confidence: 0.95 }, // Acquirer Processing Fee
            { pattern: /VISA\s*ISA|V\s*ISA/i, confidence: 0.95 }, // International Service Assessment
            { pattern: /VISA\s*TIF|V\s*TIF/i, confidence: 0.95 }, // Transaction Integrity Fee
            { pattern: /VISA\s*VDIF/i, confidence: 0.95 }, // Visa Debit Interchange Fee
            { pattern: /V\s*CNP\s*AUTH/i, confidence: 0.90 }, // Card Not Present Auth
            { pattern: /V\s*MISUSE/i, confidence: 0.95 }, // Visa Misuse Fee
            { pattern: /VISA\s*KILOBYTE/i, confidence: 0.95 }, // Data Fee

            // MASTERCARD Assessment Fees
            { pattern: /MC\s*ALF|ACQUIRING\s*LICENSE\s*FEE/i, confidence: 0.95 }, // Acquiring License Fee
            { pattern: /MC\s*CLEARING\s*FEE/i, confidence: 0.95 },
            { pattern: /MC\s*ACCOUNT\s*STATUS\s*INQUIRY/i, confidence: 0.95 },
            { pattern: /MC\s*AUTH\s*ATTEMPT/i, confidence: 0.90 },
            { pattern: /MC\s*DIGITAL\s*ENABLEMENT/i, confidence: 0.95 }, // Digital commerce fee
            { pattern: /MASTERCARD\s*INTEGRITY\s*FEE/i, confidence: 0.95 },
            { pattern: /MC\s*FRAUD\s*SCORE/i, confidence: 0.90 },

            // DISCOVER/Pulse Assessment Fees
            { pattern: /DISCOVER\s*DATA\s*USAGE/i, confidence: 0.95 },
            { pattern: /DISCOVER\s*NETWORK\s*AUTH/i, confidence: 0.95 },
            { pattern: /DS\s*ASSESS|DISCOVER\s*ASSESSMENT/i, confidence: 0.95 },
            { pattern: /PULSE\s*ASSESS|PULSE\s*NETWORK\s*FEE/i, confidence: 0.95 },

            // AMEX Assessment Fees
            { pattern: /AMEX\s*NETWORK\s*FEE/i, confidence: 0.95 },
            { pattern: /AMEX\s*CNP\s*FEE/i, confidence: 0.95 }, // Card Not Present
            { pattern: /OPTBLUE\s*(ASSESS|FEE)/i, confidence: 0.95 },
            { pattern: /AX\s*ASSESS/i, confidence: 0.90 },

            // PIN Debit Networks (Bot Research)
            { pattern: /STAR\s*(ASSESS|FEE|SWITCH)/i, confidence: 0.95 },
            { pattern: /PULSE\s*(ASSESS|FEE|SWITCH)/i, confidence: 0.95 },
            { pattern: /NYCE\s*(ASSESS|FEE|SWITCH)/i, confidence: 0.95 },
            { pattern: /ACCEL\s*(ASSESS|FEE|SWITCH)/i, confidence: 0.95 },
            { pattern: /INTERLINK\s*(ASSESS|FEE)/i, confidence: 0.95 },
            { pattern: /MAESTRO\s*(ASSESS|FEE)/i, confidence: 0.95 },
            { pattern: /SHAZAM\s*(ASSESS|FEE)/i, confidence: 0.95 },
            { pattern: /CO-?OP\s*(ASSESS|FEE)/i, confidence: 0.90 },
            { pattern: /JEANIE\s*(ASSESS|FEE)/i, confidence: 0.90 },
            { pattern: /CULIANCE\s*(ASSESS|FEE)/i, confidence: 0.90 },

            // Interchange Category Names (Bot Research - 50+ Processors)
            // Visa CPS Categories
            { pattern: /CPS\s*REWARDS\s*[12]/i, confidence: 0.95 },
            { pattern: /CPS\s*SMALL\s*TICKET/i, confidence: 0.95 },
            { pattern: /CPS\s*CNP|CPS\s*CARD\s*NOT\s*PRESENT/i, confidence: 0.95 },
            { pattern: /CPS\s*SERVICE\s*STATION/i, confidence: 0.95 },
            { pattern: /CPS\s*HOTEL/i, confidence: 0.95 },
            { pattern: /CPS\s*CAR\s*RENTAL/i, confidence: 0.95 },
            { pattern: /CPS\s*AUTOMATED\s*FUEL/i, confidence: 0.95 },
            { pattern: /CPS\s*PASSENGER\s*TRANSPORT/i, confidence: 0.95 },
            { pattern: /SIGNATURE\s*PREFERRED/i, confidence: 0.95 },
            { pattern: /INFINITE\s*PREFERRED/i, confidence: 0.95 },
            { pattern: /VISA\s*TRADITIONAL\s*REWARDS/i, confidence: 0.95 },

            // Mastercard Merit Categories
            { pattern: /MERIT\s*(BASE|I|II|III|1|2|3)/i, confidence: 0.95 },
            { pattern: /SUPERMARKET\s*MERIT/i, confidence: 0.95 },
            { pattern: /SERVICE\s*INDUSTRY\s*MERIT/i, confidence: 0.95 },
            { pattern: /WORLD\s*HIGH\s*VALUE/i, confidence: 0.95 },
            { pattern: /ENHANCED\s*MERIT/i, confidence: 0.95 },

            // Discover Categories
            { pattern: /CONSUMER\s*CREDIT\s*RETAIL/i, confidence: 0.90 },
            { pattern: /PREMIUM\s*PLUS\s*RETAIL/i, confidence: 0.90 },
            { pattern: /REWARDS\s*RETAIL/i, confidence: 0.90 },

            // Amex OptBlue Categories
            { pattern: /OPTBLUE\s*TIER\s*[123]/i, confidence: 0.95 },
            { pattern: /RETAIL\s*TIER\s*[123]/i, confidence: 0.90 },
            { pattern: /RESTAURANT\s*TIER/i, confidence: 0.90 },

            // Tiered/Bundled Pricing Indicators (should be flagged for review)
            { pattern: /QUAL(?:IFIED)?\s*(?:RATE|DISC)/i, confidence: 0.80 },
            { pattern: /MID[\s-]*QUAL(?:IFIED)?\s*(?:RATE|DISC)/i, confidence: 0.80 },
            { pattern: /NON[\s-]*QUAL(?:IFIED)?\s*(?:RATE|DISC)/i, confidence: 0.80 },
            { pattern: /EIRF\s*(?:SURCHARGE|DOWNGRADE)/i, confidence: 0.85 },
            { pattern: /ERR\s*SURCHARGE/i, confidence: 0.85 }
        ];

        // ============================================================
        // HIDDEN FEES DATABASE - CRITICAL FOR ACCURATE ANALYSIS
        // These fees LOOK like pass-through but are actually 100% CONTROLLABLE!
        // Source: COMPREHENSIVE_RESEARCH_COMPILATION.md (50+ real processor statements)
        // Last Updated: February 2026
        // ============================================================
        const HIDDEN_FEE_PATTERNS = [
            // === DISGUISED ASSESSMENT FEES (NOT real network fees!) ===
            { pattern: /RISK\s*(ASSESSMENT|MANAGEMENT|FEE)/i, note: '‚ö†Ô∏è PURE MARKUP - NO card brand charges this! Often 0.10-0.25%', confidence: 0.95 },
            { pattern: /SECURITY\s*(ASSESSMENT|FEE)/i, note: '‚ö†Ô∏è Processor markup disguised as security - NOT a network requirement', confidence: 0.95 },
            { pattern: /TECHNOLOGY\s*(ASSESSMENT|FEE)/i, note: '‚ö†Ô∏è Infrastructure cost markup - 100% negotiable', confidence: 0.95 },
            { pattern: /COMPLIANCE\s*ASSESSMENT/i, note: '‚ö†Ô∏è Internal compliance cost passed to merchant - controllable', confidence: 0.9 },
            { pattern: /REGULATORY\s*ASSESSMENT/i, note: '‚ö†Ô∏è Usually NOT actual regulation - disguised markup', confidence: 0.9 },
            { pattern: /PLATFORM\s*(FEE|ASSESSMENT)/i, note: '‚ö†Ô∏è Software/infrastructure markup - fully negotiable', confidence: 0.95 },
            { pattern: /SERVICE\s*ASSESSMENT/i, note: '‚ö†Ô∏è Hidden service charge markup', confidence: 0.95 },
            { pattern: /PROCESSING\s*ASSESSMENT/i, note: '‚ö†Ô∏è Disguised processing fee - NOT network pass-through', confidence: 0.95 },
            { pattern: /DATA\s*(ASSESSMENT|FEE)/i, note: '‚ö†Ô∏è Processor data handling fee - controllable', confidence: 0.9 },
            { pattern: /INFRASTRUCTURE\s*(ASSESSMENT|FEE)/i, note: '‚ö†Ô∏è Pure infrastructure markup', confidence: 0.95 },

            // === INTERCHANGE MANIPULATION FEES ===
            { pattern: /INTERCHANGE\s*MANAGEMENT/i, note: '‚ö†Ô∏è NOT interchange! Processor optimization fee (EVO/PayTrace ~0.20%)', confidence: 0.95 },
            { pattern: /INTERCHANGE\s*OPTIMIZATION/i, note: '‚ö†Ô∏è Processor fee for "optimizing" rates - ironic markup', confidence: 0.95 },
            { pattern: /IC\s*PLUS\s*FEE/i, note: '‚ö†Ô∏è Additional fee on top of IC+ pricing - hidden markup', confidence: 0.9 },
            { pattern: /INTERCHANGE\s*DIFFERENTIAL/i, note: '‚ö†Ô∏è Difference padding - processor keeps the "difference"', confidence: 0.9 },
            { pattern: /RATE\s*OPTIMIZATION/i, note: '‚ö†Ô∏è Processor service fee - not actual interchange', confidence: 0.85 },

            // === WORLDPAY-SPECIFIC HIDDEN FEES ===
            { pattern: /TRANSACTION\s*RISK\s*FEE/i, note: '‚ö†Ô∏è WorldPay-style risk markup - 100% controllable', confidence: 0.95 },
            { pattern: /PROCESSOR\s*TRANSACTION\s*RISK/i, note: '‚ö†Ô∏è WorldPay brand-specific - pure markup', confidence: 0.95 },
            { pattern: /SAFERPAYMENTS/i, note: '‚ö†Ô∏è WorldPay security add-on - optional and negotiable', confidence: 0.95 },
            { pattern: /NETWORK\s*&?\s*PROCESSOR\s*ACCESS/i, note: '‚ö†Ô∏è WorldPay style - NOT network pass-through', confidence: 0.95 },
            { pattern: /WORLDPAY\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è WorldPay service markup', confidence: 0.95 },

            // === GLOBAL PAYMENTS-SPECIFIC HIDDEN FEES ===
            { pattern: /POS\s*VENDOR\s*FEE/i, note: '‚ö†Ô∏è Global Payments hidden per-item markup', confidence: 0.95 },
            { pattern: /GLOBAL\s*VPN/i, note: '‚ö†Ô∏è Global Payments authorization markup', confidence: 0.95 },
            { pattern: /GP\s*FEE/i, note: '‚ö†Ô∏è Global Payments additional markup', confidence: 0.95 },
            { pattern: /GLOBAL\s*PAYMENTS\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è GP-specific service fee', confidence: 0.95 },
            { pattern: /TSYS\s*(SERVICE|PLATFORM|FEE)/i, note: '‚ö†Ô∏è TSYS (now Global Payments) markup', confidence: 0.9 },

            // === GPI/HEARTLAND-SPECIFIC HIDDEN FEES ===
            { pattern: /SETTLEMENT\s*(FUNDING|FEE)/i, note: '‚ö†Ô∏è GPI Merchant Services style - pure markup (often 0.30%)', confidence: 0.95 },
            { pattern: /HEARTLAND\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è Heartland-specific service markup', confidence: 0.9 },
            { pattern: /HPS\s*FEE/i, note: '‚ö†Ô∏è Heartland Payment Systems fee', confidence: 0.9 },

            // === FISERV/FIRST DATA-SPECIFIC HIDDEN FEES ===
            { pattern: /FISERV\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è Fiserv service markup', confidence: 0.9 },
            { pattern: /FIRST\s*DATA\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è First Data (now Fiserv) markup', confidence: 0.9 },
            { pattern: /CLOVER\s*(SERVICE|PLATFORM)\s*FEE/i, note: '‚ö†Ô∏è Clover platform fee - negotiable', confidence: 0.9 },

            // === ELAVON-SPECIFIC HIDDEN FEES ===
            { pattern: /ELAVON\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è Elavon service markup', confidence: 0.9 },
            { pattern: /US\s*BANK\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è US Bank/Elavon markup', confidence: 0.9 },

            // === CHASE/PAYMENTECH-SPECIFIC HIDDEN FEES ===
            { pattern: /PAYMENTECH\s*(SERVICE|PLATFORM)/i, note: '‚ö†Ô∏è Chase Paymentech markup', confidence: 0.9 },
            { pattern: /CHASE\s*MERCHANT\s*(SERVICE|FEE)/i, note: '‚ö†Ô∏è Chase merchant markup', confidence: 0.9 },

            // === EVO/PAYTRACE-SPECIFIC HIDDEN FEES ===
            { pattern: /EVO\s*(SERVICE|PLATFORM|FEE)/i, note: '‚ö†Ô∏è EVO Payments markup', confidence: 0.9 },
            { pattern: /PAYTRACE\s*(SERVICE|FEE)/i, note: '‚ö†Ô∏è PayTrace markup', confidence: 0.9 },

            // === NETWORK ACCESS DISGUISED FEES ===
            { pattern: /PROCESSOR\s*ACCESS\s*FEE/i, note: '‚ö†Ô∏è NOT network access - processor infrastructure fee', confidence: 0.95 },
            { pattern: /SYSTEM\s*ACCESS\s*FEE/i, note: '‚ö†Ô∏è Processor system markup', confidence: 0.95 },
            { pattern: /CONNECTIVITY\s*FEE/i, note: '‚ö†Ô∏è Infrastructure connectivity markup', confidence: 0.9 },
            { pattern: /HOST\s*CAPTURE\s*FEE/i, note: '‚ö†Ô∏è Processing infrastructure fee - controllable', confidence: 0.9 },

            // === MONTHLY HIDDEN MARKUPS ===
            { pattern: /MONTHLY\s*DISCOUNT\s*ADJUSTMENT/i, note: '‚ö†Ô∏è Hidden monthly markup adjustment', confidence: 0.95 },
            { pattern: /MONTHLY\s*ASSESSMENT\s*FEE/i, note: '‚ö†Ô∏è Processor monthly assessment markup', confidence: 0.9 },
            { pattern: /ACCOUNT\s*ANALYSIS\s*FEE/i, note: '‚ö†Ô∏è Analysis service markup', confidence: 0.9 },
            { pattern: /REPORTING\s*FEE/i, note: '‚ö†Ô∏è Reporting service markup - should be free', confidence: 0.9 },

            // === BUNDLED/DISGUISED PROGRAM FEES ===
            { pattern: /REWARDS\s*PROGRAM\s*FEE/i, note: '‚ö†Ô∏è Processor rewards handling fee - NOT interchange', confidence: 0.9 },
            { pattern: /PREMIUM\s*CARD\s*FEE/i, note: '‚ö†Ô∏è Additional premium card markup beyond interchange', confidence: 0.9 },
            { pattern: /ENHANCED\s*PROGRAM\s*FEE/i, note: '‚ö†Ô∏è Program enhancement markup', confidence: 0.9 },
            { pattern: /VALUE\s*ADDED\s*SERVICE/i, note: '‚ö†Ô∏è VAS markup - optional and negotiable', confidence: 0.85 },

            // === SECURITY/FRAUD HIDDEN FEES ===
            { pattern: /FRAUD\s*(PROTECTION|PREVENTION)\s*FEE/i, note: '‚ö†Ô∏è Processor fraud service - NOT network requirement', confidence: 0.9 },
            { pattern: /TOKENIZATION\s*FEE/i, note: '‚ö†Ô∏è Processor tokenization service - often free elsewhere', confidence: 0.9 },
            { pattern: /ENCRYPTION\s*FEE/i, note: '‚ö†Ô∏è Basic security should be included - markup', confidence: 0.9 },
            { pattern: /LIABILITY\s*PROTECTION/i, note: '‚ö†Ô∏è Insurance/protection service markup', confidence: 0.85 },

            // === BIN/SPONSOR HIDDEN FEES ===
            { pattern: /BIN\s*(SPONSORSHIP|ACCESS)\s*FEE/i, note: '‚ö†Ô∏è BIN access fee - processor overhead markup', confidence: 0.9 },
            { pattern: /SPONSOR\s*BANK\s*FEE/i, note: '‚ö†Ô∏è Sponsor bank fee - often inflated', confidence: 0.85 },

            // === GENERIC DISGUISED MARKUPS ===
            { pattern: /MISCELLANEOUS\s*FEE/i, note: '‚ö†Ô∏è Vague "misc" fee - always investigate', confidence: 0.9 },
            { pattern: /OTHER\s*FEE/i, note: '‚ö†Ô∏è Vague "other" fee - hidden markup', confidence: 0.85 },
            { pattern: /ADDITIONAL\s*FEE/i, note: '‚ö†Ô∏è Additional unspecified fee - markup', confidence: 0.85 },
            { pattern: /SURCHARGE/i, note: '‚ö†Ô∏è Surcharge beyond interchange - verify legitimacy', confidence: 0.8 },
            { pattern: /CONVENIENCE\s*FEE/i, note: '‚ö†Ô∏è Convenience fee markup', confidence: 0.85 },

            // === NEW: From Statement Analysis (Feb 2026) ===
            // Bundled/Disguised Interchange Fees
            { pattern: /INTER[\s\-]*CHG\s*ASSESS/i, note: '‚ö†Ô∏è BUNDLED MARKUP disguised as interchange - common in tiered pricing', confidence: 0.85 },
            { pattern: /INTER[\s\-]*CHANGE\s*ASSESS/i, note: '‚ö†Ô∏è BUNDLED MARKUP - actual interchange should be itemized', confidence: 0.85 },

            // Wells Fargo SEP Codes (Downgrade/Surcharge Equalization)
            { pattern: /SEP\s*BB\d+/i, note: '‚ö†Ô∏è Surcharge Equalization Pricing - downgrade indicator, opportunity to optimize', confidence: 0.80 },
            { pattern: /SEP\s*BB080/i, note: '‚ö†Ô∏è SEP: Signature Preferred CP - premium card downgrade', confidence: 0.80 },
            { pattern: /SEP\s*BB183/i, note: '‚ö†Ô∏è SEP: CPS Retail Key Entry - should be swiped, downgrade opportunity', confidence: 0.85 },
            { pattern: /SEP\s*BB084/i, note: '‚ö†Ô∏è SEP: Commercial Card w/o Level 2 - Level 2 data opportunity', confidence: 0.85 },
            { pattern: /SEP\s*BB190/i, note: '‚ö†Ô∏è SEP: Rewards transaction surcharge', confidence: 0.80 },

            // Merchant Warehouse/Processor-specific
            { pattern: /ECI\s*CPU/i, note: '‚ö†Ô∏è Merchant Warehouse style processor fee markup', confidence: 0.90 },
            { pattern: /ACQR?\s*PROCESSOR/i, note: '‚ö†Ô∏è Acquirer processor fee - controllable markup', confidence: 0.85 },
            { pattern: /REGULATORY.*COMPLIANCE/i, note: '‚ö†Ô∏è NOT actual regulation - processor markup disguised as compliance', confidence: 0.90 },

            // === NEW: 2026 Research Hidden Fee Patterns ===
            // Fiserv Stealth Increases (Sept/Nov 2025)
            { pattern: /NETWORK\s*ACCESS\s*ENHANCEMENT/i, note: '‚ö†Ô∏è FISERV STEALTH INCREASE - Often 0.10% + $0.10/txn hidden in notices', confidence: 0.95 },
            { pattern: /PLATFORM\s*UPGRADE\s*FEE/i, note: '‚ö†Ô∏è Processor infrastructure cost disguised as upgrade', confidence: 0.90 },
            { pattern: /SERVICE\s*ENHANCEMENT\s*FEE/i, note: '‚ö†Ô∏è Hidden fee increase masked as service improvement', confidence: 0.90 },

            // Bundled Rate Opacity Patterns
            { pattern: /BLENDED\s*RATE\s*ADJUSTMENT/i, note: '‚ö†Ô∏è MAJOR RED FLAG - Markup hidden in blended rate changes', confidence: 0.95 },
            { pattern: /TIERED\s*RATE\s*MODIFICATION/i, note: '‚ö†Ô∏è Non-transparent pricing tier adjustment', confidence: 0.90 },

            // Cross-Border Hidden Markups
            { pattern: /INTERNATIONAL\s*PROCESSING\s*SURCHARGE/i, note: '‚ö†Ô∏è Up to 1.5% EXTRA hidden on international transactions', confidence: 0.95 },
            { pattern: /CROSS[\s\-]*BORDER\s*HANDLING/i, note: '‚ö†Ô∏è Processor markup beyond actual card brand fees', confidence: 0.90 },

            // New 2026 Mastercard Hidden Fees
            { pattern: /MOTO\s*DECLINE\s*FEE/i, note: '‚ö†Ô∏è NEW 2026: MC now charges on ALL authorizations including declines', confidence: 0.95 },
            { pattern: /AUTH(ORIZATION)?\s*ATTEMPT\s*FEE/i, note: '‚ö†Ô∏è Fee on authorization attempts, not just approvals', confidence: 0.90 },

            // Capital One/Discover Migration Impact
            { pattern: /NETWORK\s*CONVERSION\s*FEE/i, note: '‚ö†Ô∏è 2026: Capital One debit cards moving to Discover - watch for 20x rate increases', confidence: 0.95 },

            // $35 Chargeback Pattern (Fiserv-style)
            { pattern: /CHARGEBACK\s*ADMIN(ISTRATION)?/i, note: '‚ö†Ô∏è FISERV: $35 chargebacks standard - negotiate down to $15-20', confidence: 0.90 },

            // Generic "Other Fees" Burial
            { pattern: /OTHER\s*FEES?\s*&?\s*CHARGES/i, note: '‚ö†Ô∏è RED FLAG: Multiple charges hidden in "Other" to prevent per-transaction analysis', confidence: 0.95 },
            { pattern: /MISCELLANEOUS\s*PROCESSING/i, note: '‚ö†Ô∏è Vague catch-all for hidden markup', confidence: 0.90 }
        ];

        function categorizeFee(feeName) {
            const upperName = feeName.toUpperCase();

            // Check for hidden fees FIRST
            for (const hidden of HIDDEN_FEE_PATTERNS) {
                if (hidden.pattern.test(upperName)) {
                    return {
                        category: 'CONTROLLABLE',
                        confidence: hidden.confidence,
                        isHidden: true,
                        hiddenInfo: { note: hidden.note }
                    };
                }
            }

            // Check controllable patterns
            for (const ctrl of CONTROLLABLE_PATTERNS) {
                if (ctrl.pattern.test(upperName)) {
                    return {
                        category: 'CONTROLLABLE',
                        confidence: ctrl.confidence,
                        isHidden: false
                    };
                }
            }

            // Check pass-through patterns
            for (const pass of PASSTHROUGH_PATTERNS) {
                if (pass.pattern.test(upperName)) {
                    return {
                        category: 'PASS_THROUGH',
                        confidence: pass.confidence,
                        isHidden: false
                    };
                }
            }

            // Default to review
            return {
                category: 'REVIEW',
                confidence: 0.5,
                isHidden: false
            };
        }

        // ============================================================
        // PRICING MODEL DETECTION
        // ============================================================

        function detectPricingModel(text) {
            const upperText = text.toUpperCase();

            const scores = {
                icPlus: 0,
                tiered: 0,
                flatRate: 0
            };

            // === IC+ INDICATORS (From Statement Analysis) ===
            if (/INTERCHANGE\s*PLUS|IC\+|IC\s*PLUS/i.test(upperText)) scores.icPlus += 3;
            if (/BASIS\s*POINT|BPS|MARKUP/i.test(upperText)) scores.icPlus += 2;
            if (/PASS[\s\-]*THROUGH/i.test(upperText)) scores.icPlus += 2;
            if (/VISA\s*(CREDIT|DEBIT).*INTERCHANGE/i.test(upperText)) scores.icPlus += 1;
            if (/MC\s*(CREDIT|DEBIT).*INTERCHANGE/i.test(upperText)) scores.icPlus += 1;
            // NEW: From Statement Analysis - Strong IC+ indicators
            if (/INTERCHANGE\s*CHARGE/i.test(upperText)) scores.icPlus += 2;
            if (/CPS\s*(RETAIL|RESTAURANT|SUPERMARKET)/i.test(upperText)) scores.icPlus += 2;
            if (/MERIT\s*(I|II|III)/i.test(upperText)) scores.icPlus += 2;
            if (/NABU\s*FEE/i.test(upperText)) scores.icPlus += 1;
            // Multiple interchange categories = IC+ (count occurrences)
            const icCategories = (upperText.match(/CPS|MERIT|WORLD\s*ELITE|REWARDS|SIGNATURE/g) || []).length;
            if (icCategories >= 3) scores.icPlus += 3;

            // === TIERED/BUNDLED INDICATORS (From Statement Analysis) ===
            if (/QUALIFIED|MID[\s\-]*QUAL|NON[\s\-]*QUAL/i.test(upperText)) scores.tiered += 3;
            if (/TIER\s*[123]|TIERED/i.test(upperText)) scores.tiered += 3;
            if (/BUNDLED/i.test(upperText)) scores.tiered += 2;
            if (/RATE\s*(QUALIFIED|STANDARD)/i.test(upperText)) scores.tiered += 2;
            // NEW: From Statement Analysis - Strong Tiered indicators
            if (/DISC\s*(I|II|1|2)\s/i.test(upperText)) scores.tiered += 3;
            if (/SALES\s*DISCOUNT/i.test(upperText)) scores.tiered += 2;
            if (/INTER[\s\-]*CHG\s*ASSESS/i.test(upperText)) scores.tiered += 2; // Opaque bundled line
            if (/NQUAL\s*DISC|NON[\s\-]*QUAL\s*SALES/i.test(upperText)) scores.tiered += 2;
            if (/MID[\s\-]*QUAL\s*SALES/i.test(upperText)) scores.tiered += 2;

            // === FLAT RATE INDICATORS ===
            if (/FLAT\s*RATE|2\.[0-9]+%\s*\+\s*\$0\.[0-9]+/i.test(upperText)) scores.flatRate += 3;
            if (/SQUARE|STRIPE|PAYPAL/i.test(upperText)) scores.flatRate += 2;
            if (/ALL\s*CARDS?\s*(SAME|ONE)\s*RATE/i.test(upperText)) scores.flatRate += 2;

            const maxScore = Math.max(scores.icPlus, scores.tiered, scores.flatRate);

            if (maxScore === 0) {
                currentState.pricingConfidence = 0;
                return 'unknown';
            }

            currentState.pricingConfidence = Math.min(maxScore / 8, 0.95); // Adjusted for more indicators

            if (scores.icPlus === maxScore) return 'icPlus';
            if (scores.tiered === maxScore) return 'tiered';
            return 'flatRate';
        }

        // ============================================================
        // CALCULATIONS
        // ============================================================

        function calculateTotals() {
            currentState.controllableTotal = currentState.fees
                .filter(f => f.category === 'CONTROLLABLE')
                .reduce((sum, f) => sum + f.amount, 0);

            currentState.passThroughTotal = currentState.fees
                .filter(f => f.category === 'PASS_THROUGH')
                .reduce((sum, f) => sum + f.amount, 0);

            if (currentState.totalVolume > 0) {
                currentState.effectiveRate = (currentState.totalFees / currentState.totalVolume * 100);
            }

            // NEW: Calculate fee bucket totals
            currentState.feeBuckets = {
                discRate: 0,
                perTrans: 0,
                perAuth: 0,
                batchFee: 0,
                monthlyFee: 0,
                otherFee: 0,
                passThrough: 0
            };

            for (const fee of currentState.fees) {
                // Pass-through goes to its own bucket regardless of feeType
                if (fee.category === 'PASS_THROUGH') {
                    currentState.feeBuckets.passThrough += fee.amount;
                } else {
                    // Controllable fees go to their specific bucket type
                    switch (fee.feeType) {
                        case 'DISC_RATE':
                            currentState.feeBuckets.discRate += fee.amount;
                            break;
                        case 'PER_TRANS':
                            currentState.feeBuckets.perTrans += fee.amount;
                            break;
                        case 'PER_AUTH':
                            currentState.feeBuckets.perAuth += fee.amount;
                            break;
                        case 'BATCH_FEE':
                            currentState.feeBuckets.batchFee += fee.amount;
                            break;
                        case 'MONTHLY_FEE':
                            currentState.feeBuckets.monthlyFee += fee.amount;
                            break;
                        case 'OTHER_FEE':
                        default:
                            currentState.feeBuckets.otherFee += fee.amount;
                            break;
                    }
                }
            }

            console.log('Fee buckets calculated:', currentState.feeBuckets);

            // NEW: Run advanced analysis
            analyzeCardTypeBreakdown();
            detectDowngrades();
            analyzeDebitRouting();
            generateActionableInsights();

            // NEW: Run anomaly detection
            detectAnomalies();

            // Enable side-by-side comparison
            enableComparisonFromAnalysis();
        }

        // ============================================================
        // EXPECTED INTERCHANGE REFERENCE
        // ============================================================
        // IMPORTANT: Visa & Mastercard update interchange rates every APRIL and OCTOBER.
        // These rates are APPROXIMATE BENCHMARKS from the October 2025 rate cycle.
        // Statements from different periods may reflect different rates.
        //
        // KEY POINT: This does NOT affect savings calculations because:
        // - Pass-through fees are shown as EQUAL for both current processor and GPI
        // - The savings come from CONTROLLABLE fees (markup), not interchange
        // - Interchange rates apply to ALL processors equally
        //
        // These reference rates are used for:
        // - Educational context about interchange categories
        // - Identifying potential downgrades (relative comparison still valid)
        // - General benchmarking (not penny-exact validation)
        // ============================================================

        const INTERCHANGE_RATE_CYCLES = {
            current: 'October 2025',
            next: 'April 2026',
            note: 'Visa & Mastercard update rates every April and October'
        };

        const EXPECTED_INTERCHANGE = {
            // VISA Card-Present Categories
            'CPS_RETAIL': { rate: 1.51, perTxn: 0.10, description: 'Visa CPS Retail Credit' },
            'CPS_RETAIL_DEBIT': { rate: 0.80, perTxn: 0.15, description: 'Visa CPS Retail Debit' },
            'CPS_RESTAURANT': { rate: 1.54, perTxn: 0.10, description: 'Visa CPS Restaurant' },
            'CPS_SUPERMARKET': { rate: 1.22, perTxn: 0.05, description: 'Visa CPS Supermarket' },
            'CPS_SMALL_TICKET': { rate: 1.65, perTxn: 0.04, description: 'Visa CPS Small Ticket' },

            // VISA Card-Not-Present Categories
            'CPS_ECOMMERCE_BASIC': { rate: 1.80, perTxn: 0.10, description: 'Visa CPS E-commerce Basic' },
            'CPS_ECOMMERCE_PREFERRED': { rate: 1.75, perTxn: 0.10, description: 'Visa CPS E-commerce Preferred' },

            // VISA Downgrade Categories (EIRF = Electronic Interchange Reimbursement Fee)
            'EIRF': { rate: 2.30, perTxn: 0.10, description: '‚ö†Ô∏è EIRF DOWNGRADE - Missing data' },
            'STANDARD': { rate: 2.70, perTxn: 0.10, description: '‚ö†Ô∏è STANDARD DOWNGRADE - Worst rate' },

            // VISA Premium Cards
            'SIGNATURE': { rate: 2.10, perTxn: 0.10, description: 'Visa Signature' },
            'SIGNATURE_PREFERRED': { rate: 2.10, perTxn: 0.10, description: 'Visa Signature Preferred' },
            'INFINITE': { rate: 2.20, perTxn: 0.10, description: 'Visa Infinite' },

            // MASTERCARD Categories
            'MC_MERIT_III': { rate: 1.58, perTxn: 0.10, description: 'MC Merit III (Best)' },
            'MC_MERIT_I': { rate: 1.89, perTxn: 0.10, description: 'MC Merit I' },
            'MC_STANDARD': { rate: 2.95, perTxn: 0.10, description: '‚ö†Ô∏è MC Standard DOWNGRADE' },
            'MC_WORLD': { rate: 2.05, perTxn: 0.10, description: 'Mastercard World' },
            'MC_WORLD_ELITE': { rate: 2.30, perTxn: 0.10, description: 'Mastercard World Elite' },

            // REGULATED DEBIT (Durbin Amendment)
            'REGULATED_DEBIT': { rate: 0.05, perTxn: 0.22, description: 'Durbin Regulated Debit Cap' },

            // AMEX
            'AMEX_OPTBLUE': { rate: 2.50, perTxn: 0.10, description: 'Amex OptBlue Avg' },

            // DISCOVER
            'DISCOVER': { rate: 1.87, perTxn: 0.10, description: 'Discover Average' }
        };

        // ============================================================
        // CARD-TYPE RATE DECOMPOSITION
        // ============================================================

        function analyzeCardTypeBreakdown() {
            // Reset breakdown
            const breakdown = {
                visa: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] },
                mastercard: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] },
                discover: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] },
                amex: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] },
                debit: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] },
                other: { volume: 0, fees: 0, rate: 0, transactions: 0, categories: [] }
            };

            // Analyze each fee for card type
            for (const fee of currentState.fees) {
                const name = fee.name.toUpperCase();

                if (/VISA|VS\s|CPS|EIRF/.test(name) && !/DISCOVER/.test(name)) {
                    breakdown.visa.fees += fee.amount;
                    breakdown.visa.categories.push(fee.name);
                } else if (/MASTERCARD|MC\s|MERIT/.test(name)) {
                    breakdown.mastercard.fees += fee.amount;
                    breakdown.mastercard.categories.push(fee.name);
                } else if (/DISCOVER|DISC\s/.test(name)) {
                    breakdown.discover.fees += fee.amount;
                    breakdown.discover.categories.push(fee.name);
                } else if (/AMEX|AMERICAN\s*EXPRESS/.test(name)) {
                    breakdown.amex.fees += fee.amount;
                    breakdown.amex.categories.push(fee.name);
                } else if (/DEBIT|PIN|REGULATED|DURBIN/.test(name)) {
                    breakdown.debit.fees += fee.amount;
                    breakdown.debit.categories.push(fee.name);
                } else {
                    breakdown.other.fees += fee.amount;
                    breakdown.other.categories.push(fee.name);
                }
            }

            // Estimate volumes based on fee distribution (if no explicit volume data)
            const totalInterchangeFees = breakdown.visa.fees + breakdown.mastercard.fees +
                                         breakdown.discover.fees + breakdown.amex.fees + breakdown.debit.fees;

            if (totalInterchangeFees > 0 && currentState.totalVolume > 0) {
                // Estimate volume proportionally
                for (const brand of ['visa', 'mastercard', 'discover', 'amex', 'debit']) {
                    if (breakdown[brand].fees > 0) {
                        const proportion = breakdown[brand].fees / totalInterchangeFees;
                        breakdown[brand].volume = currentState.totalVolume * proportion;
                        breakdown[brand].rate = (breakdown[brand].fees / breakdown[brand].volume * 100);
                    }
                }
            }

            currentState.cardTypeBreakdown = breakdown;
        }

        // ============================================================
        // DOWNGRADE DETECTION ENGINE
        // ============================================================

        const DOWNGRADE_PATTERNS = [
            { pattern: /EIRF/i, severity: 'HIGH', note: 'EIRF = Electronic Interchange Reimbursement Fee. Transactions failed qualification. Common causes: missing AVS, late settlement, keyed entry without CVV.', extraCost: '0.50-0.80%' },
            { pattern: /STANDARD\s*(CREDIT|INTERCHANGE)?/i, severity: 'CRITICAL', note: 'STANDARD = Worst possible rate! Transaction completely failed to qualify. Usually 2.70%+', extraCost: '1.00-1.50%' },
            { pattern: /NON[\s\-]*QUAL(IFIED)?/i, severity: 'HIGH', note: 'Non-Qualified tier on tiered pricing = highest rate tier. Often 3.00%+', extraCost: '0.75-1.25%' },
            { pattern: /MID[\s\-]*QUAL(IFIED)?/i, severity: 'MEDIUM', note: 'Mid-Qualified = partial downgrade. Missing some data elements.', extraCost: '0.30-0.75%' },
            { pattern: /MC\s*STANDARD|MASTERCARD\s*STANDARD/i, severity: 'CRITICAL', note: 'Mastercard Standard = worst MC rate (2.95%+)', extraCost: '1.00-1.50%' },
            { pattern: /MERIT\s*I(?!\s*I)/i, severity: 'MEDIUM', note: 'Merit I = lower tier than Merit III. May be missing data.', extraCost: '0.20-0.40%' },
            { pattern: /COMMERCIAL\s*STANDARD/i, severity: 'HIGH', note: 'Commercial card without Level 2/3 data = missed discount opportunity', extraCost: '0.50-1.00%' },
            { pattern: /KEY[\s\-]*ENTERED/i, severity: 'MEDIUM', note: 'Key-entered transactions cost more than swiped/dipped/tapped', extraCost: '0.20-0.50%' }
        ];

        function detectDowngrades() {
            const downgrades = [];
            let downgradeTotal = 0;

            for (const fee of currentState.fees) {
                const name = fee.name.toUpperCase();

                for (const pattern of DOWNGRADE_PATTERNS) {
                    if (pattern.pattern.test(name)) {
                        downgrades.push({
                            feeName: fee.name,
                            feeAmount: fee.amount,
                            severity: pattern.severity,
                            note: pattern.note,
                            extraCost: pattern.extraCost
                        });
                        downgradeTotal += fee.amount;
                        break; // Only match first pattern per fee
                    }
                }
            }

            currentState.downgrades = downgrades;
            currentState.downgradeTotal = downgradeTotal;
        }

        // ============================================================
        // DEBIT ROUTING ANALYSIS
        // ============================================================

        function analyzeDebitRouting() {
            const analysis = {
                regulated: 0,
                nonRegulated: 0,
                pinDebit: 0,
                signatureDebit: 0,
                potentialSavings: 0,
                recommendations: []
            };

            for (const fee of currentState.fees) {
                const name = fee.name.toUpperCase();

                if (/REGULATED|DURBIN|REG\s*DEBIT/.test(name)) {
                    analysis.regulated += fee.amount;
                }
                if (/NON[\s\-]*REGULATED|EXEMPT/.test(name)) {
                    analysis.nonRegulated += fee.amount;
                }
                if (/PIN\s*DEBIT|PIN[\s\-]*BASED/.test(name)) {
                    analysis.pinDebit += fee.amount;
                }
                if (/SIGNATURE\s*DEBIT|SIG\s*DEBIT/.test(name)) {
                    analysis.signatureDebit += fee.amount;
                }
            }

            // Calculate potential savings from optimizing debit routing
            // Signature debit typically costs more than PIN debit
            if (analysis.signatureDebit > analysis.pinDebit && analysis.signatureDebit > 0) {
                analysis.potentialSavings = analysis.signatureDebit * 0.20; // ~20% savings potential
                analysis.recommendations.push('Consider enabling PIN debit routing for lower interchange rates');
            }

            // Check for non-regulated debit (banks >$10B)
            if (analysis.nonRegulated > analysis.regulated && analysis.nonRegulated > 0) {
                analysis.recommendations.push('High non-regulated debit mix - consider dual-routing networks');
            }

            currentState.debitAnalysis = analysis;
        }

        // ============================================================
        // ACTIONABLE INSIGHTS ENGINE
        // ============================================================

        function generateActionableInsights() {
            const insights = [];

            // Insight 1: Hidden fees detected
            if (currentState.hiddenFees.length > 0) {
                const hiddenTotal = currentState.hiddenFees.reduce((sum, f) => sum + f.amount, 0);
                insights.push({
                    type: 'CRITICAL',
                    icon: 'üö®',
                    title: `${currentState.hiddenFees.length} Hidden Markup Fees Detected`,
                    detail: `$${hiddenTotal.toFixed(2)}/month ($${(hiddenTotal * 12).toFixed(2)}/year) in fees disguised as pass-through costs.`,
                    action: 'Request itemized breakdown and challenge these fees in negotiation.'
                });
            }

            // Insight 2: Downgrades detected
            if (currentState.downgrades.length > 0) {
                const criticalDowngrades = currentState.downgrades.filter(d => d.severity === 'CRITICAL').length;
                insights.push({
                    type: criticalDowngrades > 0 ? 'CRITICAL' : 'WARNING',
                    icon: '‚ö†Ô∏è',
                    title: `${currentState.downgrades.length} Interchange Downgrades Detected`,
                    detail: `Downgraded transactions are costing extra. ${criticalDowngrades} are at worst-case rates.`,
                    action: 'Review settlement timing, ensure AVS/CVV data is captured, consider Level 2/3 for B2B.'
                });
            }

            // Insight 3: High effective rate
            const industryAvg = 2.35;
            if (currentState.effectiveRate > industryAvg + 0.50) {
                insights.push({
                    type: 'WARNING',
                    icon: 'üìä',
                    title: 'Effective Rate Above Industry Average',
                    detail: `Current rate ${currentState.effectiveRate.toFixed(2)}% vs industry avg ${industryAvg}% (${(currentState.effectiveRate - industryAvg).toFixed(2)}% higher).`,
                    action: 'Review pricing model - consider switching to Interchange Plus if on tiered pricing.'
                });
            }

            // Insight 4: Controllable fees high
            const avgControllable = currentState.totalVolume * 0.0025; // 25 bps average
            if (currentState.controllableTotal > avgControllable * 1.5) {
                insights.push({
                    type: 'WARNING',
                    icon: 'üí∞',
                    title: 'Controllable Fees Above Average',
                    detail: `$${currentState.controllableTotal.toFixed(2)} in negotiable fees vs $${avgControllable.toFixed(2)} industry average.`,
                    action: 'GPI competitive pricing can significantly reduce these costs.'
                });
            }

            // Insight 5: Tiered pricing detected
            if (currentState.pricingModel === 'tiered') {
                insights.push({
                    type: 'OPPORTUNITY',
                    icon: 'üí°',
                    title: 'Tiered Pricing Model Detected',
                    detail: 'Tiered pricing bundles transactions into rate tiers, often resulting in higher costs.',
                    action: 'Switch to Interchange Plus pricing for transparency and typically 0.25-0.75% savings.'
                });
            }

            // Insight 6: Card type optimization
            const breakdown = currentState.cardTypeBreakdown;
            if (breakdown.amex.fees > 0 && breakdown.amex.rate > 3.0) {
                insights.push({
                    type: 'INFO',
                    icon: 'üí≥',
                    title: 'Amex Rate Optimization Available',
                    detail: `Amex effective rate of ${breakdown.amex.rate.toFixed(2)}% detected.`,
                    action: 'Consider Amex OptBlue program for potentially lower rates on Amex transactions.'
                });
            }

            // Insight 7: Debit routing opportunity
            if (currentState.debitAnalysis.potentialSavings > 50) {
                insights.push({
                    type: 'OPPORTUNITY',
                    icon: 'üè¶',
                    title: 'Debit Routing Optimization Available',
                    detail: `Potential savings of $${currentState.debitAnalysis.potentialSavings.toFixed(2)}/month through optimized debit routing.`,
                    action: 'Enable PIN debit and dual-routing networks (STAR, Pulse, NYCE) for lower rates.'
                });
            }

            // Insight 8: PCI compliance status
            const pciNonCompliance = currentState.fees.find(f => /NON[\s\-]*COMPLIANCE/i.test(f.name));
            if (pciNonCompliance) {
                insights.push({
                    type: 'CRITICAL',
                    icon: 'üîí',
                    title: 'PCI Non-Compliance Fee Detected',
                    detail: `$${pciNonCompliance.amount.toFixed(2)}/month penalty for PCI non-compliance.`,
                    action: 'Complete PCI SAQ questionnaire immediately to eliminate this fee.'
                });
            }

            currentState.insights = insights;
        }

        // ============================================================
        // UI UPDATES
        // ============================================================

        function updateSavingsDisplay() {
            const hero = document.getElementById('savingsHero');
            hero.classList.remove('hidden');

            document.getElementById('savingsAmount').textContent =
                '$' + currentState.controllableTotal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            document.getElementById('savingsAnnual').textContent =
                '$' + (currentState.controllableTotal * 12).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            const avgConfidence = currentState.fees.length > 0
                ? currentState.fees.reduce((sum, f) => sum + f.confidence, 0) / currentState.fees.length
                : 0;

            document.getElementById('savingsConfidence').textContent =
                Math.round(avgConfidence * 100) + '%';
        }

        function updateQuickStats() {
            document.getElementById('quickStats').classList.remove('hidden');

            document.getElementById('statVolume').textContent =
                '$' + currentState.totalVolume.toLocaleString('en-US', { minimumFractionDigits: 0 });

            document.getElementById('statFees').textContent =
                '$' + currentState.totalFees.toLocaleString('en-US', { minimumFractionDigits: 2 });

            document.getElementById('statEffRate').textContent =
                currentState.effectiveRate.toFixed(2) + '%';

            document.getElementById('statControllable').textContent =
                '$' + currentState.controllableTotal.toLocaleString('en-US', { minimumFractionDigits: 2 });

            document.getElementById('statPassThrough').textContent =
                '$' + currentState.passThroughTotal.toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Note: Hidden fees count is updated in detectHiddenFees() to ensure proper timing

            // NEW: Update fee bucket display
            updateFeeBucketDisplay();
        }

        function updateFeeBucketDisplay() {
            const buckets = currentState.feeBuckets || {};
            const format = (val) => '$' + (val || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Update individual bucket displays
            const bucketDiscRate = document.getElementById('bucketDiscRate');
            const bucketPerTrans = document.getElementById('bucketPerTrans');
            const bucketPerAuth = document.getElementById('bucketPerAuth');
            const bucketBatchFee = document.getElementById('bucketBatchFee');
            const bucketMonthlyFee = document.getElementById('bucketMonthlyFee');
            const bucketOtherFee = document.getElementById('bucketOtherFee');
            const bucketPassThrough = document.getElementById('bucketPassThrough');

            if (bucketDiscRate) bucketDiscRate.textContent = format(buckets.discRate);
            if (bucketPerTrans) bucketPerTrans.textContent = format(buckets.perTrans);
            if (bucketPerAuth) bucketPerAuth.textContent = format(buckets.perAuth);
            if (bucketBatchFee) bucketBatchFee.textContent = format(buckets.batchFee);
            if (bucketMonthlyFee) bucketMonthlyFee.textContent = format(buckets.monthlyFee);
            if (bucketOtherFee) bucketOtherFee.textContent = format(buckets.otherFee);
            if (bucketPassThrough) bucketPassThrough.textContent = format(buckets.passThrough);

            // Calculate totals
            const totalControllable = (buckets.discRate || 0) + (buckets.perTrans || 0) + (buckets.perAuth || 0) +
                                       (buckets.batchFee || 0) + (buckets.monthlyFee || 0) + (buckets.otherFee || 0);

            const bucketTotalControllable = document.getElementById('bucketTotalControllable');
            const bucketTotalPassThrough = document.getElementById('bucketTotalPassThrough');

            if (bucketTotalControllable) bucketTotalControllable.textContent = format(totalControllable);
            if (bucketTotalPassThrough) bucketTotalPassThrough.textContent = format(buckets.passThrough);
        }

        function renderFeeTable() {
            const tbody = document.getElementById('feeTableBody');
            tbody.innerHTML = '';

            for (let i = 0; i < currentState.fees.length; i++) {
                const fee = currentState.fees[i];
                const rowClass = fee.isHiddenFee ? 'hidden-fee' :
                    fee.category === 'CONTROLLABLE' ? 'controllable' :
                    fee.category === 'PASS_THROUGH' ? 'passthrough' : 'review';

                const categoryOptions = `
                    <option value="CONTROLLABLE" ${fee.category === 'CONTROLLABLE' ? 'selected' : ''}>‚úÖ Controllable</option>
                    <option value="PASS_THROUGH" ${fee.category === 'PASS_THROUGH' ? 'selected' : ''}>üìã Pass-Through</option>
                    <option value="REVIEW" ${fee.category === 'REVIEW' ? 'selected' : ''}>‚ö†Ô∏è Review</option>
                `;

                tbody.innerHTML += `
                    <tr class="fee-row ${rowClass}">
                        <td>
                            ${fee.isHiddenFee ? 'üö® ' : ''}${fee.name}
                            ${fee.isHiddenFee ? '<br><small style="color: #991b1b;">Hidden fee detected!</small>' : ''}
                        </td>
                        <td><span class="badge badge-info">${fee.category === 'CONTROLLABLE' ? 'Negotiable' : fee.category === 'PASS_THROUGH' ? 'Fixed' : 'Unknown'}</span></td>
                        <td class="text-right"><strong>$${fee.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</strong></td>
                        <td class="text-center">
                            <select class="category-select" data-index="${i}" onchange="updateCategory(${i}, this.value)">
                                ${categoryOptions}
                            </select>
                        </td>
                        <td class="text-center">${getBenchmarkBadge(fee)}</td>
                    </tr>
                `;
            }
        }

        function updateCategory(index, newCategory) {
            currentState.fees[index].category = newCategory;
            currentState.fees[index].confidence = 1.0; // User override

            calculateTotals();
            updateSavingsDisplay();
            updateQuickStats();
            renderFeeTable();
            detectHiddenFees();
            generateCallScript();
        }

        function getBenchmarkBadge(fee) {
            if (fee.isHiddenFee) {
                return '<span class="badge badge-danger">Hidden!</span>';
            }
            if (fee.category === 'CONTROLLABLE') {
                return '<span class="badge badge-success">Savings</span>';
            }
            return '<span class="badge badge-info">Standard</span>';
        }

        function detectHiddenFees() {
            currentState.hiddenFees = currentState.fees.filter(f => f.isHiddenFee);

            const alertDiv = document.getElementById('hiddenFeeAlert');
            const listDiv = document.getElementById('hiddenFeeList');
            const countSpan = document.getElementById('hiddenFeeCount');
            const statHiddenFees = document.getElementById('statHiddenFees');

            // Update the stat card count
            if (statHiddenFees) {
                statHiddenFees.textContent = currentState.hiddenFees.length;
            }

            if (currentState.hiddenFees.length > 0) {
                alertDiv.classList.remove('hidden');
                if (countSpan) countSpan.textContent = currentState.hiddenFees.length;

                // Create collapsible accordions for each hidden fee
                listDiv.innerHTML = currentState.hiddenFees.map((fee, index) => {
                    const units = fee.hiddenInfo?.units || fee.units || '-';
                    const location = fee.hiddenInfo?.location || fee.location || 'See statement';
                    const note = fee.hiddenInfo?.note || 'Controllable markup disguised as pass-through';

                    return `
                    <div class="hidden-fee-accordion" id="hiddenFee${index}">
                        <div class="hidden-fee-header" onclick="toggleHiddenFee(${index})">
                            <span class="fee-name">üö® ${fee.name}</span>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span class="fee-amount">$${fee.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="hidden-fee-details">
                            <div class="hidden-fee-detail-row">
                                <span class="label">Amount:</span>
                                <span>$${fee.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
                            </div>
                            <div class="hidden-fee-detail-row">
                                <span class="label">Units/Qty:</span>
                                <span>${units}</span>
                            </div>
                            <div class="hidden-fee-detail-row">
                                <span class="label">Reference:</span>
                                <span>${location}</span>
                            </div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #fca5a5; font-size: 0.8rem; color: #7f1d1d;">
                                üí° ${note}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            } else {
                alertDiv.classList.add('hidden');
            }
        }

        function toggleHiddenFee(index) {
            const accordion = document.getElementById('hiddenFee' + index);
            if (accordion) {
                accordion.classList.toggle('expanded');
            }
        }

        // ============================================================
        // CALL SCRIPT GENERATOR
        // ============================================================

        function generateCallScript() {
            const content = document.getElementById('callScriptContent');

            if (currentState.fees.length === 0) {
                content.innerHTML = '<div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>Analyze a statement first to generate a customized call script.</div></div>';
                return;
            }

            const hiddenFeesText = currentState.hiddenFees.length > 0
                ? `I found <span class="script-highlight">${currentState.hiddenFees.length} hidden fees</span> that look like pass-through costs but are actually markup.`
                : '';

            const topControllable = currentState.fees
                .filter(f => f.category === 'CONTROLLABLE')
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 3);

            const topFeesText = topControllable.map(f =>
                `<span class="script-highlight">${f.name}: $${f.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>`
            ).join(', ');

            content.innerHTML = `
                <div class="script-section">
                    <h5>üëã Opening</h5>
                    <p class="script-text">
                        "Hi ${currentState.merchantName ? currentState.merchantName : '[Merchant Name]'}, this is [Your Name] with GPI.
                        I've completed a detailed analysis of your current processing statement and found some interesting opportunities
                        I'd like to share with you."
                    </p>
                </div>

                <div class="script-section">
                    <h5>üí∞ The Hook</h5>
                    <p class="script-text">
                        "Based on my analysis, you're currently paying <span class="script-highlight">$${currentState.controllableTotal.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
                        in controllable fees - these are fees that can be negotiated and reduced.
                        ${hiddenFeesText}
                        Your effective rate is <span class="script-highlight">${currentState.effectiveRate.toFixed(2)}%</span>."
                    </p>
                </div>

                <div class="script-section">
                    <h5>üîç Specifics</h5>
                    <p class="script-text">
                        "Looking at your top controllable fees: ${topFeesText || 'various processing fees'}.
                        ${currentState.hiddenFees.length > 0 ?
                            `The hidden fees I mentioned - like ${currentState.hiddenFees[0].name} - are often disguised as network costs but are actually processor markup that we can eliminate.`
                            : ''}
                    </p>
                </div>

                <div class="script-section">
                    <h5>üéØ The Ask</h5>
                    <p class="script-text">
                        "With GPI's transparent IC+ pricing, we can reduce your controllable fees significantly.
                        Based on your volume of <span class="script-highlight">$${currentState.totalVolume.toLocaleString('en-US', { minimumFractionDigits: 0 })}</span>,
                        you could potentially save <span class="script-highlight">$${(currentState.controllableTotal * 0.5).toLocaleString('en-US', { minimumFractionDigits: 0 })}</span>
                        or more per month. Can I put together a formal proposal for you?"
                    </p>
                </div>

                <div class="script-section">
                    <h5>ü§î Objection Handlers</h5>
                    <p class="script-text">
                        <strong>"I'm happy with my current processor"</strong><br>
                        "I understand, and I'm not asking you to change right now. But knowing you're potentially overpaying by
                        $${(currentState.controllableTotal * 12).toLocaleString('en-US', { minimumFractionDigits: 0 })} per year - wouldn't you want to at least see the comparison?"
                        <br><br>
                        <strong>"I just signed a new contract"</strong><br>
                        "No problem - let's document these savings now so when your contract is up, you have the analysis ready.
                        Some contracts also have exit clauses if we can prove the savings."
                    </p>
                </div>
            `;
        }

        // ============================================================
        // COMPREHENSIVE BENCHMARKS (Nilson Report 2024 + Industry Research)
        // Source: COMPREHENSIVE_RESEARCH_COMPILATION.md
        // ============================================================

        // NILSON REPORT 2024 DATA - U.S. Merchant Processing Market
        const NILSON_BENCHMARKS = {
            totalMarketFees: 187.20, // Billion USD
            totalCardVolume: 11903, // Billion USD
            weightedAvgMDR: 1.57, // Weighted Average Merchant Discount Rate
            perHundredDollars: 1.57, // Fees per $100 in card payments
            networkShares: {
                visa: 61.1,
                mastercard: 25.8,
                amex: 11.1,
                discover: 2.0
            }
        };

        // INDUSTRY-SPECIFIC EFFECTIVE RATE BENCHMARKS (Research-Validated)
        const INDUSTRY_BENCHMARKS = {
            retail_cp: { good: 2.00, average: 2.25, poor: 2.75 },
            restaurant: { good: 2.20, average: 2.45, poor: 3.00 },
            ecommerce: { good: 2.50, average: 2.75, poor: 3.25 },
            b2b: { good: 1.80, average: 2.05, poor: 2.50 },
            supermarket: { good: 1.50, average: 1.75, poor: 2.00 },
            utilities: { good: 1.70, average: 1.95, poor: 2.20 },
            travel: { good: 2.40, average: 2.65, poor: 3.10 },
            general: { good: 2.00, average: 2.35, poor: 2.85 }
        };

        // MCC (Merchant Category Code) Database - Common Categories
        const MCC_DATABASE = [
            // Restaurants & Food Service
            { code: '5812', name: 'Restaurants', category: 'restaurant', keywords: ['dining', 'food', 'cafe', 'bistro', 'eatery'] },
            { code: '5813', name: 'Bars, Cocktail Lounges, Nightclubs', category: 'restaurant', keywords: ['bar', 'pub', 'tavern', 'lounge'] },
            { code: '5814', name: 'Fast Food Restaurants', category: 'restaurant', keywords: ['fast food', 'quick service', 'qsr', 'drive-thru'] },
            { code: '5811', name: 'Caterers', category: 'restaurant', keywords: ['catering', 'event food'] },

            // Retail - General
            { code: '5311', name: 'Department Stores', category: 'retail_cp', keywords: ['department', 'retail', 'store'] },
            { code: '5331', name: 'Variety Stores', category: 'retail_cp', keywords: ['variety', 'dollar', 'discount'] },
            { code: '5399', name: 'General Merchandise', category: 'retail_cp', keywords: ['general', 'merchandise', 'retail'] },
            { code: '5310', name: 'Discount Stores', category: 'retail_cp', keywords: ['discount', 'warehouse', 'club'] },

            // Supermarkets & Grocery
            { code: '5411', name: 'Grocery Stores, Supermarkets', category: 'supermarket', keywords: ['grocery', 'supermarket', 'food store', 'market'] },
            { code: '5422', name: 'Freezer/Meat Lockers', category: 'supermarket', keywords: ['meat', 'butcher', 'freezer'] },
            { code: '5441', name: 'Candy, Nut, Confectionery', category: 'retail_cp', keywords: ['candy', 'sweets', 'confectionery'] },
            { code: '5451', name: 'Dairy Products', category: 'supermarket', keywords: ['dairy', 'milk', 'cheese'] },
            { code: '5462', name: 'Bakeries', category: 'retail_cp', keywords: ['bakery', 'bread', 'pastry'] },

            // Gas Stations & Auto
            { code: '5541', name: 'Service Stations (Gas)', category: 'retail_cp', keywords: ['gas', 'fuel', 'petrol', 'service station'] },
            { code: '5542', name: 'Automated Fuel Dispensers', category: 'retail_cp', keywords: ['gas pump', 'pay at pump', 'automated fuel'] },
            { code: '5511', name: 'Auto Dealers (New/Used)', category: 'retail_cp', keywords: ['car dealer', 'auto dealer', 'vehicle sales'] },
            { code: '5521', name: 'Auto Dealers (Used Only)', category: 'retail_cp', keywords: ['used car', 'pre-owned'] },
            { code: '5531', name: 'Auto Parts & Accessories', category: 'retail_cp', keywords: ['auto parts', 'car parts', 'accessories'] },
            { code: '5533', name: 'Auto Parts Stores', category: 'retail_cp', keywords: ['parts store', 'autozone', 'oreilly'] },
            { code: '7538', name: 'Auto Service Shops', category: 'retail_cp', keywords: ['mechanic', 'auto repair', 'garage'] },

            // Healthcare & Medical
            { code: '8011', name: 'Doctors, Physicians', category: 'b2b', keywords: ['doctor', 'physician', 'medical', 'healthcare'] },
            { code: '8021', name: 'Dentists', category: 'b2b', keywords: ['dentist', 'dental', 'orthodontist'] },
            { code: '8031', name: 'Osteopaths', category: 'b2b', keywords: ['osteopath', 'chiropractor'] },
            { code: '8041', name: 'Chiropractors', category: 'b2b', keywords: ['chiropractic', 'spine'] },
            { code: '8042', name: 'Optometrists, Ophthalmologists', category: 'b2b', keywords: ['eye doctor', 'optometrist', 'vision'] },
            { code: '8049', name: 'Podiatrists', category: 'b2b', keywords: ['podiatrist', 'foot doctor'] },
            { code: '8050', name: 'Nursing/Personal Care Facilities', category: 'b2b', keywords: ['nursing home', 'care facility', 'assisted living'] },
            { code: '8062', name: 'Hospitals', category: 'b2b', keywords: ['hospital', 'medical center'] },
            { code: '5912', name: 'Drug Stores, Pharmacies', category: 'retail_cp', keywords: ['pharmacy', 'drugstore', 'cvs', 'walgreens'] },

            // Professional Services
            { code: '8111', name: 'Legal Services', category: 'b2b', keywords: ['lawyer', 'attorney', 'legal', 'law firm'] },
            { code: '8931', name: 'Accounting, Bookkeeping', category: 'b2b', keywords: ['accountant', 'cpa', 'bookkeeper', 'tax'] },
            { code: '8999', name: 'Professional Services', category: 'b2b', keywords: ['professional', 'consultant', 'business services'] },
            { code: '7392', name: 'Management Consulting', category: 'b2b', keywords: ['consulting', 'management', 'advisory'] },

            // E-commerce & Online
            { code: '5964', name: 'Direct Marketing - Catalog', category: 'ecommerce', keywords: ['catalog', 'mail order', 'direct marketing'] },
            { code: '5965', name: 'Direct Marketing - Combo', category: 'ecommerce', keywords: ['direct marketing', 'combination'] },
            { code: '5966', name: 'Direct Marketing - Outbound', category: 'ecommerce', keywords: ['outbound', 'telemarketing'] },
            { code: '5967', name: 'Direct Marketing - Inbound', category: 'ecommerce', keywords: ['inbound', 'call center'] },
            { code: '5968', name: 'Direct Marketing - Subscription', category: 'ecommerce', keywords: ['subscription', 'recurring', 'membership'] },
            { code: '5969', name: 'Direct Marketing - Other', category: 'ecommerce', keywords: ['ecommerce', 'online store', 'web store'] },

            // Travel & Hospitality
            { code: '3501', name: 'Hotels, Motels, Resorts', category: 'travel', keywords: ['hotel', 'motel', 'resort', 'lodging', 'inn'] },
            { code: '7011', name: 'Lodging - Hotels, Motels', category: 'travel', keywords: ['lodging', 'accommodation', 'stay'] },
            { code: '4511', name: 'Airlines', category: 'travel', keywords: ['airline', 'air travel', 'flight'] },
            { code: '4722', name: 'Travel Agencies', category: 'travel', keywords: ['travel agency', 'tour', 'vacation'] },
            { code: '7512', name: 'Car Rental', category: 'travel', keywords: ['car rental', 'auto rental', 'rent a car'] },

            // Utilities & Telecom
            { code: '4812', name: 'Telecom Equipment', category: 'utilities', keywords: ['telecom', 'phone', 'communication'] },
            { code: '4814', name: 'Telecom Services', category: 'utilities', keywords: ['phone service', 'telecom', 'mobile'] },
            { code: '4816', name: 'Computer Network Services', category: 'utilities', keywords: ['internet', 'network', 'isp'] },
            { code: '4900', name: 'Utilities - Electric, Gas, Water', category: 'utilities', keywords: ['utility', 'electric', 'gas', 'water', 'power'] },

            // Construction & Contractors
            { code: '1520', name: 'General Contractors - Residential', category: 'b2b', keywords: ['contractor', 'construction', 'builder', 'home builder'] },
            { code: '1711', name: 'HVAC Contractors', category: 'b2b', keywords: ['hvac', 'heating', 'cooling', 'air conditioning'] },
            { code: '1731', name: 'Electrical Contractors', category: 'b2b', keywords: ['electrician', 'electrical', 'wiring'] },
            { code: '1740', name: 'Masonry, Stonework', category: 'b2b', keywords: ['mason', 'stonework', 'brick'] },
            { code: '1750', name: 'Carpentry Contractors', category: 'b2b', keywords: ['carpenter', 'carpentry', 'woodwork'] },
            { code: '1761', name: 'Roofing/Siding Contractors', category: 'b2b', keywords: ['roofing', 'siding', 'roof'] },
            { code: '1771', name: 'Concrete Contractors', category: 'b2b', keywords: ['concrete', 'cement', 'paving'] },

            // Personal Services
            { code: '7230', name: 'Beauty/Barber Shops', category: 'retail_cp', keywords: ['salon', 'barber', 'beauty', 'hair', 'spa'] },
            { code: '7298', name: 'Health & Beauty Spas', category: 'retail_cp', keywords: ['spa', 'wellness', 'massage'] },
            { code: '7941', name: 'Sports Clubs/Fields', category: 'retail_cp', keywords: ['gym', 'fitness', 'sports', 'athletic'] },
            { code: '7997', name: 'Membership Clubs', category: 'retail_cp', keywords: ['club', 'membership', 'country club'] },
            { code: '7299', name: 'Miscellaneous Recreation Services', category: 'retail_cp', keywords: ['recreation', 'entertainment', 'leisure'] },

            // Education
            { code: '8211', name: 'Elementary/Secondary Schools', category: 'b2b', keywords: ['school', 'education', 'k-12'] },
            { code: '8220', name: 'Colleges, Universities', category: 'b2b', keywords: ['college', 'university', 'higher education'] },
            { code: '8299', name: 'Schools, Educational Services', category: 'b2b', keywords: ['training', 'educational', 'learning'] },

            // Non-Profit & Government
            { code: '8398', name: 'Charitable Organizations', category: 'b2b', keywords: ['charity', 'nonprofit', 'non-profit', 'donation'] },
            { code: '8641', name: 'Civic, Social, Fraternal', category: 'b2b', keywords: ['civic', 'social', 'fraternal', 'organization'] },
            { code: '9211', name: 'Court Costs', category: 'b2b', keywords: ['court', 'legal fees', 'government'] },
            { code: '9311', name: 'Tax Payments', category: 'b2b', keywords: ['tax', 'government', 'irs'] },
            { code: '9399', name: 'Government Services', category: 'b2b', keywords: ['government', 'municipal', 'city', 'state'] },

            // Wholesale & B2B
            { code: '5013', name: 'Motor Vehicle Supplies', category: 'b2b', keywords: ['wholesale', 'auto supply', 'vehicle parts'] },
            { code: '5021', name: 'Office/Commercial Furniture', category: 'b2b', keywords: ['furniture', 'office', 'commercial'] },
            { code: '5039', name: 'Construction Materials', category: 'b2b', keywords: ['lumber', 'building materials', 'construction supply'] },
            { code: '5044', name: 'Office Equipment', category: 'b2b', keywords: ['office equipment', 'copier', 'printer'] },
            { code: '5045', name: 'Computers, Software', category: 'b2b', keywords: ['computer', 'software', 'it', 'technology'] },
            { code: '5046', name: 'Commercial Equipment', category: 'b2b', keywords: ['commercial', 'equipment', 'industrial'] },
            { code: '5047', name: 'Medical Equipment', category: 'b2b', keywords: ['medical equipment', 'healthcare supply'] },
            { code: '5065', name: 'Electrical Parts', category: 'b2b', keywords: ['electrical', 'parts', 'wholesale'] },
            { code: '5072', name: 'Hardware Equipment', category: 'b2b', keywords: ['hardware', 'tools', 'wholesale'] },
            { code: '5085', name: 'Industrial Supplies', category: 'b2b', keywords: ['industrial', 'supply', 'manufacturing'] },
            { code: '5099', name: 'Durable Goods', category: 'b2b', keywords: ['durable', 'goods', 'wholesale'] },

            // Specialty Retail
            { code: '5611', name: 'Men\'s Clothing', category: 'retail_cp', keywords: ['mens', 'clothing', 'apparel', 'suits'] },
            { code: '5621', name: 'Women\'s Clothing', category: 'retail_cp', keywords: ['womens', 'clothing', 'fashion', 'boutique'] },
            { code: '5631', name: 'Women\'s Accessories', category: 'retail_cp', keywords: ['accessories', 'handbag', 'jewelry'] },
            { code: '5641', name: 'Children\'s Clothing', category: 'retail_cp', keywords: ['kids', 'children', 'baby', 'clothing'] },
            { code: '5651', name: 'Family Clothing', category: 'retail_cp', keywords: ['family', 'clothing', 'apparel'] },
            { code: '5661', name: 'Shoe Stores', category: 'retail_cp', keywords: ['shoes', 'footwear', 'boots'] },
            { code: '5699', name: 'Misc Apparel/Accessory', category: 'retail_cp', keywords: ['apparel', 'clothing', 'accessories'] },
            { code: '5712', name: 'Furniture Stores', category: 'retail_cp', keywords: ['furniture', 'home furnishing'] },
            { code: '5713', name: 'Floor Covering', category: 'retail_cp', keywords: ['flooring', 'carpet', 'tile'] },
            { code: '5714', name: 'Drapery/Window Covering', category: 'retail_cp', keywords: ['drapery', 'curtains', 'blinds', 'window'] },
            { code: '5719', name: 'Misc Home Furnishing', category: 'retail_cp', keywords: ['home', 'decor', 'furnishing'] },
            { code: '5722', name: 'Household Appliance Stores', category: 'retail_cp', keywords: ['appliance', 'electronics', 'household'] },
            { code: '5732', name: 'Electronics Stores', category: 'retail_cp', keywords: ['electronics', 'computers', 'tech'] },
            { code: '5733', name: 'Music Stores', category: 'retail_cp', keywords: ['music', 'instruments', 'records'] },
            { code: '5734', name: 'Computer Software Stores', category: 'retail_cp', keywords: ['software', 'computer store'] },
            { code: '5735', name: 'Record Stores', category: 'retail_cp', keywords: ['records', 'music', 'vinyl'] },
            { code: '5941', name: 'Sporting Goods', category: 'retail_cp', keywords: ['sports', 'sporting goods', 'athletic'] },
            { code: '5942', name: 'Book Stores', category: 'retail_cp', keywords: ['books', 'bookstore', 'reading'] },
            { code: '5943', name: 'Stationery/Office Supplies', category: 'retail_cp', keywords: ['office supplies', 'stationery', 'staples'] },
            { code: '5944', name: 'Jewelry Stores', category: 'retail_cp', keywords: ['jewelry', 'jeweler', 'watches'] },
            { code: '5945', name: 'Hobby/Toy/Game Shops', category: 'retail_cp', keywords: ['toys', 'games', 'hobby'] },
            { code: '5946', name: 'Camera/Photo Supplies', category: 'retail_cp', keywords: ['camera', 'photo', 'photography'] },
            { code: '5947', name: 'Gift/Card/Novelty Shops', category: 'retail_cp', keywords: ['gifts', 'cards', 'novelty'] },
            { code: '5948', name: 'Luggage/Leather Goods', category: 'retail_cp', keywords: ['luggage', 'leather', 'bags'] },
            { code: '5949', name: 'Sewing/Fabric Stores', category: 'retail_cp', keywords: ['fabric', 'sewing', 'craft'] },
            { code: '5950', name: 'Glassware/Crystal Stores', category: 'retail_cp', keywords: ['glass', 'crystal', 'collectibles'] },
            { code: '5970', name: 'Art Dealers/Galleries', category: 'retail_cp', keywords: ['art', 'gallery', 'artwork'] },
            { code: '5971', name: 'Art/Craft Supplies', category: 'retail_cp', keywords: ['art supplies', 'craft', 'hobby'] },
            { code: '5972', name: 'Stamp/Coin Stores', category: 'retail_cp', keywords: ['stamps', 'coins', 'collectibles'] },
            { code: '5973', name: 'Religious Goods', category: 'retail_cp', keywords: ['religious', 'church', 'spiritual'] },
            { code: '5975', name: 'Hearing Aids', category: 'retail_cp', keywords: ['hearing aid', 'audiology'] },
            { code: '5976', name: 'Orthopedic Goods', category: 'retail_cp', keywords: ['orthopedic', 'medical supply'] },
            { code: '5977', name: 'Cosmetic Stores', category: 'retail_cp', keywords: ['cosmetics', 'beauty', 'makeup'] },
            { code: '5978', name: 'Typewriter Stores', category: 'retail_cp', keywords: ['typewriter', 'office'] },
            { code: '5983', name: 'Fuel Dealers', category: 'retail_cp', keywords: ['fuel', 'oil', 'heating'] },
            { code: '5992', name: 'Florists', category: 'retail_cp', keywords: ['florist', 'flowers', 'floral'] },
            { code: '5993', name: 'Cigar Stores', category: 'retail_cp', keywords: ['cigar', 'tobacco', 'smoke shop'] },
            { code: '5994', name: 'News Dealers', category: 'retail_cp', keywords: ['news', 'magazine', 'newsstand'] },
            { code: '5995', name: 'Pet Shops', category: 'retail_cp', keywords: ['pet', 'pet store', 'animals'] },
            { code: '5996', name: 'Swimming Pools', category: 'retail_cp', keywords: ['pool', 'swimming', 'spa'] },
            { code: '5997', name: 'Electric Razor Stores', category: 'retail_cp', keywords: ['razor', 'shaving'] },
            { code: '5998', name: 'Tent/Awning Shops', category: 'retail_cp', keywords: ['tent', 'awning', 'outdoor'] },
            { code: '5999', name: 'Miscellaneous Retail', category: 'retail_cp', keywords: ['retail', 'store', 'shop'] }
        ];

        // Selected MCC for benchmarks
        let selectedMcc = null;

        function filterMccOptions(searchTerm) {
            const dropdown = document.getElementById('mccDropdown');
            const searchLower = searchTerm.toLowerCase().trim();

            if (!searchLower) {
                dropdown.innerHTML = '';
                dropdown.classList.remove('show');
                return;
            }

            // Check if it's a numeric search (MCC code)
            const isNumeric = /^\d+$/.test(searchTerm);

            let matches = [];
            if (isNumeric) {
                // Search by MCC code
                matches = MCC_DATABASE.filter(mcc => mcc.code.startsWith(searchTerm));
            } else {
                // Search by name or keywords
                matches = MCC_DATABASE.filter(mcc => {
                    const nameMatch = mcc.name.toLowerCase().includes(searchLower);
                    const keywordMatch = mcc.keywords.some(kw => kw.toLowerCase().includes(searchLower));
                    return nameMatch || keywordMatch;
                });
            }

            // Limit results
            matches = matches.slice(0, 15);

            if (matches.length > 0) {
                dropdown.innerHTML = matches.map(mcc => `
                    <div class="mcc-option" onclick="selectMcc('${mcc.code}', '${mcc.name.replace(/'/g, "\\'")}', '${mcc.category}')">
                        <span class="mcc-code">${mcc.code}</span> - <span class="mcc-desc">${mcc.name}</span>
                    </div>
                `).join('');
                dropdown.classList.add('show');
            } else {
                dropdown.innerHTML = '<div class="mcc-option" style="color: var(--gray-500);">No matches found</div>';
                dropdown.classList.add('show');
            }
        }

        function showMccDropdown() {
            const searchTerm = document.getElementById('mccSearchInput').value;
            if (searchTerm) {
                filterMccOptions(searchTerm);
            }
        }

        function selectMcc(code, name, category) {
            selectedMcc = { code, name, category };

            document.getElementById('mccSearchInput').value = `${code} - ${name}`;
            document.getElementById('mccDropdown').classList.remove('show');
            document.getElementById('selectedMcc').style.display = 'block';
            document.getElementById('selectedMccText').textContent = `${code} - ${name} (${category.replace('_', ' ')})`;

            // Update state and regenerate benchmarks
            currentState.mccCode = code;
            currentState.mccCategory = category;
            currentState.mccName = name;

            // Regenerate benchmarks with selected MCC
            if (currentState.totalVolume > 0) {
                generateBenchmarks();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.mcc-search-container');
            if (container && !container.contains(e.target)) {
                document.getElementById('mccDropdown').classList.remove('show');
            }
        });

        // VISA FANF (Fixed Acquirer Network Fee) - Complete Tier Structure
        const FANF_TIERS_CNP = [
            { min: 0, max: 199.99, fee: 0, note: 'Exempt' },
            { min: 200, max: 1249.99, feePercent: 0.0015, note: '0.15% of volume' },
            { min: 1250, max: 3999, fee: 7.00, note: 'Flat $7.00' },
            { min: 4000, max: 7999, fee: 9.00, note: 'Flat $9.00' },
            { min: 8000, max: 39999, fee: 15.00, note: 'Flat $15.00' },
            { min: 40000, max: 199999, fee: 45.00, note: 'Flat $45.00' },
            { min: 200000, max: 799999, fee: 160.00, note: 'Flat $160.00' },
            { min: 800000, max: 1999999, fee: 450.00, note: 'Flat $450.00' },
            { min: 2000000, max: 3999999, fee: 1000.00, note: 'Flat $1,000' },
            { min: 4000000, max: 7999999, fee: 2000.00, note: 'Flat $2,000' },
            { min: 8000000, max: 19999999, fee: 4000.00, note: 'Flat $4,000' },
            { min: 20000000, max: 39999999, fee: 8000.00, note: 'Flat $8,000' },
            { min: 40000000, max: 79999999, fee: 16000.00, note: 'Flat $16,000' },
            { min: 80000000, max: Infinity, fee: 45000.00, note: 'Up to $45,000' }
        ];

        // Calculate FANF for CNP merchants
        function calculateFANF(monthlyVolume, isCNP = true) {
            if (!isCNP) {
                // Card-present uses location-based pricing
                return { fee: 2.00, tier: 'Card-Present (per location)', note: '$2.00/month per location + MCC adjustments' };
            }

            for (const tier of FANF_TIERS_CNP) {
                if (monthlyVolume >= tier.min && monthlyVolume <= tier.max) {
                    const fee = tier.feePercent ? monthlyVolume * tier.feePercent : tier.fee;
                    return { fee, tier: `$${tier.min.toLocaleString()} - $${tier.max === Infinity ? '‚àû' : tier.max.toLocaleString()}`, note: tier.note };
                }
            }
            return { fee: 0, tier: 'Unknown', note: '' };
        }

        // Level 2/3 Data Detection
        function detectLevel23Opportunity(text) {
            const upperText = text.toUpperCase();
            const hasB2B = /B2B|BUSINESS|CORPORATE|PURCHASING|COMMERCIAL|FLEET|GOVERNMENT|GSA/i.test(upperText);
            const hasHighTicket = currentState.totalVolume / Math.max(currentState.totalTransactions, 1) > 100;
            const hasLevel3Mention = /LEVEL\s*(2|3|II|III)|ENHANCED\s*DATA|CEDP/i.test(upperText);

            return {
                eligible: hasB2B || hasHighTicket,
                hasLevel3: hasLevel3Mention,
                potentialSavings: hasB2B ? '0.50-1.00%' : '0.30-0.50%',
                recommendation: hasB2B && !hasLevel3Mention ?
                    '‚ö†Ô∏è B2B merchant may qualify for Level 2/3 data discounts - potential 50-100 bps savings!' : null
            };
        }

        function generateBenchmarks() {
            const content = document.getElementById('benchmarkContent');

            if (currentState.fees.length === 0 || currentState.totalVolume === 0) {
                content.innerHTML = '<div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>Analyze a statement and select an MCC to see benchmark comparisons.</div></div>';
                return;
            }

            // Determine industry category from selected MCC or default to general
            const industryCategory = currentState.mccCategory || 'general';
            const industryBenchmark = INDUSTRY_BENCHMARKS[industryCategory] || INDUSTRY_BENCHMARKS.general;
            const industryName = currentState.mccName || 'General Retail';

            // Use industry-specific benchmarks
            const avgEffectiveRate = industryBenchmark.average;
            const competitiveMarkup = currentState.totalVolume * 0.0015; // 15 bps = competitive
            const avgControllable = currentState.totalVolume * 0.0025; // 25 bps = average markup
            const highMarkup = currentState.totalVolume * 0.0040; // 40 bps = high markup territory

            const rateStatus = currentState.effectiveRate < industryBenchmark.good ? 'good' :
                currentState.effectiveRate < industryBenchmark.poor ? 'average' : 'poor';

            const controllableStatus = currentState.controllableTotal < avgControllable ? 'good' :
                currentState.controllableTotal < avgControllable * 1.5 ? 'average' : 'poor';

            // Calculate FANF
            const fanfCalc = calculateFANF(currentState.totalVolume, true);

            // Check Level 2/3 opportunity
            const level23 = detectLevel23Opportunity(currentState.rawText || '');

            // Calculate industry comparison
            const industryComparison = getIndustryComparison();

            // MCC info banner
            const mccBanner = currentState.mccCode ?
                `<div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">üè∑Ô∏è</span>
                        <div>
                            <div style="font-weight: 600; color: #1e40af;">MCC ${currentState.mccCode}: ${currentState.mccName}</div>
                            <div style="font-size: 0.85rem; color: #3b82f6;">Benchmarks: Good &lt;${industryBenchmark.good}% | Avg ${industryBenchmark.average}% | High &gt;${industryBenchmark.poor}%</div>
                        </div>
                    </div>
                </div>` :
                `<div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">üí°</span>
                    <div>Select an MCC above for industry-specific benchmarks. Currently using general retail benchmarks.</div>
                </div>`;

            content.innerHTML = `
                ${mccBanner}
                <div class="benchmark-bar">
                    <div class="benchmark-label">Effective Rate</div>
                    <div class="benchmark-track">
                        <div class="benchmark-fill ${rateStatus}" style="width: ${Math.min(currentState.effectiveRate / 4 * 100, 100)}%">
                            ${currentState.effectiveRate.toFixed(2)}%
                        </div>
                        <div class="benchmark-marker" style="left: ${avgEffectiveRate / 4 * 100}%" title="Industry Avg: ${avgEffectiveRate.toFixed(2)}%"></div>
                    </div>
                </div>

                <div class="benchmark-bar">
                    <div class="benchmark-label">Controllable Fees</div>
                    <div class="benchmark-track">
                        <div class="benchmark-fill ${controllableStatus}" style="width: ${Math.min(currentState.controllableTotal / (avgControllable * 2) * 100, 100)}%">
                            $${currentState.controllableTotal.toLocaleString('en-US', { minimumFractionDigits: 0 })}
                        </div>
                        <div class="benchmark-marker" style="left: ${avgControllable / (avgControllable * 2) * 100}%" title="Avg: $${avgControllable.toFixed(0)}"></div>
                    </div>
                </div>

                <!-- FANF Calculator -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin-bottom: 0.5rem; color: #92400e;">üìä Visa FANF Analysis</h4>
                    <p style="font-size: 0.85rem; color: #78350f;">
                        Based on monthly volume of <strong>$${currentState.totalVolume.toLocaleString()}</strong>:
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: #92400e;">FANF Tier</div>
                            <div style="font-weight: 600;">${fanfCalc.tier}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #92400e;">Expected FANF Fee</div>
                            <div style="font-weight: 700; font-size: 1.2rem;">$${fanfCalc.fee.toFixed(2)}/mo</div>
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: #78350f; margin-top: 0.5rem;">${fanfCalc.note}</p>
                </div>

                ${level23.recommendation ? `
                <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-bottom: 0.5rem; color: #1e40af;">üí° Level 2/3 Data Opportunity</h4>
                    <p style="font-size: 0.85rem; color: #1e3a8a;">${level23.recommendation}</p>
                    <p style="font-size: 0.75rem; color: #3730a3; margin-top: 0.5rem;">
                        Potential savings: <strong>${level23.potentialSavings}</strong> on B2B interchange
                    </p>
                </div>
                ` : ''}

                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                    <p style="font-size: 0.9rem; color: var(--gray-600);">
                        <strong>Legend:</strong>
                        <span style="color: var(--success);">‚ñ† Good</span> |
                        <span style="color: var(--warning);">‚ñ† Average</span> |
                        <span style="color: var(--danger);">‚ñ† High</span>
                        <br>Black line = Industry average (${avgEffectiveRate.toFixed(2)}% per Nilson Report 2024)
                    </p>
                </div>

                <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem;">üìà Market Data (Nilson Report 2024)</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                        <div>Total U.S. Processing Fees: <strong>$${NILSON_BENCHMARKS.totalMarketFees}B</strong></div>
                        <div>Weighted Avg MDR: <strong>${NILSON_BENCHMARKS.weightedAvgMDR}%</strong></div>
                        <div>Card Payment Volume: <strong>$${(NILSON_BENCHMARKS.totalCardVolume / 1000).toFixed(1)}T</strong></div>
                        <div>Fees per $100: <strong>$${NILSON_BENCHMARKS.perHundredDollars}</strong></div>
                    </div>
                </div>

                ${currentState.statementPeriod || currentState.interchangeRateCycle ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <p style="font-size: 0.85rem; color: #1e40af; margin: 0;">
                        <strong>üìÖ Statement Context:</strong>
                        ${currentState.statementPeriod ? `Period: <strong>${currentState.statementPeriod}</strong>` : ''}
                        ${currentState.interchangeRateCycle ? ` ‚Ä¢ Interchange Rate Cycle: <strong>${currentState.interchangeRateCycle}</strong>` : ''}
                        <br><span style="font-size: 0.75rem; color: #3b82f6;">Note: Visa/MC update interchange rates every April and October. Pass-through fees are equal for all processors regardless of rate cycle.</span>
                    </p>
                </div>
                ` : ''}

                <div style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">Summary</h4>
                    <p>
                        This merchant's effective rate is <strong>${currentState.effectiveRate < avgEffectiveRate ? 'below' : 'above'}</strong>
                        the industry average of ${avgEffectiveRate.toFixed(2)}%.
                        ${currentState.effectiveRate > avgEffectiveRate + 0.5 ?
                            ' <span style="color: var(--danger);">‚ö†Ô∏è This indicates significant room for savings!</span>' : ''}
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--gray-600);">
                        Controllable fees represent <strong>${((currentState.controllableTotal / currentState.totalFees) * 100).toFixed(1)}%</strong>
                        of total fees - ${currentState.controllableTotal > avgControllable ?
                            '<span style="color: var(--danger);">above average markup detected!</span>' :
                            '<span style="color: var(--success);">within competitive range</span>'}
                    </p>
                </div>
            `;
        }

        function getIndustryComparison() {
            // Detect industry from statement content
            const text = (currentState.rawText || '').toUpperCase();
            if (/RESTAURANT|FOOD|DINING|BAR/i.test(text)) return INDUSTRY_BENCHMARKS.restaurant;
            if (/E[\s\-]*COMMERCE|ONLINE|WEBSITE|INTERNET/i.test(text)) return INDUSTRY_BENCHMARKS.ecommerce;
            if (/B2B|BUSINESS|CORPORATE|WHOLESALE/i.test(text)) return INDUSTRY_BENCHMARKS.b2b;
            if (/GROCERY|SUPERMARKET|FOOD\s*STORE/i.test(text)) return INDUSTRY_BENCHMARKS.supermarket;
            if (/UTILITY|ELECTRIC|GAS|WATER/i.test(text)) return INDUSTRY_BENCHMARKS.utilities;
            if (/TRAVEL|AIRLINE|HOTEL|LODGING/i.test(text)) return INDUSTRY_BENCHMARKS.travel;
            if (/RETAIL|STORE|SHOP/i.test(text)) return INDUSTRY_BENCHMARKS.retail_cp;
            return INDUSTRY_BENCHMARKS.general;
        }

        // ============================================================
        // INSIGHTS TAB RENDERING
        // ============================================================

        function renderInsights() {
            renderActionableInsights();
            renderCardTypeBreakdown();
            renderDowngradeAnalysis();
            renderDebitRoutingAnalysis();
        }

        function renderActionableInsights() {
            const content = document.getElementById('insightsContent');

            if (currentState.insights.length === 0) {
                content.innerHTML = '<div class="alert alert-success"><span class="alert-icon">‚úÖ</span><div>No critical issues detected. Statement looks healthy!</div></div>';
                return;
            }

            const typeStyles = {
                'CRITICAL': { bg: '#fef2f2', border: '#ef4444', icon: 'üö®' },
                'WARNING': { bg: '#fffbeb', border: '#f59e0b', icon: '‚ö†Ô∏è' },
                'OPPORTUNITY': { bg: '#f0fdf4', border: '#22c55e', icon: 'üí°' },
                'INFO': { bg: '#eff6ff', border: '#3b82f6', icon: '‚ÑπÔ∏è' }
            };

            content.innerHTML = currentState.insights.map(insight => {
                const style = typeStyles[insight.type] || typeStyles['INFO'];
                return `
                    <div style="background: ${style.bg}; border-left: 4px solid ${style.border}; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">${insight.icon}</span>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">${insight.title}</h4>
                                <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #374151;">${insight.detail}</p>
                                <p style="margin: 0; font-size: 0.85rem; color: #059669; font-weight: 500;">
                                    <strong>Action:</strong> ${insight.action}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCardTypeBreakdown() {
            const content = document.getElementById('cardTypeBreakdown');
            const breakdown = currentState.cardTypeBreakdown;

            if (!breakdown || currentState.fees.length === 0) {
                content.innerHTML = '<div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>Analyze a statement first.</div></div>';
                return;
            }

            const brands = [
                { key: 'visa', name: 'Visa', color: '#1a1f71', icon: 'üí≥' },
                { key: 'mastercard', name: 'Mastercard', color: '#eb001b', icon: 'üí≥' },
                { key: 'discover', name: 'Discover', color: '#ff6000', icon: 'üí≥' },
                { key: 'amex', name: 'Amex', color: '#006fcf', icon: 'üí≥' },
                { key: 'debit', name: 'Debit', color: '#16a34a', icon: 'üè¶' }
            ];

            const totalFees = brands.reduce((sum, b) => sum + breakdown[b.key].fees, 0);

            content.innerHTML = `
                <div style="display: grid; gap: 0.75rem;">
                    ${brands.filter(b => breakdown[b.key].fees > 0).map(brand => {
                        const data = breakdown[brand.key];
                        const proportion = totalFees > 0 ? (data.fees / totalFees * 100) : 0;
                        return `
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 8px;">
                                <div style="width: 100px; font-weight: 600; color: ${brand.color};">${brand.icon} ${brand.name}</div>
                                <div style="flex: 1;">
                                    <div style="height: 24px; background: var(--gray-200); border-radius: 12px; overflow: hidden;">
                                        <div style="height: 100%; width: ${Math.min(proportion, 100)}%; background: ${brand.color}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem;">
                                            <span style="color: white; font-size: 0.75rem; font-weight: 600;">${proportion.toFixed(1)}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right; min-width: 100px;">
                                    <div style="font-weight: 700;">$${data.fees.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                    ${data.rate > 0 ? `<div style="font-size: 0.75rem; color: var(--gray-500);">${data.rate.toFixed(2)}% eff. rate</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${totalFees > 0 ? `
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 8px; text-align: center;">
                    <strong>Total Card-Brand Fees:</strong> $${totalFees.toLocaleString('en-US', {minimumFractionDigits: 2})}
                </div>
                ` : ''}
            `;
        }

        function renderDowngradeAnalysis() {
            const content = document.getElementById('downgradeContent');
            const downgrades = currentState.downgrades;

            if (!downgrades || downgrades.length === 0) {
                content.innerHTML = '<div class="alert alert-success"><span class="alert-icon">‚úÖ</span><div>No obvious downgrades detected in fee names. Transactions appear to be qualifying properly.</div></div>';
                return;
            }

            const severityColors = {
                'CRITICAL': '#ef4444',
                'HIGH': '#f59e0b',
                'MEDIUM': '#eab308'
            };

            content.innerHTML = `
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div>
                        <strong>${downgrades.length} potential downgrade(s)</strong> detected totaling
                        <strong>$${currentState.downgradeTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--gray-100);">
                            <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-300);">Fee Name</th>
                            <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--gray-300);">Severity</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid var(--gray-300);">Amount</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid var(--gray-300);">Extra Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${downgrades.map(d => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                                    ${d.feeName}
                                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">${d.note}</div>
                                </td>
                                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--gray-200);">
                                    <span style="background: ${severityColors[d.severity]}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                        ${d.severity}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--gray-200); font-weight: 600;">
                                    $${d.feeAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                                </td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--gray-200); color: var(--danger);">
                                    ${d.extraCost}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin: 0 0 0.5rem 0;">üí° How to Reduce Downgrades</h4>
                    <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: #1e40af;">
                        <li>Settle batches within 24 hours of authorization</li>
                        <li>Always capture AVS (address) and CVV data</li>
                        <li>Use chip/tap readers instead of keyed entry</li>
                        <li>For B2B transactions, submit Level 2/3 data</li>
                        <li>Ensure correct MCC (Merchant Category Code)</li>
                    </ul>
                </div>
            `;
        }

        function renderDebitRoutingAnalysis() {
            const content = document.getElementById('debitRoutingContent');
            const analysis = currentState.debitAnalysis;

            if (!analysis || (analysis.regulated === 0 && analysis.nonRegulated === 0 && analysis.pinDebit === 0 && analysis.signatureDebit === 0)) {
                content.innerHTML = '<div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>No debit routing data detected in statement. Add debit-specific line items for analysis.</div></div>';
                return;
            }

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: var(--gray-500);">Regulated Debit (Durbin)</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$${analysis.regulated.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Capped at 0.05% + $0.22</div>
                    </div>
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: var(--gray-500);">Non-Regulated Debit</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">$${analysis.nonRegulated.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Banks &lt;$10B assets</div>
                    </div>
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: var(--gray-500);">PIN Debit</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$${analysis.pinDebit.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Lower cost routing</div>
                    </div>
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: var(--gray-500);">Signature Debit</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">$${analysis.signatureDebit.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Higher cost routing</div>
                    </div>
                </div>
                ${analysis.potentialSavings > 0 ? `
                <div style="padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px; border: 2px solid var(--success);">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--success-dark);">üí∞ Potential Savings: $${analysis.potentialSavings.toFixed(2)}/month</h4>
                    <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem;">
                        ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
        }

        // ============================================================
        // PROPOSAL GENERATOR
        // ============================================================

        function generateProposal() {
            if (currentState.fees.length === 0) {
                alert('Please analyze a statement first.');
                return;
            }

            const gpiMarkup = parseFloat(document.getElementById('gpiMarkup').value) || 15;
            const gpiAuthFee = parseFloat(document.getElementById('gpiAuthFee').value) || 0.05;
            const gpiMonthlyFeeEl = document.getElementById('gpiMonthlyFeeProposal');
            const gpiMonthlyFee = gpiMonthlyFeeEl ? parseFloat(gpiMonthlyFeeEl.value) || 15 : 15;

            // Calculate GPI costs
            const gpiMarkupCost = currentState.totalVolume * (gpiMarkup / 10000);
            const gpiTxnCost = currentState.totalTransactions * gpiAuthFee;
            const gpiTotal = gpiMarkupCost + gpiTxnCost + gpiMonthlyFee + currentState.passThroughTotal;
            const monthlySavings = currentState.totalFees - gpiTotal;
            const annualSavings = monthlySavings * 12;

            const preview = document.getElementById('proposalPreview');
            preview.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1 style="color: var(--primary); margin-bottom: 0.5rem;">Processing Fee Analysis & Proposal</h1>
                    <p style="color: var(--gray-500);">Prepared for: <strong>${currentState.merchantName || 'Valued Merchant'}</strong></p>
                    <p style="color: var(--gray-500); font-size: 0.9rem;">${new Date().toLocaleDateString()}</p>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Current Processing Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">Monthly Volume</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">$${currentState.totalVolume.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">Current Fees</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">$${currentState.totalFees.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">Effective Rate</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${currentState.effectiveRate.toFixed(2)}%</div>
                        </div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--success); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--success-dark); margin-bottom: 1rem;">üí∞ Controllable Fees Identified</h3>
                    <p style="margin-bottom: 1rem;">These fees are negotiable and represent your savings opportunity:</p>
                    <table style="width: 100%; background: white; border-radius: 8px;">
                        <tbody>
                            ${currentState.fees.filter(f => f.category === 'CONTROLLABLE').map(f => `
                                <tr>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${f.isHiddenFee ? 'üö® ' : ''}${f.name}</td>
                                    <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: right; font-weight: 600;">$${f.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                </tr>
                            `).join('')}
                            <tr style="background: #dcfce7;">
                                <td style="padding: 0.75rem; font-weight: 700;">TOTAL CONTROLLABLE</td>
                                <td style="padding: 0.75rem; text-align: right; font-weight: 700; font-size: 1.2rem; color: var(--success-dark);">$${currentState.controllableTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">üìã Pass-Through Fees (Non-Negotiable)</h3>
                    <p style="color: var(--gray-600); font-size: 0.9rem;">These are network costs that remain the same with any processor:</p>
                    <div style="font-size: 1.3rem; font-weight: 600; margin-top: 0.5rem;">
                        Interchange, Assessments & Network Fees: $${currentState.passThroughTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">üéØ GPI Proposed Pricing</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Markup</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${gpiMarkup} bps</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Auth Fee</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">$${gpiAuthFee.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Monthly Fee</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">$${gpiMonthlyFee.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="font-size: 1.1rem; opacity: 0.9;">
                        Estimated GPI Monthly Cost: <strong>$${gpiTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #065f46 0%, #047857 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
                    <h3 style="margin-bottom: 0.5rem;">üí∞ YOUR PROJECTED SAVINGS</h3>
                    <div style="font-size: 3rem; font-weight: 800; margin: 1rem 0;">$${monthlySavings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    <div style="font-size: 1.1rem; opacity: 0.9;">per month</div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);">
                        Annual Savings: <strong style="font-size: 1.5rem;">$${annualSavings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</strong>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: center; color: var(--gray-500); font-size: 0.85rem;">
                    <p>Generated by GPI Fee Analyzer v6.0</p>
                    <p>This analysis is based on the statement data provided and actual savings may vary.</p>
                </div>
            `;

            document.getElementById('proposalOutput').classList.remove('hidden');
        }

        function printProposal() {
            const content = document.getElementById('proposalPreview').innerHTML;
            const win = window.open('', '_blank');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>GPI Proposal - ${currentState.merchantName || 'Merchant'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        // ============================================================
        // QUICK ENTRY MODE
        // ============================================================

        // Industry benchmark rates for quick analysis
        const QUICK_INDUSTRY_BENCHMARKS = {
            retail: { avgRate: 2.10, goodRate: 1.90, passThruPct: 0.70, name: 'Retail (Card Present)' },
            restaurant: { avgRate: 2.35, goodRate: 2.10, passThruPct: 0.68, name: 'Restaurant' },
            ecommerce: { avgRate: 2.70, goodRate: 2.40, passThruPct: 0.65, name: 'E-Commerce' },
            b2b: { avgRate: 2.00, goodRate: 1.70, passThruPct: 0.75, name: 'B2B / Large Ticket' },
            healthcare: { avgRate: 2.50, goodRate: 2.20, passThruPct: 0.68, name: 'Healthcare' },
            professional: { avgRate: 2.60, goodRate: 2.30, passThruPct: 0.66, name: 'Professional Services' }
        };

        // Auto-calculate effective rate as user types
        document.addEventListener('DOMContentLoaded', function() {
            const quickVolume = document.getElementById('quickVolume');
            const quickFees = document.getElementById('quickFees');

            if (quickVolume && quickFees) {
                [quickVolume, quickFees].forEach(el => {
                    el.addEventListener('input', () => {
                        const vol = parseFloat(quickVolume.value) || 0;
                        const fees = parseFloat(quickFees.value) || 0;
                        if (vol > 0) {
                            document.getElementById('quickEffectiveRate').value = ((fees / vol) * 100).toFixed(2) + '%';
                        }
                    });
                });
            }
        });

        function quickAnalyze() {
            const volume = parseFloat(document.getElementById('quickVolume').value) || 0;
            const transactions = parseFloat(document.getElementById('quickTransactions').value) || 0;
            const fees = parseFloat(document.getElementById('quickFees').value) || 0;
            const industry = document.getElementById('quickIndustry').value;
            const merchantName = document.getElementById('quickMerchantName').value || 'Quick Analysis';

            if (volume <= 0 || fees <= 0) {
                alert('Please enter Volume and Total Fees to continue.');
                return;
            }

            const benchmark = QUICK_INDUSTRY_BENCHMARKS[industry] || QUICK_INDUSTRY_BENCHMARKS['retail'];
            const effectiveRate = (fees / volume) * 100;
            const avgTicket = transactions > 0 ? volume / transactions : 0;
            const costPerTxn = transactions > 0 ? fees / transactions : 0;

            // Estimate pass-through vs controllable based on industry
            const estPassThrough = fees * benchmark.passThruPct;
            const estControllable = fees - estPassThrough;

            // Calculate savings potential (difference between current and good rate)
            const goodRateFees = volume * (benchmark.goodRate / 100);
            const savings = Math.max(0, fees - goodRateFees);

            // Store in state for potential full analysis conversion
            currentState.merchantName = merchantName;
            currentState.totalVolume = volume;
            currentState.totalTransactions = transactions;
            currentState.totalFees = fees;
            currentState.effectiveRate = effectiveRate;
            currentState.controllableTotal = estControllable;
            currentState.passThroughTotal = estPassThrough;
            currentState.quickAnalysisIndustry = industry;

            // Display results
            document.getElementById('quickSavingsAmount').textContent = '$' + savings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('quickSavingsAnnual').textContent = '$' + (savings * 12).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '/year potential';
            document.getElementById('quickCurrentRate').textContent = effectiveRate.toFixed(2) + '%';
            document.getElementById('quickBenchmarkRate').textContent = benchmark.goodRate.toFixed(2) + '%';
            document.getElementById('quickPassThrough').textContent = '$' + estPassThrough.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('quickControllable').textContent = '$' + estControllable.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('quickAvgTicket').textContent = '$' + avgTicket.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('quickCostPerTxn').textContent = '$' + costPerTxn.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            document.getElementById('quickResults').classList.remove('hidden');

            // Also enable comparison tab
            updateComparisonFromQuick(volume, transactions, fees, estPassThrough, estControllable);
        }

        function convertToFullAnalysis() {
            // Transfer quick entry data to full analysis
            document.getElementById('merchantName').value = currentState.merchantName;
            document.getElementById('totalVolume').value = currentState.totalVolume;
            document.getElementById('totalFees').value = currentState.totalFees;
            document.getElementById('totalTransactions').value = currentState.totalTransactions;

            // Switch to input tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="input"]').classList.add('active');
            document.getElementById('tab-input').classList.add('active');

            alert('Data transferred! Now paste the detailed fee breakdown from the statement for precise analysis.');
        }

        // ============================================================
        // SIDE-BY-SIDE COMPARISON
        // ============================================================

        function updateComparisonFromQuick(volume, transactions, fees, passThru, controllable) {
            // Store comparison data
            currentState.compareReady = true;
            currentState.compareVolume = volume;
            currentState.compareTransactions = transactions;
            currentState.compareCurrentFees = fees;
            currentState.comparePassThrough = passThru;
            currentState.compareControllable = controllable;

            // Show comparison content
            document.getElementById('compareNotReady').classList.add('hidden');
            document.getElementById('compareContent').classList.remove('hidden');

            updateComparison();
        }

        // Track excluded one-time fees (for comparison)
        let excludedOtherFees = new Set();

        function updateComparison() {
            console.log('updateComparison called. State:', {
                compareReady: currentState.compareReady,
                totalVolume: currentState.totalVolume,
                totalFees: currentState.totalFees,
                passThroughTotal: currentState.passThroughTotal,
                controllableTotal: currentState.controllableTotal
            });

            // Check if we have data to display
            if (!currentState.compareReady && currentState.totalVolume <= 0) {
                console.log('Comparison not ready - no data');
                return;
            }

            // Get values (prefer compare-specific, fall back to main state)
            const volume = currentState.compareVolume || currentState.totalVolume || 0;
            const transactions = currentState.compareTransactions || currentState.totalTransactions || 0;
            const passThrough = currentState.comparePassThrough || currentState.passThroughTotal || 0;
            const controllable = currentState.compareControllable || currentState.controllableTotal || 0;

            console.log('Comparison values:', { volume, transactions, passThrough, controllable });

            // Get GPI pricing inputs
            const gpiMarkupBps = parseFloat(document.getElementById('gpiMarkupBps').value) || 10;
            const gpiPerTxn = parseFloat(document.getElementById('gpiPerTxn').value) || 0.10;
            const gpiMonthlyFee = parseFloat(document.getElementById('gpiMonthlyFee').value) || 0;

            // Use ACTUAL fee bucket values if available, otherwise estimate
            const buckets = currentState.feeBuckets || {};
            const hasBucketData = buckets.discRate > 0 || buckets.perTrans > 0 || buckets.perAuth > 0 ||
                                  buckets.batchFee > 0 || buckets.monthlyFee > 0 || buckets.otherFee > 0;

            let discountFeeCurrent, perItemFeeCurrent, monthlyFeeCurrent, otherFeeCurrent;

            if (hasBucketData) {
                // Use actual extracted bucket values
                discountFeeCurrent = buckets.discRate || 0;
                perItemFeeCurrent = (buckets.perTrans || 0) + (buckets.perAuth || 0) + (buckets.batchFee || 0);
                monthlyFeeCurrent = buckets.monthlyFee || 0;
                otherFeeCurrent = buckets.otherFee || 0;
                console.log('Using ACTUAL fee buckets:', { discountFeeCurrent, perItemFeeCurrent, monthlyFeeCurrent, otherFeeCurrent });
            } else {
                // Fallback: estimate from controllable total
                discountFeeCurrent = controllable * 0.55;
                perItemFeeCurrent = controllable * 0.25;
                monthlyFeeCurrent = controllable * 0.12;
                otherFeeCurrent = controllable * 0.08;
                console.log('Using ESTIMATED fee breakdown (no bucket data)');
            }

            // GPI fees calculation
            const gpiMarkupFees = volume * (gpiMarkupBps / 10000);
            const gpiTxnFees = transactions * gpiPerTxn;

            // Calculate totals for each section
            const sections = {
                discFee: { current: discountFeeCurrent, gpi: gpiMarkupFees },
                perItem: { current: perItemFeeCurrent, gpi: gpiTxnFees },
                monthly: { current: monthlyFeeCurrent, gpi: gpiMonthlyFee },
                other: { current: calculateActiveOtherFees(otherFeeCurrent), gpi: 0 },
                passThru: { current: passThrough, gpi: passThrough }
            };

            // Calculate totals (excluding struck-through items)
            const currentFees = sections.discFee.current + sections.perItem.current +
                               sections.monthly.current + sections.other.current + sections.passThru.current;
            const gpiTotal = sections.discFee.gpi + sections.perItem.gpi +
                            sections.monthly.gpi + sections.other.gpi + sections.passThru.gpi;
            const savings = currentFees - gpiTotal;
            const annualSavings = savings * 12;

            // Rates
            const currentRate = volume > 0 ? (currentFees / volume) * 100 : 0;
            const gpiRate = volume > 0 ? (gpiTotal / volume) * 100 : 0;

            // Update summary cards
            // Helper function for safe element updates
            const setEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
                else console.warn('Element not found:', id);
            };
            const setElStyle = (id, prop, value) => {
                const el = document.getElementById(id);
                if (el) el.style[prop] = value;
            };

            // Update summary cards
            setEl('compareCurrentTotal', '$' + currentFees.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            setEl('compareCurrentRate', currentRate.toFixed(2) + '% effective');
            setEl('compareGpiTotal', '$' + gpiTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            setEl('compareGpiRate', gpiRate.toFixed(2) + '% effective');
            setEl('compareSavingsTotal', '$' + savings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}));
            setEl('compareSavingsAnnual', '$' + annualSavings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '/year');

            // Update each section
            updateSectionRow('discFee', sections.discFee);
            updateSectionRow('perItem', sections.perItem);
            updateSectionRow('monthly', sections.monthly);
            updateSectionRow('other', sections.other);
            setEl('passThruCurrent', '$' + sections.passThru.current.toFixed(2));
            setEl('passThruGpi', '$' + sections.passThru.gpi.toFixed(2));

            // Update totals row
            setEl('compareTotalCurrent', '$' + currentFees.toFixed(2));
            setEl('compareTotalGpi', '$' + gpiTotal.toFixed(2));
            setEl('compareTotalSavings', '-$' + savings.toFixed(2));

            // Update visual bars
            const maxFees = Math.max(currentFees, gpiTotal, 1); // Avoid division by zero
            setElStyle('compareBarCurrent', 'width', ((currentFees / maxFees) * 100) + '%');
            setElStyle('compareBarGpi', 'width', ((gpiTotal / maxFees) * 100) + '%');
            setEl('compareBarCurrentLabel', '$' + currentFees.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}));
            setEl('compareBarGpiLabel', '$' + gpiTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}));

            console.log('Comparison updated successfully:', { currentFees, gpiTotal, savings });

            // Populate detail lists
            populateOtherFeesDetail(otherFeeCurrent);
            populatePassThruDetail(passThrough);

            // Store for PDF export
            currentState.compareData = { sections, currentFees, gpiTotal, savings, annualSavings, currentRate, gpiRate };
        }

        function updateSectionRow(prefix, data) {
            const savingsVal = data.current - data.gpi;
            const currentEl = document.getElementById(prefix + 'Current');
            const gpiEl = document.getElementById(prefix + 'Gpi');
            const savingsEl = document.getElementById(prefix + 'Savings');

            if (currentEl) currentEl.textContent = '$' + data.current.toFixed(2);
            if (gpiEl) gpiEl.textContent = '$' + data.gpi.toFixed(2);
            if (savingsEl) {
                savingsEl.textContent = savingsVal >= 0 ? '-$' + savingsVal.toFixed(2) : '+$' + Math.abs(savingsVal).toFixed(2);
                savingsEl.style.color = savingsVal >= 0 ? '#16a34a' : '#dc2626';
            }
        }

        function calculateActiveOtherFees(totalOther) {
            // Reduce by excluded fees (simulated as percentages for now)
            const excludedPercentage = excludedOtherFees.size * 0.15; // Each excluded item reduces by ~15%
            return totalOther * (1 - Math.min(excludedPercentage, 0.9));
        }

        function populateOtherFeesDetail(totalOther) {
            const container = document.getElementById('otherFeesItemList');
            if (!container) return;

            // Sample other fee items (would come from actual analysis)
            const otherFeeItems = [
                { id: 'chargeback', name: 'Chargeback Fees', amount: totalOther * 0.25, isOneTime: false },
                { id: 'retrieval', name: 'Retrieval Fees', amount: totalOther * 0.15, isOneTime: false },
                { id: 'pci_noncompliance', name: 'PCI Non-Compliance', amount: totalOther * 0.20, isOneTime: false },
                { id: 'terminal_purchase', name: 'Terminal Purchase (One-Time)', amount: totalOther * 0.30, isOneTime: true },
                { id: 'setup_fee', name: 'Setup/Activation Fee (One-Time)', amount: totalOther * 0.10, isOneTime: true }
            ];

            container.innerHTML = otherFeeItems.map(item => {
                const isExcluded = excludedOtherFees.has(item.id);
                const style = isExcluded ? 'text-decoration: line-through; opacity: 0.5;' : '';
                const btnText = isExcluded ? '‚Ü©Ô∏è' : '‚ùå';
                const btnTitle = isExcluded ? 'Restore this fee' : 'Exclude from comparison';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0; border-bottom: 1px dashed #fed7aa; ${style}">
                        <span>${item.isOneTime ? 'üî∏ ' : ''}${item.name}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>$${item.amount.toFixed(2)}</span>
                            ${item.isOneTime ? `<button onclick="toggleExcludeFee('${item.id}')" title="${btnTitle}" style="background: none; border: none; cursor: pointer; font-size: 0.9rem;">${btnText}</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populatePassThruDetail(totalPassThru) {
            const container = document.getElementById('passThruItemList');
            if (!container) return;

            // Break down pass-through fees (typical distribution)
            const passThruItems = [
                { name: 'Visa Interchange', amount: totalPassThru * 0.42 },
                { name: 'Mastercard Interchange', amount: totalPassThru * 0.28 },
                { name: 'Amex Interchange', amount: totalPassThru * 0.12 },
                { name: 'Discover Interchange', amount: totalPassThru * 0.03 },
                { name: 'Visa Assessment', amount: totalPassThru * 0.06 },
                { name: 'MC Assessment', amount: totalPassThru * 0.04 },
                { name: 'Dues & Network Fees', amount: totalPassThru * 0.05 }
            ];

            container.innerHTML = passThruItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px dashed #c7d2fe;">
                    <span>${item.name}</span>
                    <span>$${item.amount.toFixed(2)}</span>
                </div>
            `).join('') + `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: 600; border-top: 2px solid #818cf8; margin-top: 0.25rem;">
                    <span>Total Pass-Through</span>
                    <span>$${totalPassThru.toFixed(2)}</span>
                </div>
            `;
        }

        function toggleOtherFeesDetail() {
            const detail = document.getElementById('otherFeesDetail');
            if (detail) {
                detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
            }
        }

        function togglePassThruDetail() {
            const detail = document.getElementById('passThruDetail');
            if (detail) {
                detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleExcludeFee(feeId) {
            if (excludedOtherFees.has(feeId)) {
                excludedOtherFees.delete(feeId);
            } else {
                excludedOtherFees.add(feeId);
            }
            updateComparison(); // Recalculate totals
        }

        function generateComparisonPDF() {
            // Get comparison data
            const data = currentState.compareData;
            if (!data) {
                alert('Please run a comparison first.');
                return;
            }

            const merchantName = currentState.merchantName || 'Merchant';
            const volume = currentState.compareVolume || currentState.totalVolume;

            // Build clean PDF content (NO pass-thru detail - just totals)
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head>
                    <title>Fee Comparison - ${merchantName}</title>
                    <style>
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; background: white; color: #1e293b; }
                        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #059669; }
                        .header h1 { color: #065f46; font-size: 28px; margin-bottom: 5px; }
                        .header p { color: #64748b; font-size: 14px; }
                        .logo { font-size: 32px; font-weight: bold; color: #065f46; margin-bottom: 10px; }
                        .summary-grid { display: flex; justify-content: space-between; margin-bottom: 30px; gap: 20px; }
                        .summary-box { flex: 1; padding: 20px; border-radius: 12px; text-align: center; }
                        .summary-box.current { background: #fef2f2; border: 2px solid #fecaca; }
                        .summary-box.gpi { background: #f0fdf4; border: 2px solid #bbf7d0; }
                        .summary-box.savings { background: #faf5ff; border: 2px solid #e9d5ff; }
                        .summary-box .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
                        .summary-box .value { font-size: 32px; font-weight: 700; margin: 5px 0; }
                        .summary-box.current .value { color: #dc2626; }
                        .summary-box.gpi .value { color: #16a34a; }
                        .summary-box.savings .value { color: #7c3aed; }
                        .summary-box .subtext { font-size: 12px; color: #64748b; }
                        .comparison-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .comparison-table th { background: #f1f5f9; padding: 12px 16px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #cbd5e1; }
                        .comparison-table th:not(:first-child) { text-align: right; }
                        .comparison-table td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; }
                        .comparison-table td:not(:first-child) { text-align: right; font-weight: 500; }
                        .comparison-table tr.section-row { background: #f8fafc; }
                        .comparison-table tr.section-row td:first-child { font-weight: 600; }
                        .comparison-table tr.total-row { background: #1e293b; color: white; }
                        .comparison-table tr.total-row td { font-weight: 700; font-size: 16px; padding: 16px; }
                        .savings-highlight { color: #16a34a; font-weight: 600; }
                        .visual-bar { margin: 30px 0; }
                        .bar-row { display: flex; align-items: center; margin-bottom: 12px; }
                        .bar-label { width: 100px; font-size: 14px; font-weight: 500; }
                        .bar-container { flex: 1; background: #e2e8f0; height: 30px; border-radius: 6px; overflow: hidden; margin: 0 15px; }
                        .bar-fill { height: 100%; border-radius: 6px; }
                        .bar-fill.current { background: linear-gradient(90deg, #dc2626, #ef4444); }
                        .bar-fill.gpi { background: linear-gradient(90deg, #16a34a, #22c55e); }
                        .bar-value { width: 100px; text-align: right; font-weight: 700; font-size: 16px; }
                        .bar-value.current { color: #dc2626; }
                        .bar-value.gpi { color: #16a34a; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b; font-size: 11px; }
                        .annual-savings { text-align: center; background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; padding: 20px; border-radius: 12px; margin: 25px 0; }
                        .annual-savings .big { font-size: 36px; font-weight: 700; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">GPI</div>
                        <h1>Processing Fee Comparison</h1>
                        <p>Prepared for: <strong>${merchantName}</strong> | ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-box current">
                            <div class="label">Current Processor</div>
                            <div class="value">$${data.currentFees.toFixed(2)}</div>
                            <div class="subtext">${data.currentRate.toFixed(2)}% effective rate</div>
                        </div>
                        <div class="summary-box gpi">
                            <div class="label">GPI Proposed</div>
                            <div class="value">$${data.gpiTotal.toFixed(2)}</div>
                            <div class="subtext">${data.gpiRate.toFixed(2)}% effective rate</div>
                        </div>
                        <div class="summary-box savings">
                            <div class="label">Monthly Savings</div>
                            <div class="value">$${data.savings.toFixed(0)}</div>
                            <div class="subtext">Every month!</div>
                        </div>
                    </div>

                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Fee Category</th>
                                <th>Current</th>
                                <th>GPI</th>
                                <th>Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="section-row">
                                <td>üí∞ Discount Fees (% Based)</td>
                                <td>$${data.sections.discFee.current.toFixed(2)}</td>
                                <td>$${data.sections.discFee.gpi.toFixed(2)}</td>
                                <td class="savings-highlight">$${(data.sections.discFee.current - data.sections.discFee.gpi).toFixed(2)}</td>
                            </tr>
                            <tr class="section-row">
                                <td>üî¢ Per Item Fees</td>
                                <td>$${data.sections.perItem.current.toFixed(2)}</td>
                                <td>$${data.sections.perItem.gpi.toFixed(2)}</td>
                                <td class="savings-highlight">$${(data.sections.perItem.current - data.sections.perItem.gpi).toFixed(2)}</td>
                            </tr>
                            <tr class="section-row">
                                <td>üìÖ Monthly Fees</td>
                                <td>$${data.sections.monthly.current.toFixed(2)}</td>
                                <td>$${data.sections.monthly.gpi.toFixed(2)}</td>
                                <td class="savings-highlight">$${(data.sections.monthly.current - data.sections.monthly.gpi).toFixed(2)}</td>
                            </tr>
                            <tr class="section-row">
                                <td>‚ö†Ô∏è Other Fees</td>
                                <td>$${data.sections.other.current.toFixed(2)}</td>
                                <td>$${data.sections.other.gpi.toFixed(2)}</td>
                                <td class="savings-highlight">$${(data.sections.other.current - data.sections.other.gpi).toFixed(2)}</td>
                            </tr>
                            <tr class="section-row">
                                <td>üîí Pass Thru (Interchange + Assessments)</td>
                                <td>$${data.sections.passThru.current.toFixed(2)}</td>
                                <td>$${data.sections.passThru.gpi.toFixed(2)}</td>
                                <td style="color: #64748b;">‚Äî</td>
                            </tr>
                            <tr class="total-row">
                                <td>TOTAL MONTHLY</td>
                                <td>$${data.currentFees.toFixed(2)}</td>
                                <td style="color: #4ade80;">$${data.gpiTotal.toFixed(2)}</td>
                                <td style="color: #c4b5fd;">-$${data.savings.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="visual-bar">
                        <div class="bar-row">
                            <span class="bar-label">Current</span>
                            <div class="bar-container">
                                <div class="bar-fill current" style="width: 100%;"></div>
                            </div>
                            <span class="bar-value current">$${data.currentFees.toFixed(0)}</span>
                        </div>
                        <div class="bar-row">
                            <span class="bar-label">GPI</span>
                            <div class="bar-container">
                                <div class="bar-fill gpi" style="width: ${(data.gpiTotal / data.currentFees * 100).toFixed(0)}%;"></div>
                            </div>
                            <span class="bar-value gpi">$${data.gpiTotal.toFixed(0)}</span>
                        </div>
                    </div>

                    <div class="annual-savings">
                        <div style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">Your Annual Savings</div>
                        <div class="big">$${data.annualSavings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        <div style="font-size: 14px; margin-top: 5px;">That's money back in your pocket every year!</div>
                    </div>

                    <div class="footer">
                        <p>This comparison is based on your current processing statement. Actual savings may vary based on card mix and transaction patterns.</p>
                        <p style="margin-top: 8px;"><strong>Global Payments Integrated</strong> | Prepared by GPI Fee Comparison Tool</p>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        // Update comparison when main analysis completes
        function enableComparisonFromAnalysis() {
            console.log('enableComparisonFromAnalysis called. Checking:', {
                totalVolume: currentState.totalVolume,
                totalFees: currentState.totalFees,
                passThroughTotal: currentState.passThroughTotal,
                controllableTotal: currentState.controllableTotal
            });

            if (currentState.totalVolume > 0 && currentState.totalFees > 0) {
                currentState.compareReady = true;
                currentState.compareVolume = currentState.totalVolume;
                currentState.compareTransactions = currentState.totalTransactions || 1; // Default to 1 if not set
                currentState.compareCurrentFees = currentState.totalFees;
                currentState.comparePassThrough = currentState.passThroughTotal || currentState.totalFees * 0.7; // Estimate if not set
                currentState.compareControllable = currentState.controllableTotal || currentState.totalFees * 0.3; // Estimate if not set

                console.log('Comparison enabled with:', {
                    compareVolume: currentState.compareVolume,
                    compareTransactions: currentState.compareTransactions,
                    compareCurrentFees: currentState.compareCurrentFees,
                    comparePassThrough: currentState.comparePassThrough,
                    compareControllable: currentState.compareControllable
                });

                const notReady = document.getElementById('compareNotReady');
                const content = document.getElementById('compareContent');

                if (notReady) notReady.classList.add('hidden');
                if (content) content.classList.remove('hidden');

                updateComparison();
            } else {
                console.log('Comparison NOT enabled - missing volume or fees');
            }
        }

        // ============================================================
        // FEE ANOMALY DETECTION SYSTEM
        // ============================================================

        const FEE_BENCHMARKS = {
            monthlyServiceFee: { low: 0, mid: 25, high: 50, critical: 75 },
            pciCompliance: { low: 0, mid: 10, high: 30, critical: 50 },
            authorizationFee: { low: 0.05, mid: 0.10, high: 0.15, critical: 0.25 },
            batchFee: { low: 0.15, mid: 0.25, high: 0.30, critical: 0.50 },
            chargebackFee: { low: 15, mid: 20, high: 25, critical: 50 },
            statementFee: { low: 0, mid: 5, high: 15, critical: 25 },
            gatewayFee: { low: 0, mid: 10, high: 25, critical: 50 },
            effectiveRate: {
                retail: { good: 2.00, avg: 2.30, high: 2.75, critical: 3.50 },
                restaurant: { good: 2.20, avg: 2.50, high: 3.00, critical: 3.75 },
                ecommerce: { good: 2.50, avg: 2.80, high: 3.25, critical: 4.00 },
                b2b: { good: 1.80, avg: 2.10, high: 2.50, critical: 3.00 },
                healthcare: { good: 2.30, avg: 2.60, high: 3.00, critical: 3.50 }
            }
        };

        function detectAnomalies() {
            if (!currentState.fees || currentState.fees.length === 0) {
                currentState.anomalies = [];
                return;
            }

            const anomalies = [];
            const industry = currentState.quickAnalysisIndustry || 'retail';

            currentState.fees.forEach(fee => {
                const name = (fee.name || '').toUpperCase();
                const amount = fee.amount || 0;

                // Skip pass-through fees
                if (fee.category === 'PASS_THROUGH') return;

                // Monthly Service Fee Check
                if (name.match(/MONTHLY|SERVICE\s*(FEE|CHARGE)|ACCOUNT\s*FEE/i)) {
                    if (amount > FEE_BENCHMARKS.monthlyServiceFee.critical) {
                        anomalies.push({
                            name: fee.name, type: 'Monthly Fee', amount,
                            severity: 'critical', expected: `$0-$${FEE_BENCHMARKS.monthlyServiceFee.high}`,
                            message: `Monthly fee of $${amount} is 50%+ above market rate`,
                            savings: (amount - FEE_BENCHMARKS.monthlyServiceFee.mid) * 12,
                            action: 'Negotiate to $20-30/month or request waiver'
                        });
                    } else if (amount > FEE_BENCHMARKS.monthlyServiceFee.high) {
                        anomalies.push({
                            name: fee.name, type: 'Monthly Fee', amount,
                            severity: 'warning', expected: `$0-$${FEE_BENCHMARKS.monthlyServiceFee.high}`,
                            message: `Monthly fee exceeds recommended range`,
                            savings: (amount - FEE_BENCHMARKS.monthlyServiceFee.mid) * 12,
                            action: 'Request fee reduction'
                        });
                    }
                }

                // PCI Compliance Fee Check
                if (name.match(/PCI|COMPLIANCE/i) && !name.match(/NON[\s\-]*COMPLIANCE/i)) {
                    if (amount > FEE_BENCHMARKS.pciCompliance.critical) {
                        anomalies.push({
                            name: fee.name, type: 'PCI Fee', amount,
                            severity: 'critical', expected: `$0-$${FEE_BENCHMARKS.pciCompliance.high}`,
                            message: `PCI fee of $${amount}/mo is excessive - market is $5-15`,
                            savings: (amount - 10) * 12,
                            action: 'Negotiate down or find processor that includes PCI'
                        });
                    } else if (amount > FEE_BENCHMARKS.pciCompliance.high) {
                        anomalies.push({
                            name: fee.name, type: 'PCI Fee', amount,
                            severity: 'warning', expected: `$5-$${FEE_BENCHMARKS.pciCompliance.high}`,
                            message: `PCI fee above market average`,
                            savings: (amount - 10) * 12,
                            action: 'Request fee reduction'
                        });
                    }
                }

                // Chargeback Fee Check
                if (name.match(/CHARGEBACK|DISPUTE|RETRIEVAL/i)) {
                    if (amount > FEE_BENCHMARKS.chargebackFee.critical) {
                        anomalies.push({
                            name: fee.name, type: 'Chargeback Fee', amount,
                            severity: 'critical', expected: `$15-$${FEE_BENCHMARKS.chargebackFee.high}`,
                            message: `Chargeback fee of $${amount} is far above market ($15-25)`,
                            savings: (amount - 20) * 12, // Estimate 12/year
                            action: 'Fiserv charges $35 - negotiate to $15-20'
                        });
                    } else if (amount > FEE_BENCHMARKS.chargebackFee.high) {
                        anomalies.push({
                            name: fee.name, type: 'Chargeback Fee', amount,
                            severity: 'warning', expected: `$15-$${FEE_BENCHMARKS.chargebackFee.high}`,
                            message: `Chargeback fee above typical range`,
                            savings: (amount - 20) * 6,
                            action: 'Request fee reduction'
                        });
                    }
                }

                // Statement Fee Check
                if (name.match(/STATEMENT|PAPER|MONTHLY\s*STATEMENT/i)) {
                    if (amount > FEE_BENCHMARKS.statementFee.critical) {
                        anomalies.push({
                            name: fee.name, type: 'Statement Fee', amount,
                            severity: 'critical', expected: `$0-$${FEE_BENCHMARKS.statementFee.high}`,
                            message: `Statement fee of $${amount} should be free or minimal`,
                            savings: amount * 12,
                            action: 'Switch to electronic statements (usually free)'
                        });
                    } else if (amount > FEE_BENCHMARKS.statementFee.high) {
                        anomalies.push({
                            name: fee.name, type: 'Statement Fee', amount,
                            severity: 'warning', expected: `$0-$10`,
                            message: `Statement fee above market average`,
                            savings: (amount - 5) * 12,
                            action: 'Request waiver or switch to e-statements'
                        });
                    }
                }
            });

            // Effective Rate Analysis
            if (currentState.effectiveRate > 0) {
                const rateThresholds = FEE_BENCHMARKS.effectiveRate[industry] || FEE_BENCHMARKS.effectiveRate.retail;
                if (currentState.effectiveRate > rateThresholds.critical) {
                    anomalies.push({
                        name: 'Overall Effective Rate', type: 'Effective Rate',
                        amount: currentState.effectiveRate,
                        severity: 'critical', expected: `${rateThresholds.good}%-${rateThresholds.avg}%`,
                        message: `${currentState.effectiveRate.toFixed(2)}% effective rate is far above ${industry} benchmark`,
                        savings: ((currentState.effectiveRate - rateThresholds.good) / 100) * currentState.totalVolume * 12,
                        action: 'Major repricing needed - switch to IC+ pricing'
                    });
                } else if (currentState.effectiveRate > rateThresholds.high) {
                    anomalies.push({
                        name: 'Overall Effective Rate', type: 'Effective Rate',
                        amount: currentState.effectiveRate,
                        severity: 'warning', expected: `${rateThresholds.good}%-${rateThresholds.avg}%`,
                        message: `${currentState.effectiveRate.toFixed(2)}% is above optimal for ${industry}`,
                        savings: ((currentState.effectiveRate - rateThresholds.avg) / 100) * currentState.totalVolume * 12,
                        action: 'Review pricing model and negotiate markup'
                    });
                }
            }

            // Sort by severity and savings
            anomalies.sort((a, b) => {
                if (a.severity === 'critical' && b.severity !== 'critical') return -1;
                if (b.severity === 'critical' && a.severity !== 'critical') return 1;
                return (b.savings || 0) - (a.savings || 0);
            });

            currentState.anomalies = anomalies;
            renderAnomalies();
        }

        function renderAnomalies() {
            const container = document.getElementById('anomalyContent');
            if (!container) return;

            const anomalies = currentState.anomalies || [];
            if (anomalies.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <div style="font-size: 3rem;">‚úÖ</div>
                        <h4>No Fee Anomalies Detected</h4>
                        <p style="color: var(--gray-500);">All fees are within expected ranges for this industry.</p>
                    </div>
                `;
                return;
            }

            const totalSavings = anomalies.reduce((sum, a) => sum + (a.savings || 0), 0);
            const criticalCount = anomalies.filter(a => a.severity === 'critical').length;
            const warningCount = anomalies.filter(a => a.severity === 'warning').length;

            container.innerHTML = `
                <div style="background: ${criticalCount > 0 ? 'linear-gradient(135deg, #dc2626, #ef4444)' : 'linear-gradient(135deg, #f59e0b, #fbbf24)'}; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h4 style="margin: 0;">üö® ${anomalies.length} Fee Anomalies Detected</h4>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">${criticalCount} critical, ${warningCount} warnings</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; opacity: 0.9;">Potential Annual Savings</div>
                            <div style="font-size: 1.75rem; font-weight: 700;">$${totalSavings.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                </div>

                ${anomalies.map(a => `
                    <div style="background: white; border-left: 4px solid ${a.severity === 'critical' ? 'var(--danger)' : 'var(--warning)'}; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0 8px 8px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="background: ${a.severity === 'critical' ? 'var(--danger)' : 'var(--warning)'}; color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase;">${a.severity}</span>
                                <strong style="margin-left: 0.5rem;">${a.name}</strong>
                            </div>
                            <div style="text-align: right; color: var(--success); font-weight: 600;">
                                Save ~$${(a.savings || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}/yr
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0; color: var(--gray-700); font-size: 0.9rem;">${a.message}</p>
                        <p style="margin: 0; font-size: 0.85rem;"><strong>Expected:</strong> ${a.expected} | <strong>Action:</strong> ${a.action}</p>
                    </div>
                `).join('')}
            `;
        }

        // ============================================================
        // EXPORT / IMPORT / SHARE
        // ============================================================

        function exportAnalysis() {
            const exportData = {
                version: '6.0',
                timestamp: new Date().toISOString(),
                merchantName: currentState.merchantName,
                processor: currentState.processor,
                totalVolume: currentState.totalVolume,
                totalFees: currentState.totalFees,
                totalTransactions: currentState.totalTransactions,
                fees: currentState.fees,
                pricingModel: currentState.pricingModel
            };

            const encoded = btoa(JSON.stringify(exportData));
            document.getElementById('exportCode').textContent = encoded;
            document.getElementById('exportCode').classList.remove('hidden');
            document.getElementById('copyExportBtn').classList.remove('hidden');
        }

        function copyExportCode() {
            const code = document.getElementById('exportCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Share code copied to clipboard!');
            });
        }

        function importAnalysis() {
            const code = document.getElementById('importCode').value.trim();
            if (!code) {
                alert('Please paste a share code.');
                return;
            }

            try {
                const data = JSON.parse(atob(code));

                currentState.merchantName = data.merchantName || '';
                currentState.processor = data.processor;
                currentState.totalVolume = data.totalVolume || 0;
                currentState.totalFees = data.totalFees || 0;
                currentState.totalTransactions = data.totalTransactions || 0;
                currentState.fees = data.fees || [];
                currentState.pricingModel = data.pricingModel;

                // Populate form
                document.getElementById('merchantName').value = currentState.merchantName;
                document.getElementById('totalVolume').value = currentState.totalVolume;
                document.getElementById('totalFees').value = currentState.totalFees;
                document.getElementById('totalTransactions').value = currentState.totalTransactions;

                // Recalculate and display
                calculateTotals();
                updateSavingsDisplay();
                updateQuickStats();
                renderFeeTable();
                detectHiddenFees();
                generateCallScript();
                generateBenchmarks();

                alert('Analysis imported successfully!');
                document.querySelector('[data-tab="analysis"]').click();

            } catch (e) {
                alert('Invalid share code. Please check and try again.');
            }
        }

        function exportPDF() {
            // Create comprehensive PDF report
            const passThroughTotal = currentState.fees
                .filter(f => f.category === 'PASS_THROUGH')
                .reduce((sum, f) => sum + f.amount, 0);

            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Fee Analysis - ${currentState.merchantName || 'Merchant'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
                        .header { background: linear-gradient(135deg, #1a5f7a 0%, #2d8bba 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; }
                        .section { margin: 20px 0; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; }
                        .controllable-section { background: #f0fdf4; border: 2px solid #22c55e; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
                        .total { font-weight: bold; font-size: 1.2rem; }
                        .green { color: #166534; }
                        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Fee Analysis Report</h1>
                        <p>${currentState.merchantName || 'Merchant'} | ${new Date().toLocaleDateString()}</p>
                    </div>

                    <div class="section controllable-section">
                        <h2 style="color: #166534;">üí∞ CONTROLLABLE FEES - Your Savings Opportunity</h2>
                        <table>
                            ${currentState.fees.filter(f => f.category === 'CONTROLLABLE').map(f => `
                                <tr>
                                    <td>${f.isHiddenFee ? 'üö® ' : ''}${f.name}</td>
                                    <td style="text-align: right; font-weight: bold;">$${f.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                </tr>
                            `).join('')}
                            <tr class="total">
                                <td>TOTAL CONTROLLABLE</td>
                                <td style="text-align: right;" class="green">$${currentState.controllableTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="section">
                        <h2>üìã Pass-Through Fees (Non-Negotiable)</h2>
                        <p><strong>Interchange, Assessments & Network Fees:</strong> $${passThroughTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                        <p style="font-size: 0.9rem; color: #666;">These are the same regardless of processor.</p>
                    </div>

                    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 0.9rem;">
                        <p>Generated by GPI Fee Analyzer v6.0 | ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            win.document.write(reportHTML);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function exportCSV() {
            let csv = 'GPI Fee Analysis Report\n';
            csv += `Merchant,${currentState.merchantName}\n`;
            csv += `Date,${new Date().toLocaleDateString()}\n`;
            csv += `Total Volume,$${currentState.totalVolume}\n`;
            csv += `Total Fees,$${currentState.totalFees}\n`;
            csv += `Effective Rate,${currentState.effectiveRate.toFixed(2)}%\n\n`;

            csv += 'CONTROLLABLE FEES\n';
            csv += 'Fee Name,Amount\n';
            currentState.fees.filter(f => f.category === 'CONTROLLABLE').forEach(f => {
                csv += `"${f.name}",$${f.amount.toFixed(2)}\n`;
            });
            csv += `TOTAL CONTROLLABLE,$${currentState.controllableTotal.toFixed(2)}\n\n`;

            csv += 'PASS-THROUGH FEES\n';
            csv += 'Fee Name,Amount\n';
            currentState.fees.filter(f => f.category === 'PASS_THROUGH').forEach(f => {
                csv += `"${f.name}",$${f.amount.toFixed(2)}\n`;
            });
            csv += `TOTAL PASS-THROUGH,$${currentState.passThroughTotal.toFixed(2)}\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fee_analysis_${(currentState.merchantName || 'merchant').replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================================
        // LOCAL HISTORY
        // ============================================================

        function saveToHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('gpi_analysis_history') || '[]');

                history.unshift({
                    merchantName: currentState.merchantName,
                    date: new Date().toISOString(),
                    totalVolume: currentState.totalVolume,
                    controllableTotal: currentState.controllableTotal,
                    data: btoa(JSON.stringify(currentState))
                });

                // Keep only last 20
                if (history.length > 20) history.pop();

                localStorage.setItem('gpi_analysis_history', JSON.stringify(history));
                loadHistory();
            } catch (e) {
                console.log('Could not save to history:', e);
            }
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('gpi_analysis_history') || '[]');
                const container = document.getElementById('historyList');

                if (history.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"><span class="alert-icon">üí°</span><div>Analyses you complete will appear here for quick access.</div></div>';
                    return;
                }

                container.innerHTML = history.map((item, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${item.merchantName || 'Unnamed'}</strong>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">
                                ${new Date(item.date).toLocaleDateString()} |
                                Vol: $${(item.totalVolume || 0).toLocaleString()} |
                                Savings: $${(item.controllableTotal || 0).toLocaleString()}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="loadFromHistory(${i})">Load</button>
                    </div>
                `).join('');
            } catch (e) {
                console.log('Could not load history:', e);
            }
        }

        function loadFromHistory(index) {
            try {
                const history = JSON.parse(localStorage.getItem('gpi_analysis_history') || '[]');
                if (history[index]) {
                    const data = JSON.parse(atob(history[index].data));
                    Object.assign(currentState, data);

                    document.getElementById('merchantName').value = currentState.merchantName;
                    document.getElementById('totalVolume').value = currentState.totalVolume;
                    document.getElementById('totalFees').value = currentState.totalFees;
                    document.getElementById('totalTransactions').value = currentState.totalTransactions;

                    calculateTotals();
                    updateSavingsDisplay();
                    updateQuickStats();
                    renderFeeTable();
                    detectHiddenFees();
                    generateCallScript();
                    generateBenchmarks();

                    document.querySelector('[data-tab="analysis"]').click();
                }
            } catch (e) {
                alert('Could not load analysis.');
            }
        }

        // Clear data on page unload for privacy
        window.addEventListener('beforeunload', () => {
            clearState();
        });
    </script>
</body>
</html>
